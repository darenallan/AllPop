<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon Tableau de Bord - Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="assets/css/styles.css" />
  
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
  
  <!-- Configuration & Utilities -->
  <script src="assets/js/config.js"></script>
  <!-- Data Store -->
  <script src="assets/js/data.js" defer></script>
  <!-- App Module -->
  <script src="assets/js/app.js" defer></script>
</head>

<body>
  <header id="app-header" class="header">
      <div class="container navbar">
          <a href="index.html" class="brand">
              <div class="brand-logo-img" style="width:44px; height:44px; border-radius:12px; background:var(--gold); display:flex; align-items:center; justify-content:center; color:black; font-weight:800;">A</div>
              <div style="display:flex; flex-direction:column; margin-left:10px;">
                  <span class="brand-name" style="font-size:22px; font-weight:800; letter-spacing:0.5px;">AURUM</span>
                  <span class="tagline" style="font-size:11px; letter-spacing:1px; color:#666;">EXCELLENCE √Ä VOTRE PORT√âE</span>
              </div>
          </a>
          
          <nav class="nav-actions">
              <a href="catalogue.html" class="icon-btn"><i data-lucide="search"></i></a>
              <a href="cart.html" class="icon-btn" style="position:relative;">
                  <i data-lucide="shopping-bag"></i>
                  <span class="badge" id="cart-badge" style="display:none; position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:10px; padding:2px 5px; border-radius:50%;">0</span>
              </a>
              <a href="wishlist.html" class="icon-btn"><i data-lucide="heart"></i></a>
              <button class="menu-toggle" id="menu-toggle" style="z-index: 1001;"><i data-lucide="menu"></i></button>
          </nav>
      </div>
  </header>

  <div class="mobile-drawer" id="mobile-drawer">
      <div class="drawer-header">
          <span class="drawer-title">Menu</span>
          <button class="close-btn" id="close-btn"><i data-lucide="x"></i></button>
      </div>
      <nav class="drawer-nav">
          <a href="index.html" class="drawer-link"><i data-lucide="home"></i> Accueil</a>
          <a href="catalogue.html" class="drawer-link"><i data-lucide="grid"></i> Catalogue</a>
          <a href="cart.html" class="drawer-link"><i data-lucide="shopping-bag"></i> Panier</a>
          <a href="wishlist.html" class="drawer-link"><i data-lucide="heart"></i> Mes Favoris</a>
          <div class="drawer-divider"></div>
          <a href="seller.html" class="drawer-link"><i data-lucide="store"></i> Espace Vendeur</a>
          <a href="profile.html" class="drawer-link active"><i data-lucide="user"></i> Mon Profil</a>
      </nav>
  </div>
  <div id="menu-overlay"></div>

  <!-- DASHBOARD LAYOUT -->
  <div class="dashboard-container">
    
    <!-- SIDEBAR -->
    <aside class="profile-sidebar">
      <div class="profile-header">
        <div class="profile-avatar-container">
          <div class="profile-avatar-placeholder" id="avatar-placeholder">A</div>
          <img id="profile-image" alt="Avatar" class="profile-avatar-img" style="display: none;">
          <button type="button" class="profile-upload-btn" id="upload-trigger" title="Modifier la photo">
            <i data-lucide="camera"></i>
          </button>
          <input type="file" id="file-input" accept="image/png, image/jpeg" style="display:none;">
        </div>
        <h2 class="profile-name" id="sidebar-name">Chargement...</h2>
        <div class="profile-role" id="sidebar-role">Client</div>
      </div>

      <nav class="profile-nav" id="profile-nav-menu">
        <a class="profile-nav-item active" data-tab="dashboard" href="#">
          <i data-lucide="layout-grid"></i> Mon Tableau de Bord
        </a>
        <a class="profile-nav-item" data-tab="orders" href="#">
          <i data-lucide="shopping-bag"></i> Mes Commandes
        </a>
        <a class="profile-nav-item" data-tab="addresses" href="#">
          <i data-lucide="map-pin"></i> Mes Adresses
        </a>
        <a class="profile-nav-item" data-tab="wishlist" href="#">
          <i data-lucide="heart"></i> Mes Favoris
        </a>
        <a class="profile-nav-item logout" data-action="logout" href="#">
          <i data-lucide="log-out"></i> D√©connexion
        </a>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="profile-main">
      
      <!-- TAB: DASHBOARD -->
      <section id="tab-dashboard" class="tab-content">
        <h1 class="profile-section-title">Mon Tableau de Bord</h1>

        <!-- STATS -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Commandes en cours</div>
            <p class="stat-value" id="stat-orders">0</p>
            <div class="stat-icon"><i data-lucide="shopping-bag"></i></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total d√©pens√©</div>
            <p class="stat-value" id="stat-spent">0 FCFA</p>
            <div class="stat-icon"><i data-lucide="trending-up"></i></div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Articles favoris</div>
            <p class="stat-value" id="stat-wishlist">0</p>
            <div class="stat-icon"><i data-lucide="heart"></i></div>
          </div>
        </div>

        <!-- PERSONAL INFO -->
        <div class="profile-card">
          <h3><i data-lucide="user-circle"></i> Informations Personnelles</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="form-group">
              <label class="form-label">Nom Complet</label>
              <input type="text" id="user-name" class="form-input" placeholder="Votre nom">
            </div>
            <div class="form-group">
              <label class="form-label">Email</label>
              <input type="email" id="user-email" class="form-input" disabled>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">R√¥le</label>
            <input type="text" id="user-role" class="form-input" disabled>
          </div>

          <div class="btn-container">
            <button id="save-profile-btn" class="btn-primary">Enregistrer les modifications</button>
            <button class="btn-secondary" onclick="switchTab('orders')">Voir mes commandes</button>
          </div>
        </div>

        <!-- ORDERS LIST -->
        <div class="profile-card">
          <h3><i data-lucide="clock"></i> Mes Commandes</h3>
          <div id="orders-list-dashboard" class="orders-list"></div>
        </div>
      </section>

      <!-- TAB: ORDERS -->
      <section id="tab-orders" class="tab-content" style="display: none;">
        <h1 class="profile-section-title">Mes Commandes</h1>
        <div class="profile-card">
          <div id="orders-retention-controls" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
            <span id="orders-retention-note" style="color:#666; font-size:13px;">Les commandes livr√©es/annul√©es sont automatiquement supprim√©es apr√®s 30 jours.</span>
            <span class="retention-help" tabindex="0" aria-label="Aide sur la conservation" style="position:relative; display:inline-flex; align-items:center; cursor:help; color:#666;">
              <i data-lucide="help-circle"></i>
              <span class="tooltip-content" style="position:absolute; left:0; top:130%; background:#111; color:#fff; padding:8px 10px; border-radius:6px; font-size:12px; width:280px; box-shadow:0 6px 16px rgba(0,0,0,0.2); opacity:0; pointer-events:none; transform:translateY(4px); transition:opacity .15s, transform .15s; z-index:10;">
                Les commandes livr√©es ou annul√©es sont supprim√©es automatiquement apr√®s la p√©riode d√©finie. Cela permet de garder votre historique propre. Cette action est d√©finitive.
              </span>
            </span>
            <script>
              (function(){
                const el = document.currentScript.previousElementSibling;
                if (!el) return;
                const show = () => { const t = el.querySelector('.tooltip-content'); if (t){ t.style.opacity='1'; t.style.transform='translateY(0)'; } };
                const hide = () => { const t = el.querySelector('.tooltip-content'); if (t){ t.style.opacity='0'; t.style.transform='translateY(4px)'; } };
                el.addEventListener('mouseenter', show);
                el.addEventListener('mouseleave', hide);
                el.addEventListener('focus', show);
                el.addEventListener('blur', hide);
              })();
            </script>
            <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
              <label for="orderRetentionDaysInput" style="font-size:12px; color:#666;">Conservation (jours):</label>
              <input type="number" id="orderRetentionDaysInput" min="7" max="180" step="1" style="width:80px; padding:6px 8px; border:1px solid #ddd; border-radius:6px;" />
            </div>
          </div>
          <div id="orders-list-full" class="orders-list"></div>
        </div>
      </section>

      <!-- TAB: ADDRESSES -->
      <section id="tab-addresses" class="tab-content" style="display: none;">
        <h1 class="profile-section-title">Mes Adresses</h1>
        
        <button class="add-address-btn" id="btn-add-address">
          <i data-lucide="plus"></i> Nouvelle Adresse
        </button>

        <div class="addresses-grid" id="addresses-list">
          <div class="empty-state">
            <i data-lucide="map-pin"></i>
            <p>Aucune adresse enregistr√©e</p>
            <p style="font-size: 12px; margin-top: 10px; color: #d4af37; cursor: pointer;" onclick="document.getElementById('btn-add-address').click();">Ajouter une adresse ‚Üí</p>
          </div>
        </div>
      </section>

      <!-- TAB: WISHLIST -->
      <section id="tab-wishlist" class="tab-content" style="display: none;">
        <h1 class="profile-section-title">Mes Favoris</h1>
        <div class="products-grid" id="wishlist-grid">
          <div class="empty-state" style="grid-column: 1 / -1;">
            <i data-lucide="heart"></i>
            <p>Aucun favori pour le moment</p>
            <p style="font-size: 12px; margin-top: 10px;"><a href="catalogue.html" style="color: #d4af37; text-decoration: none;">D√©couvrir le catalogue ‚Üí</a></p>
          </div>
        </div>
      </section>

    </main>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <!-- MODAL AJOUTER ADRESSE -->
  <div class="modal" id="address-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Ajouter une Adresse</h2>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>

      <form id="address-form" style="display: flex; flex-direction: column; gap: 20px;">
        <div class="form-group">
          <label class="form-label">Nom Complet</label>
          <input type="text" id="addr-name" class="form-input" placeholder="ex: Jean Dupont" required>
        </div>

        <div class="form-group">
          <label class="form-label">T√©l√©phone</label>
          <input type="tel" id="addr-phone" class="form-input" placeholder="ex: +226 12 34 56 78" required>
        </div>

        <div class="form-group">
          <label class="form-label">Ville</label>
          <select id="addr-city" class="form-input" required>
            <option value="">-- S√©lectionner une ville --</option>
            <option value="Ouagadougou">Ouagadougou</option>
            <option value="Bobo-Dioulasso">Bobo-Dioulasso</option>
            <option value="Koudougou">Koudougou</option>
            <option value="Banfora">Banfora</option>
            <option value="D√©dougou">D√©dougou</option>
            <option value="Ouahigouya">Ouahigouya</option>
            <option value="Pouytenga">Pouytenga</option>
            <option value="Fada N'Gourma">Fada N'Gourma</option>
            <option value="Autre">Autre</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Quartier / Description</label>
          <textarea id="addr-description" class="form-input" placeholder="ex: Quartier Riyadh, √† c√¥t√© du march√©..." rows="3" required></textarea>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-cancel" id="btn-cancel-address">Annuler</button>
          <button type="submit" class="btn-submit" id="btn-save-address">Ajouter</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast-container" id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
      const ORDER_RETENTION_DAYS = 30; // suppression auto des commandes livr√©es/annul√©es apr√®s X jours

        // R√©cup√©rer la valeur de r√©tention choisie (client)
        function getRetentionDays() {
            const v = Number(localStorage.getItem('ac_order_retention_days'));
            return Number.isFinite(v) && v >= 1 ? v : ORDER_RETENTION_DAYS;
        }

        // GESTION MENU MOBILE
        const menuToggle = document.getElementById('menu-toggle');
        const closeBtn = document.getElementById('close-btn');
        const drawer = document.getElementById('mobile-drawer');
        const overlay = document.getElementById('menu-overlay');

        function openMenu() {
            drawer.classList.add('active');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeMenu() {
            drawer.classList.remove('active');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        if(menuToggle) menuToggle.addEventListener('click', openMenu);
        if(closeBtn) closeBtn.addEventListener('click', closeMenu);
        if(overlay) overlay.addEventListener('click', closeMenu);

        auth.onAuthStateChanged((user) => {
            if (user) {
                loadUserProfile(user);
                setupProfileImageUpload(user);
            // Mettre √† jour l'UI de r√©tention
            updateClientRetentionUI();
            } else {
                window.location.href = 'login.html';
            }
            if(typeof lucide !== 'undefined') lucide.createIcons();
        });

        async function loadUserProfile(user) {
            try {
                // V√©rifier vendeur
                const shopSnapshot = await db.collection('shops').where('ownerEmail', '==', user.email).get();
                const isVendor = !shopSnapshot.empty;
                const userRole = isVendor ? 'Vendeur' : 'Client';

                // R√©cup√©rer donn√©es utilisateur
                const docRef = db.collection('users').doc(user.uid);
                const doc = await docRef.get();
                
                let userData = { name: user.displayName || '', email: user.email };
                
                if (doc.exists) {
                    userData = doc.data();
                    if (userData.role !== userRole.toLowerCase()) {
                        await docRef.update({ role: userRole.toLowerCase() });
                    }
                } else {
                    await docRef.set({
                        name: user.displayName || '',
                        email: user.email,
                        role: userRole.toLowerCase(),
                        createdAt: new Date()
                    }, { merge: true });
                }

                // Remplir la sidebar
                const initials = (userData.name || user.email).split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2) || 'A';
                document.getElementById('avatar-placeholder').innerText = initials;
                document.getElementById('sidebar-name').innerText = userData.name || 'Utilisateur';
                document.getElementById('sidebar-role').innerText = userRole;

                // Charger photo de profil
                displayProfileImage(user);

                // Remplir le formulaire
                document.getElementById('user-name').value = userData.name || '';
                document.getElementById('user-email').value = user.email;
                document.getElementById('user-role').value = userRole;

                // Charger commandes + stats
                loadOrdersAndStats(user.uid);

                // Charger adresses
                loadUserAddresses(user.uid);

            } catch (error) {
                console.error('Erreur chargement profil:', error);
            }
        }

        function displayProfileImage(user) {
            const profileImg = document.getElementById('profile-image');
            const placeholder = document.getElementById('avatar-placeholder');
            
            if (user.photoURL) {
                profileImg.src = user.photoURL;
                profileImg.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                profileImg.style.display = 'none';
                placeholder.style.display = 'flex';
            }
        }

        function setupProfileImageUpload(user) {
            const uploadTrigger = document.getElementById('upload-trigger');
            const fileInput = document.getElementById('file-input');

            // Simuler clic sur input file quand on clique sur le bouton
            uploadTrigger.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });

            // G√©rer la s√©lection d'un fichier
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Validation
                if (!file.type.startsWith('image/')) {
                    alert('‚ùå Veuillez s√©lectionner une image.');
                    return;
                }

                if (file.size > 2 * 1024 * 1024) { // 2 Mo
                    alert('‚ùå L\'image doit peser moins de 2 Mo.');
                    return;
                }

                // Afficher indicateur de chargement
                const profileImg = document.getElementById('profile-image');
                const placeholder = document.getElementById('avatar-placeholder');
                uploadTrigger.style.opacity = '0.5';
                uploadTrigger.style.pointerEvents = 'none';

                try {
                    // V√©rifier que storage est disponible
                    if (!storage) {
                        throw new Error('Firebase Storage non initialis√©');
                    }

                    console.log('üì§ D√©but upload pour userId:', user.uid);
                    
                    // Cr√©er r√©f√©rence Firebase Storage
                    const storageRef = storage.ref(`users/${user.uid}/profile.jpg`);
                    
                    // Upload le fichier
                    console.log('‚è≥ Upload en cours...');
                    const snapshot = await storageRef.put(file);
                    console.log('‚úÖ Upload termin√©');
                    
                    // R√©cup√©rer l'URL de t√©l√©chargement
                    const downloadURL = await snapshot.ref.getDownloadURL();
                    console.log('üîó URL obtenue:', downloadURL);

                    // Mettre √† jour Firebase Auth
                    await user.updateProfile({ photoURL: downloadURL });
                    console.log('‚úÖ Auth mis √† jour');

                    // Mettre √† jour Firestore
                    await db.collection('users').doc(user.uid).update({ 
                        photoURL: downloadURL,
                        updatedAt: new Date()
                    });
                    console.log('‚úÖ Firestore mis √† jour');

                    // Mettre √† jour l'affichage imm√©diatement
                    profileImg.src = downloadURL;
                    profileImg.style.display = 'block';
                    placeholder.style.display = 'none';

                    // Afficher succ√®s
                    showToast('‚úÖ Photo de profil mise √† jour avec succ√®s !', 'success');

                } catch (error) {
                    console.error('‚ùå Erreur upload d√©taill√©e:', error);
                    console.error('Code erreur:', error.code);
                    console.error('Message:', error.message);
                    
                    let errorMsg = '‚ùå Erreur lors de l\'upload.';
                    
                    if (error.code === 'storage/unauthorized') {
                        errorMsg += ' Permissions insuffisantes.';
                    } else if (error.message && error.message.includes('network')) {
                        errorMsg += ' Probl√®me de connexion. D√©sactivez votre bloqueur de pub.';
                    } else if (error.code) {
                        errorMsg += ` (${error.code})`;
                    }
                    
                    alert(errorMsg);
                    showToast(errorMsg, 'error');
                } finally {
                    uploadTrigger.style.opacity = '1';
                    uploadTrigger.style.pointerEvents = 'auto';
                    fileInput.value = ''; // R√©initialiser input
                    lucide.createIcons();
                }
            });
        }

        // PURGE DES COMMANDES (client) : supprime les commandes livr√©es/annul√©es apr√®s X jours
        async function purgeOldCompletedOrders(userId, retentionDays = ORDER_RETENTION_DAYS) {
          try {
            const cutoff = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000);
            const snap = await db.collection('orders').where('userId', '==', userId).get();
            let deleted = 0;

            for (const doc of snap.docs) {
              const o = doc.data();
              const status = (o.status || 'pending').toLowerCase();
              if (status !== 'delivered' && status !== 'cancelled') continue;

              const updated = o.updatedAt?.toDate?.() || (o.createdAt?.toDate?.() || new Date(0));
              if (updated < cutoff) {
                await db.collection('orders').doc(doc.id).delete();
                deleted++;
              }
            }

            if (deleted > 0) {
              showToast(`üßπ ${deleted} commande(s) anciennes supprim√©es`, 'info');
            }
          } catch (err) {
            console.warn('Purge client des commandes √©chou√©e:', err);
          }
        }

        async function loadOrdersAndStats(userId) {
            const containers = ['orders-list-dashboard', 'orders-list-full'];
            containers.forEach(id => {
                const c = document.getElementById(id);
                if (c) c.innerHTML = '<div class="empty-state" style="padding:24px; color:#999;">Chargement des commandes...</div>';
            });

            try {
            // Ex√©cuter la purge avant de charger les commandes
            try {
              await purgeOldCompletedOrders(userId, getRetentionDays());
            } catch (e) {
              console.warn('Purge ignor√©e avant chargement des commandes:', e);
            }

                let orders = [];
                try {
                    orders = await fetchOrders(userId, true); // avec orderBy
                } catch (err) {
                    console.warn('Retry sans orderBy (index manquant ?)', err);
                    orders = await fetchOrders(userId, false);
                }

                const wishlistItems = JSON.parse(localStorage.getItem('ac_wishlist') || '[]').length;

                // Stats
                const totalOrders = orders.length;
                const totalSpent = orders.reduce((sum, order) => sum + (order.total || 0), 0);
                document.getElementById('stat-orders').innerText = totalOrders;
                document.getElementById('stat-spent').innerText = new Intl.NumberFormat('fr-FR').format(totalSpent) + ' FCFA';
                document.getElementById('stat-wishlist').innerText = wishlistItems;

                // Rendering lists
                renderOrdersList(orders, 'orders-list-dashboard');
                renderOrdersList(orders, 'orders-list-full');

            } catch (error) {
                console.error('Erreur chargement commandes/stats:', error);
                renderOrdersError('orders-list-dashboard');
                renderOrdersError('orders-list-full');
            }
        }

        async function fetchOrders(userId, withOrderBy = true) {
            let query = db.collection('orders').where('userId', '==', userId);
            if (withOrderBy) query = query.orderBy('createdAt', 'desc');
            const snap = await query.get();
            return snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        function renderOrdersList(orders, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            if (!orders.length) {
                return renderOrdersEmpty(containerId);
            }

          // Trier: commandes livr√©es en bas, puis par date (r√©cent en premier)
          const priority = (status) => {
            const s = (status || '').toLowerCase();
            if (s === 'delivered' || s.includes('livr')) return 2; // fin de file
            if (s === 'cancelled' || s.includes('annul')) return 1;
            return 0; // en cours / en attente / exp√©di√©e
          };

          const sorted = [...orders].sort((a, b) => {
            const pa = priority(a.status);
            const pb = priority(b.status);
            if (pa !== pb) return pa - pb;
            const da = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.createdAt || 0);
            const db = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.createdAt || 0);
            return db - da;
          });

          container.innerHTML = sorted.map((order) => {
                const date = formatDate(order.createdAt);
                const total = new Intl.NumberFormat('fr-FR').format(order.total || 0);
                const itemsCount = order.items?.length || 0;
                const status = formatStatus(order.status);

                return `
                    <div class="order-preview">
                        <div class="order-info">
                            <h4>Commande #${order.id.substring(0, 8).toUpperCase()} <span class="order-status ${status.className}">${status.label}</span></h4>
                            <p class="order-meta">Date: ${date} ‚Ä¢ ${itemsCount} article(s)</p>
                        </div>
                        <div class="order-total">${total} FCFA</div>
                    </div>
                `;
            }).join('');

            lucide.createIcons();
        }

        function renderOrdersEmpty(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="inbox"></i>
                    <p>Aucune commande pour le moment</p>
                    <p style="font-size: 12px; margin-top: 10px;"><a href="catalogue.html" style="color: #d4af37; text-decoration: none;">D√©couvrir le catalogue ‚Üí</a></p>
                </div>
            `;
            lucide.createIcons();
        }

        function renderOrdersError(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = `
                <div class="empty-state">
                    <i data-lucide="alert-circle"></i>
                    <p>Impossible de charger vos commandes</p>
                    <p style="font-size: 12px; margin-top: 10px; color:#b91c1c;">V√©rifiez la connexion ou cr√©ez l'index Firestore pour userId + createdAt.</p>
                </div>
            `;
        }

        // Mettre √† jour l'UI de r√©tention c√¥t√© client
        function updateClientRetentionUI() {
          const input = document.getElementById('orderRetentionDaysInput');
          const note = document.getElementById('orders-retention-note');
          const days = getRetentionDays();
          if (note) note.innerText = `Les commandes livr√©es/annul√©es sont automatiquement supprim√©es apr√®s ${days} jours.`;
          if (!input) return;
          input.value = days;
          input.onchange = async (e) => {
            const val = Math.max(7, Math.min(180, Number(e.target.value || ORDER_RETENTION_DAYS)));
            localStorage.setItem('ac_order_retention_days', String(val));
            if (note) note.innerText = `Les commandes livr√©es/annul√©es sont automatiquement supprim√©es apr√®s ${val} jours.`;
            const currentUser = firebase.auth().currentUser;
            if (currentUser) {
              try {
                await purgeOldCompletedOrders(currentUser.uid, val);
                await loadOrdersAndStats(currentUser.uid);
              } catch (err) {
                console.warn('Erreur lors de la purge apr√®s changement de r√©tention:', err);
              }
            }
          };
        }

        function formatStatus(status) {
          const normalized = (status || 'pending').toLowerCase();
          
          if (normalized === 'delivered' || normalized.includes('livr')) {
            return { label: '‚úÖ Livr√©e', className: 'status-success' };
          }
          if (normalized === 'cancelled' || normalized.includes('annul')) {
            return { label: '‚ùå Annul√©e', className: 'status-danger' };
          }
          if (normalized === 'shipped' || normalized.includes('exp√©d')) {
            return { label: 'üì¶ Exp√©di√©e', className: 'status-info' };
          }
          if (normalized === 'pending' || normalized.includes('attente')) {
            return { label: '‚è≥ En attente', className: 'status-warning' };
          }
          return { label: 'En cours', className: 'status-info' };
        }

        function formatDate(timestamp) {
          try {
            const date = timestamp?.toDate ? timestamp.toDate() : (timestamp ? new Date(timestamp) : new Date());
            return date.toLocaleDateString('fr-FR');
          } catch (e) {
            return '';
          }
        }

        // Sauvegarde profil
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            const newName = document.getElementById('user-name').value.trim();
            if (!newName) {
                alert('Le nom ne peut pas √™tre vide.');
                return;
            }

            const btn = document.getElementById('save-profile-btn');
            btn.innerText = 'Enregistrement...';
            btn.disabled = true;

            try {
                await user.updateProfile({ displayName: newName });
                await db.collection('users').doc(user.uid).update({ name: newName });
                
                document.getElementById('sidebar-name').innerText = newName;
                showToast('‚úÖ Profil mis √† jour !', 'success');
            } catch (error) {
                console.error('Erreur:', error);
                alert('‚ùå Erreur lors de la mise √† jour.');
            } finally {
                btn.innerText = 'Enregistrer les modifications';
                btn.disabled = false;
            }
        });

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: ${type === 'success' ? '#10b981' : '#3b82f6'};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                margin-bottom: 10px;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            toast.innerText = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // D√©connexion
        window.logoutUser = () => {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                auth.signOut().then(() => window.location.href = 'login.html');
            }
        };

        // Navigation entre tabs - Gestion des onglets
        window.switchTab = (tabName) => {
            // Masquer tous les onglets
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.setAttribute('aria-hidden', 'true');
            });
            
            // Afficher l'onglet s√©lectionn√©
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.setAttribute('aria-hidden', 'false');
                selectedTab.focus();
            }
            
            // Mettre √† jour les √©tats actifs des liens de navigation
            document.querySelectorAll('.profile-nav-item[data-tab]').forEach(item => {
                item.classList.remove('active');
                item.setAttribute('aria-selected', 'false');
            });
            
            const activeLink = document.querySelector('.profile-nav-item[data-tab="' + tabName + '"]');
            if (activeLink) {
                activeLink.classList.add('active');
                activeLink.setAttribute('aria-selected', 'true');
            }

            // Recharger les donn√©es selon l'onglet
            if (tabName === 'wishlist') {
                loadUserWishlist();
            }
            
            // Recharger les commandes pour avoir les mises √† jour en temps r√©el
            if (tabName === 'orders') {
              // Mettre √† jour l'UI de r√©tention
              updateClientRetentionUI();
                const currentUser = firebase.auth().currentUser;
                if (currentUser) {
                    loadOrdersAndStats(currentUser.uid);
                }
            }
        };

        // Gestion des clics sur les liens de navigation
        document.querySelectorAll('.profile-nav-item[data-tab]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = e.currentTarget.getAttribute('data-tab');
                switchTab(tabName);
            });
        });

        // Gestion du lien d√©connexion
        document.querySelector('.profile-nav-item[data-action="logout"]')?.addEventListener('click', (e) => {
            e.preventDefault();
            logoutUser();
        });

        // --- GESTION DES ADRESSES ---
        const addressModal = document.getElementById('address-modal');
        const addressForm = document.getElementById('address-form');
        const btnAddAddress = document.getElementById('btn-add-address');
        const btnCancelAddress = document.getElementById('btn-cancel-address');
        const modalClose = document.getElementById('modal-close');

        // Ouvrir modal
        btnAddAddress.addEventListener('click', () => {
            addressForm.reset();
            addressModal.classList.add('active');
        });

        // Fermer modal
        [btnCancelAddress, modalClose].forEach(btn => {
            btn.addEventListener('click', () => addressModal.classList.remove('active'));
        });

        addressModal.addEventListener('click', (e) => {
            if (e.target === addressModal) addressModal.classList.remove('active');
        });

        // Soumettre formulaire adresse
        addressForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return alert('‚ùå Vous devez √™tre connect√©.');

            const newAddress = {
                name: document.getElementById('addr-name').value.trim(),
                phone: document.getElementById('addr-phone').value.trim(),
                city: document.getElementById('addr-city').value,
                description: document.getElementById('addr-description').value.trim(),
                createdAt: new Date()
            };

            if (!newAddress.name || !newAddress.phone || !newAddress.city || !newAddress.description) {
                return alert('‚ùå Veuillez remplir tous les champs.');
            }

            const submitBtn = document.getElementById('btn-save-address');
            submitBtn.disabled = true;
            submitBtn.innerText = 'Ajout en cours...';

            try {
                await db.collection('users').doc(user.uid).collection('addresses').add(newAddress);
                showToast('‚úÖ Adresse ajout√©e avec succ√®s !', 'success');
                addressModal.classList.remove('active');
                loadUserAddresses(user.uid);
            } catch (error) {
                console.error('Erreur ajout adresse:', error);
                showToast('‚ùå Erreur lors de l\'ajout.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = 'Ajouter';
            }
        });

        // Charger les adresses au chargement du profil
        async function loadUserAddresses(userId) {
            try {
                const snap = await db.collection('users').doc(userId).collection('addresses').get();
                const addresses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAddressesList(addresses);
            } catch (error) {
                console.error('Erreur chargement adresses:', error);
            }
        }

        // Afficher les adresses
        function renderAddressesList(addresses) {
            const container = document.getElementById('addresses-list');
            if (!container) return;

            if (!addresses.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-lucide="map-pin"></i>
                        <p>Aucune adresse enregistr√©e</p>
                        <p style="font-size: 12px; margin-top: 10px; color: #d4af37; cursor: pointer;" onclick="document.getElementById('btn-add-address').click();">Ajouter une adresse ‚Üí</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            container.innerHTML = addresses.map(addr => `
                <div class="address-card">
                    <h4>${escapeHtml(addr.name)}</h4>
                    <div class="address-info">
                        <p><i data-lucide="phone"></i> ${escapeHtml(addr.phone)}</p>
                        <p><i data-lucide="map-pin"></i> ${escapeHtml(addr.city)}</p>
                        <p><i data-lucide="navigation"></i> ${escapeHtml(addr.description)}</p>
                    </div>
                    <div class="address-actions">
                        <button class="btn-delete-address" onclick="deleteAddress('${escapeHtml(addr.id)}')">
                            <i data-lucide="trash-2"></i> Supprimer
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // Supprimer une adresse
        window.deleteAddress = async (addressId) => {
            const user = auth.currentUser;
            if (!user) return;

            if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette adresse ?')) return;

            try {
                await db.collection('users').doc(user.uid).collection('addresses').doc(addressId).delete();
                showToast('‚úÖ Adresse supprim√©e.', 'success');
                loadUserAddresses(user.uid);
            } catch (error) {
                console.error('Erreur suppression adresse:', error);
                showToast('‚ùå Erreur lors de la suppression.', 'error');
            }
        };

        // Fonction utilitaire pour √©viter les XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // --- GESTION DES FAVORIS ---
        async function loadUserWishlist() {
            try {
                const wishlistIds = JSON.parse(localStorage.getItem('ac_wishlist') || '[]');
                
                if (!wishlistIds.length) {
                    renderEmptyWishlist();
                    return;
                }

                const products = [];
                for (const productId of wishlistIds) {
                    try {
                        const doc = await db.collection('products').doc(productId).get();
                        if (doc.exists) {
                            products.push({ id: doc.id, ...doc.data() });
                        }
                    } catch (err) {
                        console.warn(`Produit ${productId} non trouv√©`, err);
                    }
                }

                if (products.length === 0) {
                    renderEmptyWishlist();
                } else {
                    renderWishlistProducts(products);
                }
            } catch (error) {
                console.error('Erreur chargement favoris:', error);
                renderEmptyWishlist();
            }
        }

        function renderWishlistProducts(products) {
            const container = document.getElementById('wishlist-grid');
            if (!container) return;

            container.innerHTML = products.map(product => {
                const price = new Intl.NumberFormat('fr-FR').format(product.price || 0);
                const image = product.image || 'assets/img/placeholder.jpg';
                
                return `
                    <div class="product-card">
                        <div class="product-image-container">
                            <img src="${escapeHtml(image)}" alt="${escapeHtml(product.name)}" class="product-image" onerror="this.src='assets/img/placeholder.jpg'">
                            <button class="product-remove-btn" title="Retirer des favoris" onclick="removeFromWishlist('${escapeHtml(product.id)}')">
                                √ó
                            </button>
                        </div>
                        <div class="product-info">
                            <h4 class="product-name">${escapeHtml(product.name)}</h4>
                            <div class="product-price">${price} FCFA</div>
                            <div class="product-actions">
                                <button class="btn-add-to-cart" onclick="addToCart('${escapeHtml(product.id)}')">
                                    <i data-lucide="shopping-bag" style="width:14px; height:14px; display:inline; margin-right:4px;"></i> Ajouter
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            lucide.createIcons();
        }

        function renderEmptyWishlist() {
            const container = document.getElementById('wishlist-grid');
            if (!container) return;

            container.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <i data-lucide="heart"></i>
                    <p>Aucun favori pour le moment</p>
                    <p style="font-size: 12px; margin-top: 10px;"><a href="catalogue.html" style="color: #d4af37; text-decoration: none;">D√©couvrir le catalogue ‚Üí</a></p>
                </div>
            `;
            lucide.createIcons();
        }

        // Retirer un produit des favoris
        window.removeFromWishlist = (productId) => {
            let wishlistIds = JSON.parse(localStorage.getItem('ac_wishlist') || '[]');
            wishlistIds = wishlistIds.filter(id => id !== productId);
            localStorage.setItem('ac_wishlist', JSON.stringify(wishlistIds));
            showToast('‚ù§Ô∏è Produit retir√© des favoris', 'success');
            loadUserWishlist();
        };

        // Ajouter au panier
        window.addToCart = (productId) => {
            let cart = JSON.parse(localStorage.getItem('ac_cart') || '[]');
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity = (existingItem.quantity || 1) + 1;
            } else {
                cart.push({ id: productId, quantity: 1 });
            }
            
            localStorage.setItem('ac_cart', JSON.stringify(cart));
            showToast('‚úÖ Produit ajout√© au panier', 'success');
            updateCartBadge();
        };

        // Mettre √† jour le badge du panier
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('ac_cart') || '[]');
            const badge = document.getElementById('cart-badge');
            const totalItems = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
            
            if (badge) {
                if (totalItems > 0) {
                    badge.innerText = totalItems;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Charger les favoris lors du chargement initial
        loadUserWishlist();

        document.getElementById('year').innerText = new Date().getFullYear();
        lucide.createIcons();
    });

    // Animation CSS pour les toasts
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
  <script src="assets/js/footer.js" defer></script>
</body>
</html>