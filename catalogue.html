<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogue ‚Äî Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="assets/css/styles.css" />
  
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Configuration & Utilities -->
  <script src="assets/js/config.js"></script>
  <!-- Data Store -->
  <script src="assets/js/data.js" defer></script>


</head>

<body class="catalogue-page">
  <header id="app-header" class="glass-nav">
      <div class="nav-content">
          <a href="index.html" class="brand">
              <div class="brand-logo-img" style="background:var(--gold); display:flex; align-items:center; justify-content:center;">
                  <span style="font-weight:bold; color:black;">A</span>
              </div>
              <div style="display:flex; flex-direction:column; margin-left:10px;">
                  <span class="brand-name">AURUM</span>
                  <span class="tagline" style="font-size:10px; letter-spacing:1px;">EXCELLENCE √Ä VOTRE PORT√âE</span>
              </div>
          </a>

          <nav class="nav-icons">
             <a href="catalogue.html" class="icon-btn"><i data-lucide="search"></i></a>
              <a href="cart.html" class="icon-btn" style="position:relative;">
                  <i data-lucide="shopping-bag"></i>
                  <span class="badge" id="cart-badge" style="display:none;">0</span>
              </a>
              <a href="wishlist.html" class="icon-btn"><i data-lucide="heart"></i></a>
              <button class="menu-toggle" id="menu-toggle" style="z-index: 1001;"><i data-lucide="menu"></i></button>
          </nav>
      </div>
  </header>

  <div class="mobile-drawer" id="mobile-drawer">
      <div class="drawer-header">
          <span class="drawer-title">Menu</span>
          <button class="close-btn" id="close-btn"><i data-lucide="x"></i></button>
      </div>
      <nav class="drawer-nav">
          <a href="index.html" class="drawer-link"><i data-lucide="home"></i> Accueil</a>
          <a href="catalogue.html" class="drawer-link"><i data-lucide="grid"></i> Catalogue</a>
          <a href="cart.html" class="drawer-link"><i data-lucide="shopping-bag"></i> Panier</a>
          <a href="wishlist.html" class="drawer-link"><i data-lucide="heart"></i> Mes Favoris</a>
          <a href="boutique-list.html" class="drawer-link"><i data-lucide="store"></i> Nos Boutiques</a>
          <div class="drawer-divider"></div>
          <a href="seller.html" class="drawer-link"><i data-lucide="store"></i> Espace Vendeur</a>
          <div class="drawer-divider"></div>
          <a href="#" id="mobile-logout-btn" class="drawer-link" style="color: #ef4444;">
              <i data-lucide="log-out"></i> D√©connexion
          </a>
      </nav>
  </div>
  <div id="menu-overlay"></div>

  <main class="container">
    <div style="background: transparent !important; padding: 0;">
      <section class="section" style="background: transparent !important; padding: 30px 0 !important; margin-bottom: 0 !important;">
        <div style="background: transparent !important;">
          <h1 class="section-title" style="text-align: center; font-size: 42px; margin: 0 0 15px 0; color: #1a1a1a;">Catalogue</h1>
          <p style="text-align: center; color: #1a1a1a; font-size: 18px; margin-bottom: 100px; font-weight: 600;">D√©couvrez notre s√©lection d'excellence</p>
        </div>
      
      <!-- Recherche Premium avec Bouton Gold -->
    <div class="search-container catalogue-search-container">
        <div class="search-input-wrapper">
          <i data-lucide="search" class="search-icon"></i>
          <input 
            id="search-input" 
            type="text"
            placeholder="Recherchez vos produits..." 
            autocomplete="off"
          >
          <button class="search-btn" type="button" onclick="applyFilters()">
            <i data-lucide="search"></i>
          </button>
        </div>
        <div class="search-autocomplete" id="search-autocomplete"></div>
      </div>

      <!-- Mobile Filters Toggle -->
      <div class="mobile-filters-toggle">
        <button class="mobile-filters-btn" id="toggle-filters">
          <i data-lucide="sliders"></i>
          Filtres
        </button>
      </div>

      <!-- Layout avec Sidebar + Content -->
      <div class="catalogue-layout">
        
        <!-- SIDEBAR FILTRES AVEC ACCORD√âON -->
        <aside class="filters-sidebar" id="filters-sidebar">
          <div class="filters-header">
            <h3>
              <i data-lucide="sliders"></i>
              Filtres
            </h3>
            <a href="#" class="filters-reset" id="reset-filters">R√©initialiser</a>
          </div>

          <!-- Filtre Prix -->
          <div class="filter-group" data-filter="price">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="dollar-sign"></i>
                <span>Prix (FCFA)</span>
              </div>
              <i data-lucide="chevron-down" class="chevron"></i>
            </div>
            <div class="filter-group-content">
              <div class="price-inputs">
                <input 
                  type="number" 
                  class="price-input" 
                  id="price-min" 
                  placeholder="Min"
                  min="0"
                >
                <span style="color: #D4AF37; font-weight: 700;">‚Äî</span>
                <input 
                  type="number" 
                  class="price-input" 
                  id="price-max" 
                  placeholder="Max"
                  min="0"
                >
              </div>
              <div class="price-slider">
                <input 
                  type="range" 
                  id="price-range-min" 
                  min="0" 
                  max="1000000" 
                  step="1000"
                  value="0"
                >
                <input 
                  type="range" 
                  id="price-range-max" 
                  min="0" 
                  max="1000000" 
                  step="1000"
                  value="1000000"
                >
              </div>
            </div>
          </div>

          <!-- Filtre Cat√©gories -->
          <div class="filter-group" data-filter="category">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="grid"></i>
                <span>Cat√©gories</span>
              </div>
              <i data-lucide="chevron-down" class="chevron"></i>
            </div>
            <div class="filter-group-content">
              <!-- Cat√©gories g√©n√©r√©es dynamiquement -->
              <div id="category-filters-dynamic">
                <!-- Toutes les cat√©gories charg√©es ici -->
              </div>
            </div>
          </div>

          <!-- Filtre Note Vendeur -->
          <div class="filter-group" data-filter="rating">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="star"></i>
                <span>Note Vendeur</span>
              </div>
              <i data-lucide="chevron-down" class="chevron"></i>
            </div>
            <div class="filter-group-content">
              <div class="filter-checkbox">
                <input type="checkbox" id="rating-4plus" value="4">
                <label for="rating-4plus">
                  <span>‚≠ê‚≠ê‚≠ê‚≠ê 4 √©toiles et plus</span>
                </label>
              </div>
              <div class="filter-checkbox">
                <input type="checkbox" id="rating-3plus" value="3">
                <label for="rating-3plus">
                  <span>‚≠ê‚≠ê‚≠ê 3 √©toiles et plus</span>
                </label>
              </div>
            </div>
          </div>

          <!-- Filtre Couleurs (Cercles cliquables) -->
          <div class="filter-group" data-filter="color">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="palette"></i>
                <span>Couleurs</span>
              </div>
              <i data-lucide="chevron-down" class="chevron"></i>
            </div>
            <div class="filter-group-content">
              <div class="colors-grid">
                <div class="color-swatch" data-color="#000000" style="background: #000000;" title="Noir"></div>
                <div class="color-swatch" data-color="#FFFFFF" style="background: #FFFFFF; border-color: #ddd;" title="Blanc"></div>
                <div class="color-swatch" data-color="#D4AF37" style="background: #D4AF37;" title="Or"></div>
                <div class="color-swatch" data-color="#FF0000" style="background: #FF0000;" title="Rouge"></div>
                <div class="color-swatch" data-color="#0000FF" style="background: #0000FF;" title="Bleu"></div>
                <div class="color-swatch" data-color="#00FF00" style="background: #00FF00;" title="Vert"></div>
                <div class="color-swatch" data-color="#FFC0CB" style="background: #FFC0CB;" title="Rose"></div>
                <div class="color-swatch" data-color="#FFA500" style="background: #FFA500;" title="Orange"></div>
                <div id="color-filters-dynamic">
                  <!-- Autres couleurs charg√©es dynamiquement -->
                </div>
              </div>
            </div>
          </div>

          <!-- Filtre Localisation (Select Stylis√©) -->
          <div class="filter-group" data-filter="location">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="map-pin"></i>
                <span>Localisation</span>
              </div>
              <i data-lucide="chevron-down" class="chevron"></i>
            </div>
            <div class="filter-group-content">
              <select id="location-select" class="location-select">
                <option value="">Toutes les villes</option>
                <option value="Ouagadougou">Ouagadougou</option>
                <option value="Bobo-Dioulasso">Bobo-Dioulasso</option>
                <option value="Koudougou">Koudougou</option>
                <option value="Ouahigouya">Ouahigouya</option>
                <option value="Banfora">Banfora</option>
                <option value="Tenkodogo">Tenkodogo</option>
                <option value="D√©dougou">D√©dougou</option>
                <option value="Kaya">Kaya</option>
              </select>
            </div>
          </div>

          <!-- Filtre Tri -->
          <div class="filter-group" data-filter="sort">
            <div class="filter-group-title" onclick="toggleFilterGroup(this)">
              <div style="display: flex; align-items: center; gap: 10px;">
                <i data-lucide="arrow-down-up"></i>
                <span>Trier par</span>
              </div>
              <i data-lucide="chevron-down" class="chevron"></i>
            </div>
            <div class="filter-group-content">
              <select id="sort-select" class="location-select">
                <option value="recent">Plus r√©cent</option>
                <option value="price-asc">Prix croissant</option>
                <option value="price-desc">Prix d√©croissant</option>
                <option value="popular">Plus populaire</option>
              </select>
            </div>
          </div>
        </aside>

        <!-- CONTENU CATALOGUE -->
        <div class="catalogue-content">
          <!-- Tags Filtres Actifs -->
          <div class="active-filters" id="active-filters"></div>

          <!-- Grille Produits -->
          <div id="catalogue-grid" class="grid grid-4">
            <p>Chargement du catalogue...</p>
          </div>
        </div>

      </div>
      
    </section>
  </main>

  <!-- Overlay pour mobile -->
  <div class="filters-overlay" id="filters-overlay"></div>

  <!-- App Module -->
  <script src="assets/js/app.js" defer></script>
  
  <script>
    // === CATALOGUE AVANC√â - FILTRES & RECHERCHE INTELLIGENTE ===
    document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Catalogue - Initialisation...');
        
        // V√©rifier Firebase
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase n\'est pas charg√© !');
            document.getElementById('catalogue-grid').innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #fff3cd; border-radius: 12px;">
                    <h3 style="color: #856404;">Firebase n'est pas charg√©</h3>
                    <p style="color: #856404;">V√©rifiez que les scripts Firebase sont correctement inclus.</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer;">
                        Recharger
                    </button>
                </div>
            `;
            return;
        }

        if (!firebase.apps || !firebase.apps.length) {
            console.error('‚ùå Firebase n\'est pas initialis√© !');
            document.getElementById('catalogue-grid').innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #fff3cd; border-radius: 12px;">
                    <h3 style="color: #856404;">Firebase n'est pas initialis√©</h3>
                    <p style="color: #856404;">V√©rifiez votre configuration Firebase dans auth.js</p>
                    <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer;">
                        Recharger
                    </button>
                </div>
            `;
            return;
        }

        console.log('‚úÖ Firebase OK');
        
        const yearSpan = document.getElementById('year');
        if (yearSpan) yearSpan.innerText = new Date().getFullYear();

        const db = firebase.firestore();
        console.log('‚úÖ Firestore initialis√©');
        
        // === √âTAT GLOBAL ===
        let allProducts = [];
        let allCategories = [];
        let allColors = new Set();
        let allLocations = new Set();
        let searchDebounceTimer = null;

        // === √âL√âMENTS DOM ===
        const searchInput = document.getElementById('search-input');
        const searchAutocomplete = document.getElementById('search-autocomplete');
        const priceMin = document.getElementById('price-min');
        const priceMax = document.getElementById('price-max');
        const priceRangeMin = document.getElementById('price-range-min');
        const priceRangeMax = document.getElementById('price-range-max');
        const categoryFilters = document.getElementById('category-filters-dynamic');
        const colorFilters = document.getElementById('color-filters-dynamic');
        const locationSelect = document.getElementById('location-select');
        const sortSelect = document.getElementById('sort-select');
        const catalogueGrid = document.getElementById('catalogue-grid');
        const activeFiltersDiv = document.getElementById('active-filters');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const toggleFiltersBtn = document.getElementById('toggle-filters');
        const filtersSidebar = document.getElementById('filters-sidebar');
        const filtersOverlay = document.getElementById('filters-overlay');
        const urlParams = new URLSearchParams(window.location.search);
        const initialSearch = (urlParams.get('q') || '').trim();

        // === INITIALISATION ===
        initializeCatalogue();

        async function initializeCatalogue() {
            try {
                console.log('üì¶ Chargement du catalogue...');
                catalogueGrid.innerHTML = "<p style='text-align:center; color:#888; padding: 40px;'><i data-lucide='loader' class='animate-spin'></i> Chargement du catalogue...</p>";
                if (typeof lucide !== 'undefined') lucide.createIcons();

                // === OPTIMISATION MAJEURE : CHARGEMENT PARALL√àLE ===
                // Charger TOUT en m√™me temps pour gagner du temps
                console.log('‚ö° Chargement parall√®le : cat√©gories + shops + produits...');
                
                const [categoriesSnap, shopsSnap, productsSnap] = await Promise.all([
                    db.collection('categories').get(),
                    db.collection('shops').get(),
                    db.collectionGroup('products').get()
                ]);

                console.log(`‚úÖ Chargement termin√©:`, {
                    cat√©gories: categoriesSnap.size,
                    boutiques: shopsSnap.size,
                    produits: productsSnap.size
                });

                // Traiter les cat√©gories
                categoriesSnap.forEach(doc => {
                    allCategories.push({ id: doc.id, ...doc.data() });
                });

                // Cr√©er une Map des boutiques pour acc√®s instantan√© (au lieu de requ√™tes r√©p√©t√©es)
                const shopsMap = new Map();
                shopsSnap.forEach(doc => {
                    shopsMap.set(doc.id, doc.data());
                });
                console.log(`üìä ${shopsMap.size} boutiques index√©es en m√©moire`);

                if (productsSnap.empty) {
                    catalogueGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                            <i data-lucide="package-x" style="width: 64px; height: 64px; color: #ddd; margin-bottom: 20px;"></i>
                            <h3 style="color: #999; font-weight: 600; margin-bottom: 10px;">Catalogue vide</h3>
                            <p style="color: #bbb;">Aucun produit n'est disponible pour le moment.</p>
                            <p style="color: #bbb; font-size: 14px; margin-top: 10px;">Les vendeurs peuvent ajouter des produits depuis leur espace vendeur.</p>
                        </div>
                    `;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }

                // === CONSTRUCTION ULTRA-RAPIDE (tout est en m√©moire) ===
                console.log('üöÄ Construction de la liste produits...');
                productsSnap.forEach(doc => {
                    const productData = doc.data();
                    
                    // D√©terminer le shopId (selon la structure)
                    let shopId;
                    if (doc.ref.parent.parent) {
                        // Structure : shops/{shopId}/products/{productId}
                        shopId = doc.ref.parent.parent.id;
                    } else if (productData.shopId) {
                        // shopId stock√© directement dans le produit
                        shopId = productData.shopId;
                    } else {
                        shopId = 'unknown';
                    }
                    
                    // R√©cup√©rer les infos boutique depuis la Map (instantan√© !)
                    const shopData = shopsMap.get(shopId) || {};
                    const shopName = shopData.name || 'Boutique';
                    const shopRating = shopData.rating || 0;
                    const shopCity = shopData.city || shopData.address || '';

                    // Extraire couleurs si disponibles
                    if (productData.colors && Array.isArray(productData.colors)) {
                        productData.colors.forEach(c => allColors.add(c));
                    }

                    // Ajouter localisation
                    if (shopCity) {
                        allLocations.add(shopCity);
                    }

                    allProducts.push({
                        id: doc.id,
                        shopId,
                        shopName,
                        shopRating,
                        shopCity,
                        ...productData
                    });
                });

                console.log(`‚úÖ ${allProducts.length} produits charg√©s avec succ√®s`);
                console.log(`üìä Statistiques:`, {
                    produits: allProducts.length,
                    cat√©gories: allCategories.length,
                    couleurs: allColors.size,
                    villes: allLocations.size
                });

                // Calculer min/max prix
                const prices = allProducts.map(p => p.price || 0).filter(p => p > 0);
                const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                const maxPrice = prices.length > 0 ? Math.max(...prices) : 1000000;
                
                console.log(`üí∞ Prix: ${minPrice} - ${maxPrice} FCFA`);
                
                priceMin.value = minPrice;
                priceMax.value = maxPrice;
                priceMin.placeholder = minPrice;
                priceMax.placeholder = maxPrice;
                priceRangeMin.min = minPrice;
                priceRangeMin.max = maxPrice;
                priceRangeMin.value = minPrice;
                priceRangeMax.min = minPrice;
                priceRangeMax.max = maxPrice;
                priceRangeMax.value = maxPrice;

                // Initialiser les filtres UI
                console.log('üé® Initialisation des filtres UI...');
                renderCategoryFilters();
                renderColorFilters();
                renderLocationFilters();

                if (initialSearch && searchInput) {
                    searchInput.value = initialSearch;
                }

                // Appliquer filtres initiaux (ex: depuis URL)
                console.log('üîç Application des filtres initiaux...');
                applyFilters();
                
                console.log('‚úÖ Catalogue initialis√© avec succ√®s !');

            } catch (err) {
                console.error('‚ùå ERREUR FIRESTORE:', err);
                console.error('Message:', err.message);
                console.error('Code:', err.code);
                console.error('Stack:', err.stack);
                
                // Si c'est une erreur d'index manquant
                if (err.code === 'failed-precondition' || err.message.includes('index')) {
                    console.error('‚ö†Ô∏è INDEX MANQUANT D√âTECT√â !');
                    console.error('üëâ SOLUTION: Cliquez sur le lien dans l\'erreur ci-dessus pour cr√©er l\'index automatiquement.');
                    console.error('‚ÑπÔ∏è Firebase va vous rediriger vers la console pour g√©n√©rer l\'index composite requis.');
                    
                    catalogueGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #fff3cd; border-radius: 12px; border: 2px solid #ffc107;">
                            <i data-lucide="alert-triangle" style="width: 64px; height: 64px; color: #ffc107; margin-bottom: 20px;"></i>
                            <h3 style="color: #856404; font-weight: 700; margin-bottom: 10px;">Index Firestore Manquant</h3>
                            <p style="color: #856404; margin-bottom: 15px;">Une requ√™te n√©cessite un index composite.</p>
                            <p style="color: #856404; font-size: 14px; margin-bottom: 20px;">Ouvrez la console du navigateur (F12) et cliquez sur le lien d'erreur pour cr√©er l'index automatiquement.</p>
                            <button onclick="location.reload()" style="padding: 12px 24px; background: #ffc107; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Recharger la page
                            </button>
                        </div>
                    `;
                } else {
                    catalogueGrid.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                            <i data-lucide="alert-circle" style="width: 64px; height: 64px; color: #ef4444; margin-bottom: 20px;"></i>
                            <h3 style="color: #ef4444; font-weight: 600; margin-bottom: 10px;">Erreur de chargement</h3>
                            <p style="color: #999;">Impossible de charger le catalogue. V√©rifiez votre connexion.</p>
                            <button onclick="location.reload()" style="margin-top: 20px; padding: 12px 24px; background: #000; color: #fff; border: none; border-radius: 8px; cursor: pointer;">
                                R√©essayer
                            </button>
                        </div>
                    `;
                }
                
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        }

        // === RENDU DES FILTRES ===
        function renderCategoryFilters() {
            // Compter les produits par cat√©gorie
            const categoryCounts = {};
            allProducts.forEach(p => {
                const cat = p.category || 'Autre';
                categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
            });

            // G√©n√©rer toutes les cat√©gories dynamiquement (seulement celles qui ont des produits)
            categoryFilters.innerHTML = '';
            
            // Trier les cat√©gories par nombre de produits (d√©croissant)
            const sortedCategories = Object.entries(categoryCounts)
                .sort((a, b) => b[1] - a[1])
                .filter(([cat, count]) => count > 0); // Seulement les cat√©gories avec produits

            sortedCategories.forEach(([catName, count]) => {
                const catId = catName.toLowerCase().replace(/[^a-z0-9]/g, '-');
                categoryFilters.innerHTML += `
                    <div class="filter-checkbox">
                        <input type="checkbox" id="cat-${catId}" value="${catName}" class="category-filter">
                        <label for="cat-${catId}">
                            <span>${catName}</span>
                            <span class="filter-count">(${count})</span>
                        </label>
                    </div>
                `;
            });

            // R√©attacher les event listeners
            document.querySelectorAll('.category-filter').forEach(cb => {
                cb.addEventListener('change', applyFilters);
            });
        }

        function renderColorFilters() {
            const predefinedColors = ['#000000', '#FFFFFF', '#D4AF37', '#FF0000', '#0000FF', '#00FF00', '#FFC0CB', '#FFA500'];
            const colorNames = {
                '#000000': 'Noir',
                '#FFFFFF': 'Blanc',
                '#FF0000': 'Rouge',
                '#00FF00': 'Vert',
                '#0000FF': 'Bleu',
                '#FFFF00': 'Jaune',
                '#FFC0CB': 'Rose',
                '#FFA500': 'Orange',
                '#800080': 'Violet',
                '#A52A2A': 'Marron',
                '#808080': 'Gris',
                '#D4AF37': 'Or'
            };

            // Ajouter les couleurs dynamiques qui ne sont pas pr√©d√©finies
            colorFilters.innerHTML = '';
            allColors.forEach(color => {
                if (!predefinedColors.includes(color.toUpperCase())) {
                    const colorHex = color.startsWith('#') ? color : '#000000';
                    const colorName = colorNames[colorHex.toUpperCase()] || colorHex;
                    colorFilters.innerHTML += `
                        <div 
                            class="color-swatch" 
                            data-color="${color}"
                            style="background: ${colorHex};"
                            title="${colorName}"
                        ></div>
                    `;
                }
            });

            // Ajouter les event listeners sur tous les swatches (pr√©d√©finis + dynamiques)
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    applyFilters();
                });
            });
        }

        function renderLocationFilters() {
            // La localisation est maintenant g√©r√©e par le <select> directement dans le HTML
            // Pas besoin de rendu dynamique, juste ajouter l'event listener
            locationSelect.addEventListener('change', applyFilters);
        }

        // === RECHERCHE INTELLIGENTE (DEBOUNCE + AUTOCOMPLETE) ===
        searchInput.addEventListener('input', (e) => {
            const term = e.target.value.trim().toLowerCase();
            
            // Debounce 300ms
            clearTimeout(searchDebounceTimer);
            
            if (term.length >= 2) {
                searchDebounceTimer = setTimeout(() => {
                    showAutocomplete(term);
                }, 300);
            } else {
                hideAutocomplete();
                if (term.length === 0) {
                    applyFilters();
                }
            }
        });

        // Appliquer le filtre quand on appuie sur Entr√©e
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                hideAutocomplete();
                applyFilters();
            }
        });

        function showAutocomplete(term) {
            // Recherche intelligente sur name, keywords, category
            const matches = allProducts.filter(p => {
                const nameMatch = p.name && p.name.toLowerCase().includes(term);
                const keywordsMatch = p.keywords && Array.isArray(p.keywords) && 
                    p.keywords.some(kw => kw.toLowerCase().includes(term));
                const categoryMatch = p.category && p.category.toLowerCase().includes(term);
                const descMatch = p.description && p.description.toLowerCase().includes(term);
                
                return nameMatch || keywordsMatch || categoryMatch || descMatch;
            })
            .slice(0, 8)  // Limiter √† 8 r√©sultats
            .sort((a, b) => {
                // Priorit√© aux matchs exacts dans le nom
                const aExact = a.name.toLowerCase().startsWith(term) ? 1 : 0;
                const bExact = b.name.toLowerCase().startsWith(term) ? 1 : 0;
                return bExact - aExact;
            });

            if (matches.length === 0) {
                searchAutocomplete.innerHTML = `
                    <div class="autocomplete-no-results">
                        <i data-lucide="search-x" style="width: 32px; height: 32px; color: #ddd; margin-bottom: 10px;"></i>
                        <div>Aucun r√©sultat pour "${term}"</div>
                    </div>
                `;
                searchAutocomplete.classList.add('show');
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            searchAutocomplete.innerHTML = matches.map(p => {
                const price = new Intl.NumberFormat('fr-FR').format(p.price);
                // Highlight du terme recherch√©
                const highlightedName = p.name.replace(
                    new RegExp(term, 'gi'), 
                    match => `<mark style="background: #fff3cd; padding: 2px 4px; border-radius: 3px;">${match}</mark>`
                );
                
                return `
                    <div class="autocomplete-item" data-product-id="${p.id}">
                        <img src="${p.image || 'assets/img/placeholder-product-1.svg'}" 
                             class="autocomplete-img" 
                             alt="${p.name}"
                             onerror="this.src='assets/img/placeholder-product-1.svg'">
                        <div class="autocomplete-info">
                            <div class="autocomplete-name">${highlightedName}</div>
                            <div class="autocomplete-price">${price} FCFA</div>
                            ${p.category ? `<div style="font-size: 12px; color: #999; margin-top: 2px;">${p.category}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            searchAutocomplete.classList.add('show');

            // Clic sur suggestion
            document.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', () => {
                    const productId = item.dataset.productId;
                    window.location.href = `product.html?id=${productId}`;
                });
            });
        }

        function hideAutocomplete() {
            searchAutocomplete.classList.remove('show');
            searchAutocomplete.innerHTML = '';
        }

        // Cacher autocomplete au clic ailleurs
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !searchAutocomplete.contains(e.target)) {
                hideAutocomplete();
            }
        });

        // === LOGIQUE DE FILTRAGE (C√îT√â CLIENT) ===
        function applyFilters() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            
            // === FILTRAGE PRIX (C√îT√â CLIENT) ===
            // On r√©cup√®re les valeurs min/max depuis les inputs
            const minPrice = parseFloat(priceMin.value) || 0;
            const maxPrice = parseFloat(priceMax.value) || Infinity;

            // Cat√©gories s√©lectionn√©es
            const selectedCategories = Array.from(document.querySelectorAll('.category-filter:checked'))
                .map(cb => cb.value);

            // Notes s√©lectionn√©es
            const rating4Plus = document.getElementById('rating-4plus')?.checked;
            const rating3Plus = document.getElementById('rating-3plus')?.checked;

            // Couleurs s√©lectionn√©es
            const selectedColors = Array.from(document.querySelectorAll('.color-swatch.selected'))
                .map(s => s.dataset.color);

            // === LOCALISATION (C√îT√â CLIENT) ===
            const selectedLocation = locationSelect.value;

            // Tri
            const sortBy = sortSelect.value;

            // === FILTRAGE COMPLET C√îT√â CLIENT ===
            // IMPORTANT: Tout le filtrage se fait en JavaScript pour √©viter les index Firestore complexes
            let filtered = allProducts.filter(p => {
                // Recherche textuelle
                const matchSearch = searchTerm === '' || 
                    (p.name && p.name.toLowerCase().includes(searchTerm)) ||
                    (p.keywords && Array.isArray(p.keywords) && p.keywords.some(kw => kw.toLowerCase().includes(searchTerm))) ||
                    (p.category && p.category.toLowerCase().includes(searchTerm)) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm));

                // Filtrage prix (client-side)
                const productPrice = parseFloat(p.price) || 0;
                const matchPrice = productPrice >= minPrice && productPrice <= maxPrice;

                // Cat√©gorie
                const matchCategory = selectedCategories.length === 0 || 
                    selectedCategories.includes(p.category);

                // Note vendeur
                let matchRating = true;
                if (rating4Plus) {
                    matchRating = (p.shopRating || 0) >= 4;
                } else if (rating3Plus) {
                    matchRating = (p.shopRating || 0) >= 3;
                }

                // Couleur
                const matchColor = selectedColors.length === 0 ||
                    (p.colors && Array.isArray(p.colors) && p.colors.some(c => selectedColors.includes(c)));

                // Localisation (client-side)
                const matchLocation = selectedLocation === '' || p.shopCity === selectedLocation;

                return matchSearch && matchPrice && matchCategory && matchRating && matchColor && matchLocation;
            });

            console.log(`üîç Filtrage: ${filtered.length} produits trouv√©s sur ${allProducts.length}`);

            // === TRI ===
            if (sortBy === 'price-asc') {
                filtered.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (sortBy === 'price-desc') {
                filtered.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else if (sortBy === 'recent') {
                filtered.sort((a, b) => {
                    const dateA = a.createdAt?.seconds || 0;
                    const dateB = b.createdAt?.seconds || 0;
                    return dateB - dateA;
                });
            } else if (sortBy === 'popular') {
                filtered.sort((a, b) => (b.views || 0) - (a.views || 0));
            }

            // Afficher les filtres actifs
            renderActiveFilters({
                searchTerm,
                minPrice,
                maxPrice,
                selectedCategories,
                rating4Plus,
                rating3Plus,
                selectedColors,
                selectedLocation
            });

            renderProducts(filtered);
        }

        // === AFFICHAGE DES FILTRES ACTIFS ===
        function renderActiveFilters(filters) {
            activeFiltersDiv.innerHTML = '';
            let hasActiveFilters = false;

            if (filters.searchTerm) {
                activeFiltersDiv.innerHTML += `
                    <div class="filter-tag">
                        <i data-lucide="search" style="width: 14px; height: 14px;"></i>
                        "${filters.searchTerm}"
                        <i data-lucide="x" onclick="document.getElementById('search-input').value=''; applyFilters();"></i>
                    </div>
                `;
                hasActiveFilters = true;
            }

            const initialMinPrice = parseFloat(priceMin.placeholder) || 0;
            const initialMaxPrice = parseFloat(priceMax.placeholder) || Infinity;
            
            if (filters.minPrice > initialMinPrice || filters.maxPrice < initialMaxPrice) {
                const minDisplay = new Intl.NumberFormat('fr-FR').format(filters.minPrice);
                const maxDisplay = filters.maxPrice === Infinity ? '‚àû' : new Intl.NumberFormat('fr-FR').format(filters.maxPrice);
                
                activeFiltersDiv.innerHTML += `
                    <div class="filter-tag">
                        <i data-lucide="dollar-sign" style="width: 14px; height: 14px;"></i>
                        ${minDisplay} - ${maxDisplay} FCFA
                        <i data-lucide="x" onclick="resetPriceFilter()"></i>
                    </div>
                `;
                hasActiveFilters = true;
            }

            filters.selectedCategories.forEach(cat => {
                activeFiltersDiv.innerHTML += `
                    <div class="filter-tag">
                        <i data-lucide="grid" style="width: 14px; height: 14px;"></i>
                        ${cat}
                        <i data-lucide="x" onclick="uncheckCategory('${cat}')"></i>
                    </div>
                `;
                hasActiveFilters = true;
            });

            if (filters.rating4Plus) {
                activeFiltersDiv.innerHTML += `
                    <div class="filter-tag">
                        <i data-lucide="star" style="width: 14px; height: 14px;"></i>
                        4‚òÖ et plus
                        <i data-lucide="x" onclick="document.getElementById('rating-4plus').checked=false; applyFilters();"></i>
                    </div>
                `;
                hasActiveFilters = true;
            }

            if (filters.rating3Plus) {
                activeFiltersDiv.innerHTML += `
                    <div class="filter-tag">
                        <i data-lucide="star" style="width: 14px; height: 14px;"></i>
                        3‚òÖ et plus
                        <i data-lucide="x" onclick="document.getElementById('rating-3plus').checked=false; applyFilters();"></i>
                    </div>
                `;
                hasActiveFilters = true;
            }

            if (filters.selectedLocation) {
                activeFiltersDiv.innerHTML += `
                    <div class="filter-tag">
                        <i data-lucide="map-pin" style="width: 14px; height: 14px;"></i>
                        ${filters.selectedLocation}
                        <i data-lucide="x" onclick="document.getElementById('location-select').value=''; applyFilters();"></i>
                    </div>
                `;
                hasActiveFilters = true;
            }

            if (hasActiveFilters && typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // === RENDU DES PRODUITS ===
        function renderProducts(products) {
            catalogueGrid.innerHTML = '';

            if (products.length === 0) {
                catalogueGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px;">
                        <i data-lucide="search-x" style="width: 64px; height: 64px; color: #ddd; margin-bottom: 20px;"></i>
                        <h3 style="color: #999; font-weight: 600; margin-bottom: 10px;">Aucun produit trouv√©</h3>
                        <p style="color: #bbb; margin-bottom: 20px;">Essayez de modifier vos crit√®res de recherche.</p>
                        <button onclick="document.getElementById('reset-filters').click()" 
                                style="padding: 10px 20px; background: #D4AF37; color: #000; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            R√©initialiser les filtres
                        </button>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                return;
            }

            products.forEach(p => {
                const price = new Intl.NumberFormat('fr-FR').format(p.price || 0);
                const hasDiscount = p.originalPrice && p.originalPrice > p.price;
                const discountPercent = hasDiscount ? Math.round(((p.originalPrice - p.price) / p.originalPrice) * 100) : 0;
                
                catalogueGrid.innerHTML += `
                    <div class="card" style="border:1px solid #eee; border-radius:12px; overflow:hidden; transition: transform 0.2s, box-shadow 0.2s; position: relative;">
                        ${hasDiscount ? `<div style="position: absolute; top: 10px; right: 10px; background: #ef4444; color: #fff; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 700; z-index: 10;">-${discountPercent}%</div>` : ''}
                        
                        <a href="product.html?id=${p.id}" style="text-decoration: none;">
                            <div style="height:250px; overflow:hidden; background: #f5f5f5; position: relative;">
                                <img src="${p.image || 'assets/img/placeholder-product-1.svg'}" 
                                     style="width:100%; height:100%; object-fit:cover; transition: transform 0.3s;"
                                     loading="lazy"
                                     alt="${p.name || 'Produit'}"
                                     onerror="this.src='assets/img/placeholder-product-1.svg'"
                                     onmouseover="this.style.transform='scale(1.05)'"
                                     onmouseout="this.style.transform='scale(1)'">
                            </div>
                        </a>
                        
                        <div style="padding:15px;">
                            <div style="font-size:11px; color:#888; text-transform:uppercase; margin-bottom:5px; display: flex; align-items: center; justify-content: space-between;">
                                <a href="boutique.html?id=${p.shopId}" style="text-decoration:none; color:#888; display: flex; align-items: center; gap: 4px;">
                                    <i data-lucide="store" style="width:12px; height:12px;"></i>
                                    ${p.shopName || 'Boutique'}
                                </a>
                                ${(p.shopRating || 0) >= 4 ? '<span style="color:#D4AF37; font-size: 14px;">‚≠ê</span>' : ''}
                            </div>
                            
                            <h3 style="font-size:16px; margin:8px 0; line-height: 1.3; min-height: 42px;">
                                <a href="product.html?id=${p.id}" style="color:black; text-decoration:none; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                                    ${p.name || 'Produit sans nom'}
                                </a>
                            </h3>
                            
                            <div style="display: flex; align-items: center; gap: 8px; margin-top:8px;">
                                <div style="font-weight:bold; color:#D4AF37; font-size: 18px;">${price} FCFA</div>
                                ${hasDiscount ? `<div style="font-size: 14px; color: #999; text-decoration: line-through;">${new Intl.NumberFormat('fr-FR').format(p.originalPrice)} FCFA</div>` : ''}
                            </div>
                            
                            ${p.shopCity ? `<div style="font-size:12px; color:#999; margin-top:6px; display: flex; align-items: center; gap: 4px;"><i data-lucide="map-pin" style="width:12px; height:12px;"></i>${p.shopCity}</div>` : ''}
                        </div>
                    </div>
                `;
            });

            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // === GESTION DES SLIDERS PRIX ===
        priceMin.addEventListener('input', () => {
            priceRangeMin.value = priceMin.value;
            applyFilters();
        });

        priceMax.addEventListener('input', () => {
            priceRangeMax.value = priceMax.value;
            applyFilters();
        });

        priceRangeMin.addEventListener('input', () => {
            priceMin.value = priceRangeMin.value;
            applyFilters();
        });

        priceRangeMax.addEventListener('input', () => {
            priceMax.value = priceRangeMax.value;
            applyFilters();
        });

        // === TRI ===
        sortSelect.addEventListener('change', applyFilters);

        // === R√âINITIALISATION ===
        resetFiltersBtn.addEventListener('click', (e) => {
            e.preventDefault();
            
            // Reset tous les filtres
            searchInput.value = '';
            document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
            locationSelect.value = '';
            document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('selected'));
            if (document.getElementById('rating-4plus')) document.getElementById('rating-4plus').checked = false;
            if (document.getElementById('rating-3plus')) document.getElementById('rating-3plus').checked = false;
            
            const prices = allProducts.map(p => p.price || 0);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            priceMin.value = minPrice;
            priceMax.value = maxPrice;
            priceRangeMin.value = minPrice;
            priceRangeMax.value = maxPrice;

            applyFilters();
        });

        // === MOBILE FILTERS TOGGLE ===
        toggleFiltersBtn?.addEventListener('click', () => {
            filtersSidebar.classList.add('open');
            filtersOverlay.classList.add('show');
        });

        filtersOverlay?.addEventListener('click', () => {
            filtersSidebar.classList.remove('open');
            filtersOverlay.classList.remove('show');
        });

        // === FONCTIONS GLOBALES (pour onclick) ===
        window.toggleFilterGroup = (element) => {
            const filterGroup = element.closest('.filter-group');
            filterGroup.classList.toggle('collapsed');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        };

        window.resetPriceFilter = () => {
            const prices = allProducts.map(p => p.price || 0).filter(p => p > 0);
            const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
            const maxPrice = prices.length > 0 ? Math.max(...prices) : 1000000;
            
            priceMin.value = minPrice;
            priceMax.value = maxPrice;
            priceRangeMin.value = minPrice;
            priceRangeMax.value = maxPrice;
            applyFilters();
        };

        window.uncheckCategory = (catName) => {
            const checkbox = Array.from(document.querySelectorAll('.category-filter'))
                .find(cb => cb.value === catName);
            if (checkbox) {
                checkbox.checked = false;
                applyFilters();
            }
        };

        // Rendre applyFilters accessible globalement
        window.applyFilters = applyFilters;

        // Initialiser Lucide Icons
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
  </script>
  <script src="assets/js/footer.js" defer></script>
</body>
</html>