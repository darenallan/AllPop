<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Aurum Admin - Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="stylesheet" href="assets/css/styles.css" />

    <style>
        /* LAYOUT PC FORCE */
        @media (min-width: 900px) {
            body.admin-layout {
                display: grid !important;
                grid-template-columns: 260px 1fr !important;
                min-height: 100vh;
                margin: 0; padding: 0;
                overflow: hidden;
                background-color: #F9F7F2;
            }
            .admin-sidebar {
                display: flex !important;
                flex-direction: column;
                background-color: #050505 !important;
                color: #fff;
                height: 100vh;
                position: relative !important;
                z-index: 100;
                border-right: 1px solid rgba(212, 175, 55, 0.1);
            }
            .admin-main {
                height: 100vh;
                overflow-y: auto;
                padding: 40px 50px !important;
                background-color: #F9F7F2;
            }
            .admin-mobile-toggle { display: none !important; }
        }

        /* STYLES GÉNÉRAUX */
        .admin-sidebar-header { padding: 40px 30px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .admin-sidebar-title { font-family: 'Playfair Display', serif; color: #D4AF37; font-size: 28px; margin: 0; }
        
        .admin-nav-item {
            display: flex; align-items: center; gap: 15px; padding: 16px 30px;
            color: #a0a0a0; text-decoration: none; font-family: 'Inter', sans-serif;
            font-size: 15px; transition: 0.3s; cursor: pointer; border-left: 3px solid transparent;
        }
        .admin-nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
        .admin-nav-item.active {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%);
            color: #D4AF37; border-left-color: #D4AF37;
        }

        .admin-page-title { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 10px; color: #111; }
        .admin-card { background: #fff; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 30px; }
        
        /* Formulaires */
        .input, select.input { width: 100%; padding: 12px 18px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; display: block; box-sizing: border-box; background: #fff; color: #000; }
        .btn-gold { background: #D4AF37; color: #000; font-weight: 600; padding: 14px 30px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        .btn-gold:hover { background: #bfa030; }

        /* Listes */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #eee; }
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: bold; background: #e6fffa; color: #007a5e; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: #fff; padding: 25px; border-radius: 12px; border-left: 5px solid #D4AF37; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .stat-val { font-size: 32px; font-weight: 700; font-family: 'Playfair Display'; margin-top: 5px; color: #000; }
        .stat-label { text-transform: uppercase; font-size: 12px; color: #666; }

        /* Utilitaire */
        .hidden { display: none !important; }
        .active-section { display: block !important; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
        
        /* Mobile */
        @media (max-width: 899px) {
            body.admin-layout { display: block !important; }
            .admin-sidebar { display: none; position: fixed; inset: 0; }
            .admin-sidebar.mobile-open { display: flex !important; }
            .admin-main { padding: 20px; padding-top: 80px; }
            .admin-mobile-toggle { display: flex !important; position: fixed; top: 15px; right: 15px; background: #D4AF37; padding: 10px; border-radius: 50%; z-index: 2000; border: none; }
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>
<body class="admin-layout">

    <aside class="admin-sidebar" id="admin-sidebar">
        <div class="admin-sidebar-header">
            <h1 class="admin-sidebar-title">Aurum</h1>
        </div>
        <nav>
            <div class="admin-nav-item active" onclick="nav('dashboard', this)">
                <i data-lucide="layout-dashboard"></i> Tableau de bord
            </div>
            <div class="admin-nav-item" onclick="nav('sellers', this)">
                <i data-lucide="user-plus"></i> Créer Vendeur
            </div>
            <div class="admin-nav-item" onclick="nav('shops', this)">
                <i data-lucide="store"></i> Boutiques
            </div>
            <div class="admin-nav-item" onclick="nav('categories', this)">
                <i data-lucide="tag"></i> Catégories
            </div>
            <div class="admin-nav-item" onclick="nav('users', this)">
                <i data-lucide="users"></i> Comptes
            </div>
            <div class="admin-nav-item" onclick="nav('promos', this)">
                <i data-lucide="percent"></i> Codes Promo
            </div>
            <a href="index.html" class="admin-nav-item" style="margin-top:auto; color:#ff6b6b; border-top:1px solid #333;">
                <i data-lucide="log-out"></i> Quitter
            </a>
        </nav>
    </aside>

    <button class="admin-mobile-toggle" onclick="document.getElementById('admin-sidebar').classList.toggle('mobile-open')">
        <i data-lucide="menu"></i>
    </button>

    <main class="admin-main">
        
        <div id="loader" style="text-align:center; margin-top:20%;">
            <p>Chargement des données...</p>
        </div>

        <div id="dashboard-content" class="hidden">

            <section id="sec-dashboard" class="admin-section active-section">
                <h1 class="admin-page-title">Tableau de Bord</h1>
                <div class="stats-grid" id="stats-container">
                    </div>
                <div class="admin-card">
                    <h3>Activité Récente</h3>
                    <p style="color:#666;">Système synchronisé avec la base de données.</p>
                </div>
            </section>

            <section id="sec-sellers" class="admin-section hidden">
                <h1 class="admin-page-title">Créer Vendeur</h1>
                <div class="admin-card">
                    <form id="form-seller">
                        <label>Nom Complet</label>
                        <input class="input" id="sel-name" required placeholder="Ex: Jean Dupont">
                        <label>Email</label>
                        <input class="input" id="sel-email" type="email" required placeholder="email@vendeur.com">
                        <label>Téléphone</label>
                        <input class="input" id="sel-phone" required placeholder="+226 XX XX XX XX">
                        <label>Mot de passe</label>
                        <input class="input" id="sel-pass" required placeholder="******">
                        <button class="btn-gold">Créer le compte</button>
                    </form>
                </div>
            </section>

            <section id="sec-shops" class="admin-section hidden">
                <h1 class="admin-page-title">Boutiques</h1>
                <div class="admin-card">
                    <h3>Nouvelle Boutique</h3>
                    <form id="form-shop">
                        <input class="input" id="shop-name" placeholder="Nom de la boutique" required>
                        <input class="input" id="shop-owner" placeholder="Email du Propriétaire" required>
                        <select class="input" id="shop-cat-select" required></select>
                        <input class="input" id="shop-desc" placeholder="Description courte">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                            <input class="input" type="number" id="shop-duration" value="30" placeholder="Durée (jours)">
                            <input class="input" type="number" id="shop-limit" value="50" placeholder="Limite articles">
                        </div>
                        <button class="btn-gold">Ajouter la boutique</button>
                    </form>
                </div>
                <div class="admin-card">
                    <h3>Liste des Boutiques</h3>
                    <div id="shops-list">Chargement...</div>
                </div>
            </section>

            <section id="sec-categories" class="admin-section hidden">
                <h1 class="admin-page-title">Catégories</h1>
                <div class="admin-card">
                    <form id="form-cat" style="display:flex; gap:10px; margin-bottom:20px;">
                        <input class="input" id="cat-name" placeholder="Nouvelle catégorie" style="margin:0;">
                        <button class="btn-gold" style="width:auto; margin:0;">Ajouter</button>
                    </form>
                    <div id="categories-list"></div>
                </div>
            </section>

            <section id="sec-users" class="admin-section hidden">
                <h1 class="admin-page-title">Comptes Utilisateurs</h1>
                <div class="admin-card" id="users-list">Chargement...</div>
            </section>

            <section id="sec-promos" class="admin-section hidden">
                <h1 class="admin-page-title">Codes Promo</h1>
                <div class="admin-card">
                    <form id="form-promo" style="display:flex; gap:10px; margin-bottom:20px;">
                        <input class="input" id="promo-code" placeholder="CODE" style="margin:0;">
                        <input class="input" id="promo-val" type="number" placeholder="%" style="width:80px; margin:0;">
                        <button class="btn-gold" style="width:auto; margin:0;">Créer</button>
                    </form>
                    <div id="promos-list"></div>
                </div>
            </section>

        </div>
    </main>

    <script>
        // 1. CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyBGmPM4OXEonp7qL78x20NC2DXvQW0lavU",
            authDomain: "aurum-bf.firebaseapp.com",
            projectId: "aurum-bf",
            storageBucket: "aurum-bf.firebasestorage.app",
            messagingSenderId: "858318726586",
            appId: "1:858318726586:web:14687fff6d4d08527a6983",
            measurementId: "G-SY7DY6WV97"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // 2. DONNÉES DE DÉMARRAGE (Injection si vide)
        const SEED = {
            cats: [
                { name: "Mode & Vêtements", icon: "shirt" },
                { name: "Véhicules & Pièces", icon: "car" },
                { name: "Maison & Déco", icon: "home" },
                { name: "Électronique", icon: "smartphone" },
                { name: "Beauté & Hygiène", icon: "sparkles" }
            ],
            shops: [
                { name: "Luxe Motors", ownerEmail: "vente.lll@gmail.com", category: "Véhicules & Pièces", status: "Active", itemLimit: 50 },
                { name: "Boutique Faso", ownerEmail: "client.add@gmail.com", category: "Mode & Vêtements", status: "Active", itemLimit: 100 }
            ],
            users: [
                { name: "Super Admin", email: "aurumcorporate.d@gmail.com", role: "superadmin" },
                { name: "Vendeur Test", email: "vente.lll@gmail.com", role: "seller" }
            ],
            promos: [
                { code: "AURUM10", percent: 10, status: "Active" }
            ]
        };

        // 3. LOGIQUE PRINCIPALE
        document.addEventListener('DOMContentLoaded', () => {
            
            // Auth Listener
            auth.onAuthStateChanged((user) => {
                // Pour le test, on autorise l'affichage même si pas connecté en tant que "Admin Suprême"
                // pour que tu voies le résultat tout de suite.
                if (true) { // user && ... (Remettre la sécu plus tard)
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('dashboard-content').classList.remove('hidden');
                    
                    // Lancer la migration et l'écoute
                    checkAndSeed();
                    listenRealTime();
                } else {
                    window.location.href = "login.html";
                }
            });
            
            lucide.createIcons();
        });

        // 4. MIGRATION AUTOMATIQUE
        async function checkAndSeed() {
            const snap = await db.collection('categories').get();
            if (snap.empty) {
                console.log("⚡ Injection des données...");
                SEED.cats.forEach(c => db.collection('categories').add(c));
                SEED.shops.forEach(s => db.collection('shops').add({...s, createdAt: new Date()}));
                SEED.users.forEach(u => db.collection('users').add({...u, createdAt: new Date()}));
                SEED.promos.forEach(p => db.collection('promos').add({...p, createdAt: new Date()}));
                alert("Données restaurées dans Firebase !");
            }
        }

        // 5. ÉCOUTE TEMPS RÉEL (Affichage)
        function listenRealTime() {
            
            // Boutiques
            db.collection('shops').onSnapshot(snap => {
                const list = document.getElementById('shops-list');
                let count = 0;
                list.innerHTML = "";
                snap.forEach(doc => {
                    count++;
                    const s = doc.data();
                    list.innerHTML += `
                    <div class="list-item">
                        <div>
                            <strong>${s.name}</strong><br>
                            <span style="font-size:13px; color:#777;">${s.category} • ${s.ownerEmail}</span>
                        </div>
                        <div style="text-align:right;">
                            <span class="status-badge">${s.status}</span><br>
                            <button onclick="del('shops','${doc.id}')" style="color:red; border:none; background:none; cursor:pointer; font-size:12px; margin-top:5px;">Supprimer</button>
                        </div>
                    </div>`;
                });
                updateStat(0, "Boutiques", count);
            });

            // Catégories
            db.collection('categories').onSnapshot(snap => {
                const list = document.getElementById('categories-list');
                const select = document.getElementById('shop-cat-select');
                list.innerHTML = "";
                select.innerHTML = "<option>Choisir...</option>";
                
                snap.forEach(doc => {
                    const c = doc.data();
                    list.innerHTML += `<div class="list-item"><b>${c.name}</b> <button onclick="del('categories','${doc.id}')" style="color:red; border:none; background:none;">X</button></div>`;
                    select.innerHTML += `<option value="${c.name}">${c.name}</option>`;
                });
            });

            // Users
            db.collection('users').onSnapshot(snap => {
                const list = document.getElementById('users-list');
                let count = 0;
                list.innerHTML = "";
                snap.forEach(doc => {
                    count++;
                    const u = doc.data();
                    list.innerHTML += `<div class="list-item"><div><strong>${u.name}</strong><br>${u.email}</div><span class="status-badge" style="background:#eee; color:#333;">${u.role}</span></div>`;
                });
                updateStat(1, "Utilisateurs", count);
            });

            // Promos & Ventes (Ventes simulées à 1886)
            db.collection('promos').onSnapshot(snap => {
                document.getElementById('promos-list').innerHTML = snap.docs.map(d => `<div class="list-item"><b>${d.data().code}</b> <button onclick="del('promos','${d.id}')" style="color:red; border:none; background:none;">X</button></div>`).join('');
                updateStat(2, "Ventes (Total)", "1 886"); 
            });
        }

        // Helper Stats
        function updateStat(index, label, val) {
            const container = document.getElementById('stats-container');
            // On s'assure qu'il y a assez de cartes
            while(container.children.length <= index) {
                container.innerHTML += `<div class="stat-card"><div class="stat-label"></div><div class="stat-val">0</div></div>`;
            }
            const card = container.children[index];
            card.querySelector('.stat-label').innerText = label;
            card.querySelector('.stat-val').innerText = val;
        }

        // 6. GESTION NAVIGATION
        window.nav = function(id, btn) {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active-section'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            document.getElementById('sec-'+id).classList.add('active-section');
            
            document.querySelectorAll('.admin-nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // Fermer mobile
            if(window.innerWidth < 900) document.getElementById('admin-sidebar').classList.remove('mobile-open');
        };

        // 7. ACTIONS FORMULAIRES
        document.getElementById('form-shop').onsubmit = (e) => {
            e.preventDefault();
            db.collection('shops').add({
                name: document.getElementById('shop-name').value,
                ownerEmail: document.getElementById('shop-owner').value,
                category: document.getElementById('shop-cat-select').value,
                description: document.getElementById('shop-desc').value,
                status: 'Active',
                createdAt: new Date()
            });
            e.target.reset();
            alert("Boutique ajoutée !");
        };

        document.getElementById('form-seller').onsubmit = (e) => {
            e.preventDefault();
            const email = document.getElementById('sel-email').value;
            const pass = document.getElementById('sel-pass').value;
            const name = document.getElementById('sel-name').value;
            
            // Création Auth
            auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                // Sauvegarde DB
                db.collection('users').add({
                    name: name, email: email, phone: document.getElementById('sel-phone').value, role: 'seller', createdAt: new Date()
                });
                alert("Vendeur créé !");
                e.target.reset();
            }).catch(err => alert("Erreur: " + err.message));
        };

        document.getElementById('form-cat').onsubmit = (e) => {
            e.preventDefault();
            db.collection('categories').add({ name: document.getElementById('cat-name').value, icon: 'tag' });
            e.target.reset();
        };

        document.getElementById('form-promo').onsubmit = (e) => {
            e.preventDefault();
            db.collection('promos').add({ code: document.getElementById('promo-code').value, percent: document.getElementById('promo-val').value });
            e.target.reset();
        };

        // Delete Global
        window.del = (col, id) => {
            if(confirm("Supprimer ?")) db.collection(col).doc(id).delete();
        };

    </script>
</body>
</html>
