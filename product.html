<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Détails Produit - Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="assets/js/auth.js"></script>
  <script src="assets/js/app.js" defer></script>

  <style>
      /* --- Styles existants (layout) --- */
      .product-container { padding-top: 40px; padding-bottom: 80px; }
      .product-layout { display: grid; grid-template-columns: 1.2fr 1fr; gap: 60px; margin-bottom: 80px; }
      .gallery-main { width: 100%; height: 500px; background: #f9f9f9; border-radius: 20px; overflow: hidden; margin-bottom: 16px; display: flex; align-items: center; justify-content: center; }
      .gallery-main img { width: 100%; height: 100%; object-fit: contain; }
      .gallery-thumbs { display: flex; gap: 12px; }
      .thumb { width: 80px; height: 80px; border-radius: 12px; background: #f5f5f5; cursor: pointer; overflow: hidden; border: 2px solid transparent; transition: 0.2s; }
      .thumb.active { border-color: var(--gold); }
      .thumb img { width: 100%; height: 100%; object-fit: cover; }
      .product-info h1 { font-size: 42px; margin-bottom: 10px; line-height: 1.1; }
      .product-price-xl { font-size: 28px; color: var(--gold); font-weight: 700; margin-bottom: 24px; font-family: var(--font-sans); }
      .seller-link { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; color: #666; margin-bottom: 16px; text-decoration: none; }
      .seller-link:hover { color: var(--black); }
      .qty-selector { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 8px; width: fit-content; }
      .qty-btn { padding: 12px 16px; background: transparent; border: none; cursor: pointer; font-size: 18px; }
      .qty-value { font-weight: 600; width: 30px; text-align: center; }
      .action-row { display: flex; gap: 16px; margin-top: 30px; }
      .reviews-section { background: #f9f9f9; padding: 60px; border-radius: 20px; }
      .review-card { background: white; padding: 24px; border-radius: 16px; margin-bottom: 16px; }
      @media (max-width: 900px) { .product-layout { grid-template-columns: 1fr; gap: 30px; } .gallery-main { height: 350px; } .product-info h1 { font-size: 32px; } .reviews-section { padding: 20px; } }

      /* --- NOUVEAUX STYLES POUR LES AVIS --- */
      .star-picker-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #ddd; transition: 0.2s; padding: 0 5px; }
      .star-picker-btn.active, .star-picker-btn:hover { color: var(--gold); }
      #review-form-container { background: #fff; padding: 30px; border-radius: 16px; margin-bottom: 30px; border: 1px solid #eee; }
  </style>
</head>

<body>
  <header id="app-header" class="header">
      <div class="container navbar">
          <a href="index.html" class="brand">
              <span class="brand-name">AURUM</span>
          </a>
          <nav class="nav-actions">
              <a href="catalogue.html" class="icon-btn"><i data-lucide="search"></i></a>
              <a href="cart.html" class="icon-btn" style="position:relative;">
                  <i data-lucide="shopping-bag"></i>
                  <span class="badge" id="cart-badge" style="display:none;">0</span>
              </a>
              <button class="menu-toggle" id="menu-toggle"><i data-lucide="menu"></i></button>
          </nav>
      </div>
  </header>

  <div class="mobile-drawer" id="mobile-drawer">
      <div class="drawer-header">
          <span class="drawer-title">Menu</span>
          <button class="close-btn" id="close-btn"><i data-lucide="x"></i></button>
      </div>
      <nav class="drawer-nav">
          <a href="index.html" class="drawer-link"><i data-lucide="home"></i> Accueil</a>
          <a href="catalogue.html" class="drawer-link"><i data-lucide="grid"></i> Catalogue</a>
          <a href="cart.html" class="drawer-link"><i data-lucide="shopping-bag"></i> Panier</a>
      </nav>
  </div>
  <div id="menu-overlay"></div>

  <main class="container product-container">
    
    <div id="loading" style="text-align:center; padding:100px;">
        <i data-lucide="loader" class="spin" style="animation:spin 1s linear infinite; width:40px; height:40px;"></i>
    </div>

    <div id="product-content" style="display:none;">
        
        <div class="product-layout">
            <div class="product-gallery">
                <div class="gallery-main">
                    <img id="p-main-img" src="" alt="Produit">
                </div>
                <div class="gallery-thumbs" id="p-thumbs"></div>
            </div>

            <div class="product-info">
                <a href="#" id="p-seller-link" class="seller-link">
                    <i data-lucide="store" style="width:16px;"></i> <span id="p-seller-name">...</span>
                </a>
                <h1 id="p-name">...</h1>
                <div class="product-price-xl" id="p-price">... FCFA</div>
                <p id="p-desc" style="color:#555; line-height:1.8; margin-bottom:30px;">Chargement...</p>

                <div style="margin-bottom: 20px;">
                    <label style="display:block; font-size:13px; font-weight:600; margin-bottom:8px;">Quantité</label>
                    <div class="qty-selector">
                        <button class="qty-btn" onclick="updateQty(-1)">-</button>
                        <span class="qty-value" id="qty-val">1</span>
                        <button class="qty-btn" onclick="updateQty(1)">+</button>
                    </div>
                </div>

                <div class="action-row">
                    <button id="btn-add-cart" class="btn btn-gold btn-xl" style="flex:1;">Ajouter au panier</button>
                    <button class="btn btn-outline btn-xl"><i data-lucide="heart"></i></button>
                </div>

                <div style="margin-top:40px; border-top:1px solid #eee; padding-top:20px;">
                    <div style="display:flex; gap:15px; margin-bottom:15px;">
                        <i data-lucide="truck" style="color:var(--gold);"></i>
                        <div><strong style="display:block; font-size:14px;">Livraison Rapide</strong><span style="font-size:13px; color:#666;">Expédié sous 24h-48h</span></div>
                    </div>
                    <div style="display:flex; gap:15px;">
                        <i data-lucide="shield-check" style="color:var(--gold);"></i>
                        <div><strong style="display:block; font-size:14px;">Garantie Qualité</strong><span style="font-size:13px; color:#666;">Authenticité garantie</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="reviews-section" id="reviews-anchor">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                <h2 style="margin:0;">Avis Clients</h2>
                <div style="text-align:right;">
                    <div style="font-size:24px; font-weight:700; color:var(--gold);">
                        <span id="avg-rating-display">-</span> <span style="font-size:16px; color:#000;">/ 5</span>
                    </div>
                    <small style="color:#666;" id="total-reviews-display">(0 avis)</small>
                </div>
            </div>

            <button class="btn-outline" id="btn-toggle-review" style="margin-bottom: 20px;">Écrire un avis</button>

            <div id="review-form-container" style="display:none;">
                <h3 style="margin-top:0;">Votre avis compte</h3>
                <form id="review-form">
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Note</label>
                        <div class="star-picker">
                            <button type="button" class="star-picker-btn" data-value="1">★</button>
                            <button type="button" class="star-picker-btn" data-value="2">★</button>
                            <button type="button" class="star-picker-btn" data-value="3">★</button>
                            <button type="button" class="star-picker-btn" data-value="4">★</button>
                            <button type="button" class="star-picker-btn" data-value="5">★</button>
                        </div>
                        <input type="hidden" id="review-rating" value="0" required>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <label style="display:block; font-weight:600; margin-bottom:5px;">Commentaire</label>
                        <textarea class="input" id="review-comment" rows="4" placeholder="Partagez votre expérience..." required></textarea>
                    </div>

                    <button type="submit" class="btn btn-gold">Publier l'avis</button>
                </form>
            </div>

            <div id="reviews-list">
                <p>Chargement des avis...</p>
            </div>
        </div>

        <section class="section">
            <h2 class="section-title">Vous aimerez aussi</h2>
            <div id="similar-products" class="grid grid-4"></div>
        </section>

    </div>
  </main>

  <footer class="footer">
      <div class="container text-center"><p>&copy; 2026 Aurum Marketplace</p></div>
  </footer>

  <div class="toast-container" id="toast-container"></div>

<script>
    let currentProduct = null;
    let currentQty = 1;
    let selectedRating = 0; 

    document.addEventListener('DOMContentLoaded', () => {
        // Vérification de sécurité pour Firebase
        if (typeof firebase === 'undefined') {
            console.error("Firebase n'est pas chargé !");
            document.getElementById('loading').innerHTML = "<p style='color:red'>Erreur technique : Firebase manquant.</p>";
            return;
        }

        const db = firebase.firestore();
        const auth = firebase.auth();
        const params = new URLSearchParams(window.location.search);
        const productId = params.get('id');

        console.log("ID Produit demandé :", productId); // Debug

        if (!productId) {
            document.getElementById('loading').innerHTML = "<p>Aucun produit spécifié.</p><a href='catalogue.html' class='btn btn-outline'>Retour au catalogue</a>";
            return;
        }

        // 1. CHARGER LE PRODUIT
        db.collection('products').doc(productId).get()
        .then(doc => {
            if (doc.exists) {
                console.log("Produit trouvé :", doc.data()); // Debug
                currentProduct = { id: doc.id, ...doc.data() };
                renderProductPage(currentProduct);
                
                // Charger les infos complémentaires
                if(currentProduct.category) loadSimilarProducts(currentProduct.category);
                loadReviews(productId);
            } else {
                console.warn("Produit introuvable dans la base.");
                document.getElementById('loading').innerHTML = "<p>Ce produit n'existe plus.</p><a href='catalogue.html' class='btn btn-outline'>Retour au catalogue</a>";
            }
        })
        .catch(err => {
            console.error("Erreur chargement produit :", err);
            document.getElementById('loading').innerHTML = "<p style='color:red'>Erreur de chargement. Vérifiez votre connexion.</p>";
        });

        // --- FONCTIONS D'AFFICHAGE ---
        function renderProductPage(p) {
            // Cacher le loader
            document.getElementById('loading').style.display = 'none';
            // Afficher le contenu
            document.getElementById('product-content').style.display = 'block';

            // Remplir les textes (avec sécurité si champ manquant)
            document.getElementById('p-name').innerText = p.name || "Produit sans nom";
            document.getElementById('p-price').innerText = new Intl.NumberFormat('fr-FR').format(p.price || 0) + " FCFA";
            document.getElementById('p-desc').innerText = p.description || "Aucune description disponible.";
            
            // Lien Vendeur
            const sellerName = p.shopName || "Boutique Partenaire";
            document.getElementById('p-seller-name').innerText = sellerName;
            // Lien vers la boutique (si shopId existe)
            const shopLink = document.getElementById('p-seller-link');
            if(p.shopId) {
                shopLink.href = `boutique.html?id=${p.shopId}`;
            } else {
                shopLink.style.pointerEvents = "none"; // Désactive le lien si pas d'ID
                shopLink.style.color = "#999";
            }
            
            // Afficher la note moyenne
            updateRatingDisplay(p.rating, p.reviewCount);

            // Galerie Images
            const mainImg = document.getElementById('p-main-img');
            const thumbsContainer = document.getElementById('p-thumbs');
            const primarySrc = p.image || 'assets/img/placeholder.png';
            
            // Image principale par défaut
            mainImg.src = primarySrc;
            mainImg.onerror = function() { this.src = 'assets/img/placeholder.png'; }; // Fallback si erreur lien

            // Vider les miniatures avant de remplir
            thumbsContainer.innerHTML = "";

            // Générer les miniatures
            // On combine l'image principale et le tableau d'images secondaires
            let allImages = [];
            if(p.image) allImages.push(p.image);
            if(p.images && Array.isArray(p.images)) allImages = [...allImages, ...p.images];
            
            // Dédoublonner
            allImages = [...new Set(allImages)];

            if (allImages.length > 0) {
                allImages.forEach((src, index) => {
                    const thumb = document.createElement('div');
                    thumb.className = `thumb ${index === 0 ? 'active' : ''}`;
                    thumb.innerHTML = `<img src="${src}" onclick="switchImage('${src}', this)">`;
                    thumbsContainer.appendChild(thumb);
                });
            } else {
                thumbsContainer.innerHTML = `<div class="thumb active"><img src="${primarySrc}"></div>`;
            }

            // Mettre à jour le titre de l'onglet
            document.title = `${p.name} - Aurum`;
            
            // Initialiser les icônes
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function updateRatingDisplay(rating, count) {
            const avgDisplay = document.getElementById('avg-rating-display');
            const totalDisplay = document.getElementById('total-reviews-display');
            
            if (rating) {
                avgDisplay.innerText = rating.toFixed(1);
            } else {
                avgDisplay.innerText = "-";
            }
            
            if (count) {
                totalDisplay.innerText = `(${count} avis)`;
            } else {
                 totalDisplay.innerText = `(0 avis)`;
            }
        }

        // --- GESTION DES AVIS ---
        const formContainer = document.getElementById('review-form-container');
        const btnToggleReview = document.getElementById('btn-toggle-review');
        
        if(btnToggleReview) {
            btnToggleReview.addEventListener('click', () => {
                if(!auth.currentUser) {
                    alert("Veuillez vous connecter pour laisser un avis.");
                    // Redirection vers login avec retour
                    window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
                    return;
                }
                formContainer.style.display = formContainer.style.display === 'none' ? 'block' : 'none';
            });
        }

        // Sélecteur d'étoiles
        const starBtns = document.querySelectorAll('.star-picker-btn');
        starBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                selectedRating = parseInt(e.target.dataset.value);
                document.getElementById('review-rating').value = selectedRating;
                starBtns.forEach((b, index) => {
                    if(index < selectedRating) b.classList.add('active');
                    else b.classList.remove('active');
                });
            });
        });

        // Soumission Avis
        const reviewForm = document.getElementById('review-form');
        if(reviewForm) {
            reviewForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if(selectedRating === 0) { alert("Veuillez sélectionner une note."); return; }
                
                const user = auth.currentUser;
                const comment = document.getElementById('review-comment').value;
                const submitBtn = e.target.querySelector('button[type="submit"]');

                submitBtn.disabled = true;
                submitBtn.innerText = "Envoi...";

                db.collection('products').doc(productId).collection('reviews').add({
                    userId: user.uid,
                    userName: user.displayName || user.email.split('@')[0] || 'Client',
                    rating: selectedRating,
                    comment: comment,
                    createdAt: new Date()
                }).then(() => {
                    e.target.reset();
                    selectedRating = 0;
                    starBtns.forEach(b => b.classList.remove('active'));
                    formContainer.style.display = 'none';
                    submitBtn.disabled = false;
                    submitBtn.innerText = "Publier l'avis";
                    
                    // Mise à jour de la note globale
                    updateProductRatingSummary(productId);
                    alert("Merci pour votre avis !");

                }).catch(err => {
                    console.error(err);
                    alert("Erreur lors de la publication.");
                    submitBtn.disabled = false;
                });
            });
        }

        // Charger Avis
        function loadReviews(pid) {
            db.collection('products').doc(pid).collection('reviews')
              .orderBy('createdAt', 'desc')
              .onSnapshot(snap => {
                  const list = document.getElementById('reviews-list');
                  if(!list) return;
                  
                  list.innerHTML = "";
                  if(snap.empty) {
                      list.innerHTML = "<p style='color:#777; font-style:italic;'>Soyez le premier à donner votre avis !</p>";
                      return;
                  }

                  snap.forEach(doc => {
                      const r = doc.data();
                      // Conversion date Firestore -> JS
                      let dateStr = "Récemment";
                      if(r.createdAt && r.createdAt.seconds) {
                          dateStr = new Date(r.createdAt.seconds * 1000).toLocaleDateString('fr-FR');
                      }

                      let starsHtml = "";
                      for(let i=0; i<5; i++) { 
                          starsHtml += (i < r.rating) ? '<span style="color:var(--gold)">★</span>' : '<span style="color:#ddd">★</span>'; 
                      }

                      list.innerHTML += `
                        <div class="review-card">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <div style="width:40px; height:40px; background:#eee; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; text-transform:uppercase; color:#555;">
                                        ${(r.userName || 'A').charAt(0)}
                                    </div>
                                    <div>
                                        <div style="font-weight:600;">${r.userName}</div>
                                        <div style="font-size:14px;">${starsHtml}</div>
                                    </div>
                                </div>
                                <small style="color:#999;">${dateStr}</small>
                            </div>
                            <p style="color:#555; font-size:14px; line-height:1.6;">${r.comment}</p>
                        </div>
                      `;
                  });
              });
        }

        // Recalcul Note
        function updateProductRatingSummary(pid) {
            db.collection('products').doc(pid).collection('reviews').get().then(snap => {
                let totalRating = 0;
                let count = 0;
                snap.forEach(doc => {
                    totalRating += doc.data().rating;
                    count++;
                });

                const newAverage = count > 0 ? (totalRating / count) : 0;

                db.collection('products').doc(pid).update({
                    rating: newAverage,
                    reviewCount: count
                }).then(() => {
                   updateRatingDisplay(newAverage, count);
                });
            });
        }

        // Produits Similaires
        function loadSimilarProducts(category) {
            if(!category) return;
            const container = document.getElementById('similar-products');
            if(!container) return;

            db.collection('products').where('category', '==', category).limit(4).get().then(snap => {
                  container.innerHTML = "";
                  let found = 0;
                  snap.forEach(doc => {
                      if(doc.id === currentProduct.id) return; // Exclure produit actuel
                      found++;
                      const p = doc.data();
                      const price = new Intl.NumberFormat('fr-FR').format(p.price);
                      const img = p.image || 'assets/img/placeholder.png';
                      
                      container.innerHTML += `
                        <div class="card product-card" style="cursor:pointer;" onclick="window.location.href='product.html?id=${doc.id}'">
                            <div class="card-img">
                                <img src="${img}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                            <div class="card-body">
                                <h4 style="font-size:14px; margin:0;">${p.name}</h4>
                                <div style="font-weight:bold; color:var(--gold); margin-top:5px;">${price} FCFA</div>
                            </div>
                        </div>`;
                  });
                  
                  if(found === 0) container.innerHTML = "<p>Aucun autre produit similaire.</p>";
              });
        }

        // Ajout Panier
        const btnCart = document.getElementById('btn-add-cart');
        if(btnCart) {
            btnCart.addEventListener('click', () => {
                // Utilise la fonction addToCart de app.js si dispo, sinon fallback simple
                if(typeof addToCart === 'function') {
                    addToCart(currentProduct.id, currentQty);
                } else {
                    // Fallback manuel si app.js n'est pas chargé
                    let cart = JSON.parse(localStorage.getItem('ac_cart') || '[]');
                    const existing = cart.find(i => i.pid === currentProduct.id);
                    if(existing) existing.qty += currentQty;
                    else cart.push({ pid: currentProduct.id, qty: currentQty });
                    localStorage.setItem('ac_cart', JSON.stringify(cart));
                    alert("Ajouté au panier !");
                }
                
                // Animation bouton
                const originalText = btnCart.innerText;
                btnCart.innerText = "Ajouté !";
                btnCart.style.background = "#1F8A70";
                setTimeout(() => { btnCart.innerText = originalText; btnCart.style.background = ""; }, 2000);
            });
        }
    });

    // --- FONCTIONS GLOBALES (accessibles depuis le HTML) ---

    window.switchImage = function(src, thumbElement) {
        document.getElementById('p-main-img').src = src;
        document.querySelectorAll('.thumb').forEach(t => t.classList.remove('active'));
        thumbElement.classList.add('active');
    };

    window.updateQty = function(change) {
        currentQty += change;
        if (currentQty < 1) currentQty = 1;
        document.getElementById('qty-val').innerText = currentQty;
    };
  </script>
</body>
</html>
