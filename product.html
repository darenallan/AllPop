<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Boutique Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="assets/js/auth.js"></script>
</head>

<body class="shop-page">
  <header id="app-header" class="header">
      <div class="container navbar">
          <a href="index.html" class="brand">
              <span class="brand-name" style="font-size:24px; font-weight:bold;">AURUM</span>
          </a>
          <nav class="nav-actions">
              <a href="cart.html" class="icon-btn"><i data-lucide="shopping-bag"></i></a>
          </nav>
      </div>
  </header>

  <main>
    <section class="shop-hero">
      <div class="container">
        <div class="shop-banner">
          <img id="shop-banner" src="assets/img/placeholder-banner.jpg" alt="Bannière boutique" style="width:100%; height:100%; object-fit:cover;" />
        </div>
        
        <div class="shop-profile">
          <div class="shop-avatar-wrap">
            <img id="shop-logo" class="shop-avatar" src="assets/img/placeholder.png" alt="Logo" />
          </div>
          
          <div class="shop-meta">
            <h1 id="shop-name">Chargement...</h1>
            
            <p id="shop-slogan" style="font-style:italic; color:#D4AF37; margin-bottom:8px; font-weight:500;"></p>
            
            <p id="shop-desc" class="shop-desc">...</p>
            
            <div class="shop-badges">
              <span class="shop-badge verified" id="shop-verified" style="display:none;">
                  <i data-lucide="badge-check" style="width:14px;"></i> Vendeur Vérifié
              </span>
              <span class="shop-badge rating">
                <i data-lucide="star" style="width:14px; fill:#D4AF37; color:#D4AF37;"></i>
                <span id="shop-rating">5.0</span>/5
              </span>
            </div>

            <div class="shop-actions">
              <button class="btn btn-gold btn-md" id="contact-btn">
                <i data-lucide="message-circle"></i>
                Contacter sur WhatsApp
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="shop-toolbar">
      <div class="container shop-toolbar-inner">
        <div class="shop-search">
          <i data-lucide="search"></i>
          <input id="shop-search-input" type="search" placeholder="Chercher dans cette boutique..." />
        </div>
        <select id="shop-filter-category" class="chip-select">
          <option value="">Toutes les catégories</option>
          </select>
      </div>
    </section>

    <section class="container shop-products">
      <div id="shop-products" class="grid grid-4">
          <p style="grid-column: 1/-1; text-align:center;">Chargement des produits...</p>
      </div>
    </section>

  </main>

  <footer class="footer">
      <div class="container text-center">
          <p>&copy; 2026 Aurum Marketplace</p>
      </div>
  </footer>

  <div class="toast-container" id="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const params = new URLSearchParams(window.location.search);
        const shopId = params.get('id');

        // Éléments DOM
        const els = {
            banner: document.getElementById('shop-banner'),
            logo: document.getElementById('shop-logo'),
            name: document.getElementById('shop-name'),
            slogan: document.getElementById('shop-slogan'),
            desc: document.getElementById('shop-desc'),
            verified: document.getElementById('shop-verified'),
            rating: document.getElementById('shop-rating'),
            contactBtn: document.getElementById('contact-btn'),
            grid: document.getElementById('shop-products'),
            search: document.getElementById('shop-search-input'),
            filter: document.getElementById('shop-filter-category')
        };

        let shopProducts = []; // Stockage local pour filtrage

        if (!shopId) {
            els.name.innerText = "Boutique introuvable";
            els.grid.innerHTML = "";
            return;
        }

        // 1. CHARGER LES INFOS DE LA BOUTIQUE
        db.collection('shops').doc(shopId).get().then(doc => {
            if (doc.exists) {
                const data = doc.data();
                
                // Remplissage UI
                els.name.innerText = data.name;
                els.desc.innerText = data.description || "Bienvenue dans notre boutique.";
                els.slogan.innerText = data.slogan || ""; // Le slogan personnalisé !
                
                // Images (avec fallback)
                if (data.banner) els.banner.src = data.banner;
                if (data.logo) els.logo.src = data.logo;

                // Badge Vérifié
                if (data.status === 'active') els.verified.style.display = 'inline-flex';

                // Bouton WhatsApp
                if (data.phone) {
                    els.contactBtn.onclick = () => {
                        const num = data.phone.replace(/[^\d]/g, '');
                        const msg = `Bonjour, je viens de voir votre boutique ${data.name} sur Aurum.`;
                        window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`, '_blank');
                    };
                } else {
                    els.contactBtn.style.display = 'none';
                }

                // Titre page
                document.title = `${data.name} - Boutique Aurum`;
            } else {
                els.name.innerText = "Boutique inexistante";
            }
        });

        // 2. CHARGER LES PRODUITS DE LA BOUTIQUE
        db.collection('products').where('shopId', '==', shopId).get().then(snap => {
            if (snap.empty) {
                els.grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px;">
                    <i data-lucide="package-open" style="width:48px; height:48px; color:#ccc; margin-bottom:10px;"></i>
                    <p>Aucun produit en vente pour le moment.</p>
                </div>`;
                lucide.createIcons();
                return;
            }

            // Stocker et extraire les catégories uniques
            const categories = new Set();
            snap.forEach(doc => {
                const p = { id: doc.id, ...doc.data() };
                shopProducts.push(p);
                if(p.category) categories.add(p.category);
            });

            // Remplir le filtre
            categories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.innerText = cat;
                els.filter.appendChild(opt);
            });

            // Afficher tout
            renderGrid(shopProducts);
        });

        // Fonction d'affichage
        function renderGrid(products) {
            els.grid.innerHTML = "";
            if(products.length === 0) {
                els.grid.innerHTML = "<p>Aucun résultat pour cette recherche.</p>";
                return;
            }

            products.forEach(p => {
                const price = new Intl.NumberFormat('fr-FR').format(p.price);
                // Image principale (la première du tableau ou l'unique)
                const img = (p.images && p.images.length > 0) ? p.images[0] : (p.image || 'assets/img/placeholder-product-1.svg');

                els.grid.innerHTML += `
                    <div class="card product-card">
                        <a href="product.html?id=${p.id}" style="text-decoration:none; color:inherit;">
                            <div class="card-img" style="height:250px; overflow:hidden;">
                                <img src="${img}" style="width:100%; height:100%; object-fit:cover;">
                            </div>
                        </a>
                        <div class="info">
                            <h3 class="product-name" style="font-size:16px; margin:0;"><a href="product.html?id=${p.id}">${p.name}</a></h3>
                            <div class="price">${price} FCFA</div>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        // 3. FILTRAGE EN TEMPS RÉEL
        function filterProducts() {
            const term = els.search.value.toLowerCase();
            const cat = els.filter.value;

            const filtered = shopProducts.filter(p => {
                const matchName = p.name.toLowerCase().includes(term);
                const matchCat = cat === "" || p.category === cat;
                return matchName && matchCat;
            });

            renderGrid(filtered);
        }

        els.search.addEventListener('input', filterProducts);
        els.filter.addEventListener('change', filterProducts);
        
        lucide.createIcons();
    });
  </script>
</body>
</html>
