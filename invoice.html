<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votre Facture - Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="assets/js/auth.js"></script>

  <style>
      .invoice-container { padding: 40px 20px; max-width: 900px; margin: 0 auto; }
      
      .success-banner {
          background: linear-gradient(135deg, #1F8A70 0%, #156652 100%);
          color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;
          display: flex; align-items: flex-start; gap: 16px;
          box-shadow: 0 10px 30px rgba(31, 138, 112, 0.2);
      }
      
      /* --- STYLE FACTURE IMPRESSION --- */
      .invoice-card {
          background: white; 
          /* Largeur fixe idéale pour A4 */
          width: 794px; /* Largeur A4 en pixels (96dpi) */
          margin: 0 auto;
          border: 1px solid #eee;
          overflow: hidden; 
          background-color: #ffffff;
          padding: 0; /* Important pour le PDF */
      }
      
      .invoice-header {
          background: #fcfcfc; padding: 40px; border-bottom: 2px solid #f0f0f0;
          display: flex; justify-content: space-between; align-items: flex-start;
      }
      
      .invoice-body { padding: 40px; }
      
      .invoice-table { width: 100%; border-collapse: collapse; margin: 30px 0; }
      .invoice-table th { text-align: left; color: #666; font-size: 12px; text-transform: uppercase; padding: 10px 0; border-bottom: 1px solid #eee; }
      .invoice-table td { padding: 15px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
      
      /* Police système pour éviter les bugs de caractères */
      .price-text {
          font-family: Arial, Helvetica, sans-serif !important; 
          font-weight: 600;
          white-space: nowrap;
      }
      
      .invoice-total-section { 
          background: #fafafa; padding: 20px; border-radius: 12px; 
          margin-left: auto; width: 100%; max-width: 300px;
      }
      .invoice-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
      
      .invoice-actions {
          padding: 30px 40px; margin-top: 30px;
          display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
      }

      /* Cache le scrollbar lors de la capture */
      .no-scroll { overflow: hidden; }
  </style>
</head>

<body>
  <header id="app-header" class="header">
      <div class="container navbar">
          <a href="index.html" class="brand">
              <span class="brand-name" style="font-size:24px; font-weight:bold;">AURUM</span>
          </a>
          <nav class="nav-actions">
              <a href="cart.html" class="icon-btn"><i data-lucide="shopping-bag"></i></a>
          </nav>
      </div>
  </header>

  <main class="invoice-container">
    
    <div id="loading" style="text-align:center; padding:100px;">
        <i data-lucide="loader" class="spin" style="animation:spin 1s linear infinite; width:40px; height:40px; color:var(--gold);"></i>
        <p style="margin-top:20px; color:#666;">Génération de votre facture...</p>
    </div>

    <div id="invoice-content" style="display:none;">
        
        <div class="success-banner">
            <i data-lucide="check-circle" style="width:32px; height:32px; flex-shrink:0;"></i>
            <div>
                <h2 style="margin:0 0 5px 0; font-size:18px;">Commande confirmée !</h2>
                <p style="margin:0; opacity:0.9; font-size:14px; line-height:1.5;">
                    Votre commande a bien été enregistrée. Voici votre facture officielle.
                </p>
            </div>
        </div>

        <div class="invoice-card" id="invoice-document">
            <div class="invoice-header">
                <div>
                    <h1 style="font-family:'Playfair Display', serif; font-size:32px; margin:0; color:#D4AF37;">AURUM</h1>
                    <p style="margin:5px 0 0; color:#666; font-size:13px;">Excellence à votre portée</p>
                    <div style="margin-top:15px; font-size:13px; color:#444; line-height:1.6;">
                        Ouagadougou, Burkina Faso<br>
                        Tél: +226 64 50 26 26<br>
                        Email: contact@aurum.bf
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:14px; color:#999; text-transform:uppercase; margin-bottom:5px;">Facture N°</div>
                    <div style="font-size:20px; font-weight:700; font-family:Arial,sans-serif;" id="inv-ref">...</div>
                    <div style="margin-top:5px; font-size:14px; color:#666;" id="inv-date">...</div>
                </div>
            </div>

            <div class="invoice-body">
                <div style="margin-bottom:30px;">
                    <h3 style="font-size:14px; text-transform:uppercase; color:#999; margin-bottom:10px;">Facturé à</h3>
                    <div style="font-weight:600; font-size:16px;" id="client-name">...</div>
                    <div style="color:#555; margin-top:5px;" id="client-phone">...</div>
                    <div style="color:#555;" id="client-email">...</div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align:center;">Qté</th>
                            <th style="text-align:right;">Prix Unit.</th>
                            <th style="text-align:right;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items"></tbody>
                </table>

                <div style="display:flex; justify-content:flex-end;">
                    <div class="invoice-total-section">
                        <div class="invoice-row">
                            <span class="invoice-label">Sous-total</span>
                            <span class="invoice-val price-text" id="inv-subtotal">...</span>
                        </div>
                        <div class="invoice-row">
                            <span class="invoice-label">Livraison</span>
                            <span class="invoice-val">À calculer</span>
                        </div>
                        <div style="border-top:1px solid #ddd; margin:10px 0;"></div>
                        <div class="invoice-row" style="margin-bottom:0;">
                            <span class="invoice-label" style="font-size:16px; color:#000;">Total à payer</span>
                            <span class="invoice-val price-text" style="font-size:18px; color:#D4AF37;" id="inv-total">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="invoice-actions">
            <button class="btn btn-gold" id="btn-download">
                <i data-lucide="download"></i> Télécharger PDF
            </button>
            <button class="btn btn-success" id="btn-whatsapp" style="background:#25D366; color:white; border:none;">
                <i data-lucide="message-circle"></i> Envoyer sur WhatsApp
            </button>
        </div>

    </div>
  </main>

  <footer class="footer">
      <div class="container text-center"><p>&copy; 2026 Aurum Marketplace</p></div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const auth = firebase.auth();
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');

        if (!orderId) {
            alert("Aucune commande trouvée.");
            window.location.href = "cart.html";
            return;
        }

        db.collection('orders').doc(orderId).get().then(doc => {
            if (doc.exists) {
                renderInvoice(doc.data(), doc.id);
            } else {
                alert("Commande introuvable.");
            }
        }).catch(console.error);

        function formatMoney(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ") + " FCFA";
        }

        function renderInvoice(order, id) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('invoice-content').style.display = 'block';

            const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : new Date().toLocaleDateString();
            document.getElementById('inv-ref').innerText = "AUR-" + id.substr(0, 6).toUpperCase();
            document.getElementById('inv-date').innerText = date;
            
            document.getElementById('client-name').innerText = order.userName || "Client";
            document.getElementById('client-phone').innerText = order.userPhone || "";
            document.getElementById('client-email').innerText = order.userEmail || "";

            const tbody = document.getElementById('invoice-items');
            tbody.innerHTML = "";
            let total = 0;

            order.items.forEach(item => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                tbody.innerHTML += `
                    <tr>
                        <td>${item.name}</td>
                        <td style="text-align:center;">${item.qty}</td>
                        <td style="text-align:right;" class="price-text">${formatMoney(item.price)}</td>
                        <td style="text-align:right;" class="price-text">${formatMoney(lineTotal)}</td>
                    </tr>
                `;
            });

            const totalStr = formatMoney(total);
            document.getElementById('inv-subtotal').innerText = totalStr;
            document.getElementById('inv-total').innerText = totalStr;

            setupActions(order, id, totalStr);
            lucide.createIcons();
        }

        function setupActions(order, id, totalStr) {
            
            // --- LOGIQUE PDF CORRIGÉE (PLEINE LARGEUR) ---
            document.getElementById('btn-download').addEventListener('click', () => {
                const btn = document.getElementById('btn-download');
                btn.innerText = "Génération...";
                btn.disabled = true;

                const { jsPDF } = window.jspdf;
                const element = document.getElementById('invoice-document');
                
                // On utilise 'mm' comme unité et 'a4' comme format
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth(); // 210mm
                const pageHeight = doc.internal.pageSize.getHeight();

                doc.html(element, {
                    callback: function (doc) {
                        doc.save(`Facture_AURUM_${id.substr(0,6)}.pdf`);
                        btn.innerHTML = '<i data-lucide="download"></i> Télécharger PDF';
                        btn.disabled = false;
                        lucide.createIcons();
                    },
                    x: 0,
                    y: 0,
                    // Cette option est cruciale : elle adapte le HTML à la largeur A4 (environ 190mm utilisables)
                    width: 210, 
                    windowWidth: 794, // Force html2canvas à voir l'élément comme s'il faisait 794px
                    html2canvas: {
                        scale: 0.26, // Ratio magique (210mm / 794px approx) pour faire rentrer pile poil
                        useCORS: true,
                        logging: false
                    }
                });
            });

            // WHATSAPP
            document.getElementById('btn-whatsapp').addEventListener('click', () => {
                const phone = "22664502626";
                const ref = "AUR-" + id.substr(0,6).toUpperCase();
                const msg = `Bonjour Aurum,\n\nJe souhaite régler ma commande ${ref} d'un montant de ${totalStr}.\n\nQuels sont les moyens de paiement ?`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            });
        }
    });
  </script>
</body>
</html>
