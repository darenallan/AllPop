<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votre Facture - Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <script src="assets/js/auth.js"></script>

  <style>
      .invoice-container { padding: 40px 20px; max-width: 900px; margin: 0 auto; }
      
      .success-banner {
          background: linear-gradient(135deg, #1F8A70 0%, #156652 100%);
          color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px;
          display: flex; align-items: flex-start; gap: 16px;
          box-shadow: 0 10px 30px rgba(31, 138, 112, 0.2);
      }
      
      .invoice-card {
          background: white; border-radius: 16px; border: 1px solid #eee;
          overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.05);
          /* Important pour le PDF : fond blanc forcé */
          background-color: #ffffff; 
      }
      
      .invoice-header {
          background: #fcfcfc; padding: 40px; border-bottom: 2px solid #f0f0f0;
          display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;
      }
      
      .invoice-body { padding: 40px; }
      
      .invoice-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
      .invoice-label { color: #666; font-weight: 500; }
      .invoice-val { font-weight: 600; color: #000; }
      
      .invoice-table { width: 100%; border-collapse: collapse; margin: 30px 0; }
      .invoice-table th { text-align: left; color: #666; font-size: 12px; text-transform: uppercase; padding: 10px 0; border-bottom: 1px solid #eee; }
      .invoice-table td { padding: 15px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
      .invoice-table td:last-child, .invoice-table th:last-child { text-align: right; }
      
      .invoice-total-section { 
          background: #fafafa; padding: 20px; border-radius: 12px; 
          margin-left: auto; width: 100%; max-width: 300px;
      }
      
      .invoice-actions {
          padding: 30px 40px; background: #fafafa; border-top: 1px solid #eee;
          display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
      }

      @media (max-width: 768px) {
          .invoice-header { flex-direction: column; }
          .invoice-body { padding: 20px; }
          .invoice-actions { flex-direction: column; }
          .invoice-actions .btn { width: 100%; }
      }
  </style>
</head>

<body>
  <header id="app-header" class="header">
      <div class="container navbar">
          <a href="index.html" class="brand">
              <span class="brand-name" style="font-size:24px; font-weight:bold;">AURUM</span>
          </a>
          <nav class="nav-actions">
              <a href="cart.html" class="icon-btn"><i data-lucide="shopping-bag"></i></a>
          </nav>
      </div>
  </header>

  <main class="invoice-container">
    
    <div id="loading" style="text-align:center; padding:100px;">
        <i data-lucide="loader" class="spin" style="animation:spin 1s linear infinite; width:40px; height:40px; color:var(--gold);"></i>
        <p style="margin-top:20px; color:#666;">Génération de votre facture...</p>
    </div>

    <div id="invoice-content" style="display:none;">
        
        <div class="success-banner">
            <i data-lucide="check-circle" style="width:32px; height:32px; flex-shrink:0;"></i>
            <div>
                <h2 style="margin:0 0 5px 0; font-size:18px;">Commande confirmée !</h2>
                <p style="margin:0; opacity:0.9; font-size:14px; line-height:1.5;">
                    Votre commande a bien été enregistrée. Voici votre facture officielle. 
                    Veuillez la télécharger et nous contacter pour finaliser le paiement.
                </p>
            </div>
        </div>

        <div class="invoice-card" id="invoice-document">
            <div class="invoice-header">
                <div>
                    <h1 style="font-family:'Playfair Display', serif; font-size:32px; margin:0; color:#D4AF37;">AURUM</h1>
                    <p style="margin:5px 0 0; color:#666; font-size:13px;">Excellence à votre portée</p>
                    <div style="margin-top:15px; font-size:13px; color:#444; line-height:1.6;">
                        Ouagadougou, Burkina Faso<br>
                        Tél: +226 64 50 26 26<br>
                        Email: aurumcorporate.d@gmail.bf
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:14px; color:#999; text-transform:uppercase; margin-bottom:5px;">Facture N°</div>
                    <div style="font-size:20px; font-weight:700;" id="inv-ref">...</div>
                    <div style="margin-top:5px; font-size:14px; color:#666;" id="inv-date">...</div>
                </div>
            </div>

            <div class="invoice-body">
                <div style="margin-bottom:30px;">
                    <h3 style="font-size:14px; text-transform:uppercase; color:#999; margin-bottom:10px;">Facturé à</h3>
                    <div style="font-weight:600; font-size:16px;" id="client-name">...</div>
                    <div style="color:#555; margin-top:5px;" id="client-phone">...</div>
                    <div style="color:#555;" id="client-email">...</div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align:center;">Qté</th>
                            <th>Prix Unit.</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items"></tbody>
                </table>

                <div style="display:flex; justify-content:flex-end;">
                    <div class="invoice-total-section">
                        <div class="invoice-row">
                            <span class="invoice-label">Sous-total</span>
                            <span class="invoice-val" id="inv-subtotal">...</span>
                        </div>
                        <div class="invoice-row">
                            <span class="invoice-label">Livraison</span>
                            <span class="invoice-val">À calculer</span>
                        </div>
                        <div style="border-top:1px solid #ddd; margin:10px 0;"></div>
                        <div class="invoice-row" style="margin-bottom:0;">
                            <span class="invoice-label" style="font-size:16px; color:#000;">Total à payer</span>
                            <span class="invoice-val" style="font-size:18px; color:#D4AF37;" id="inv-total">...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="invoice-actions">
            <button class="btn btn-gold" id="btn-download">
                <i data-lucide="download"></i> Télécharger PDF
            </button>
            <button class="btn btn-success" id="btn-whatsapp" style="background:#25D366; color:white; border:none;">
                <i data-lucide="message-circle"></i> Envoyer sur WhatsApp
            </button>
        </div>

    </div>
  </main>

  <footer class="footer">
      <div class="container text-center"><p>&copy; 2026 Aurum Marketplace</p></div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const db = firebase.firestore();
        const auth = firebase.auth();
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');

        if (!orderId) {
            alert("Aucune commande spécifiée.");
            window.location.href = "cart.html";
            return;
        }

        db.collection('orders').doc(orderId).get().then(doc => {
            if (doc.exists) {
                const order = doc.data();
                renderInvoice(order, doc.id);
            } else {
                alert("Commande introuvable.");
                window.location.href = "index.html";
            }
        }).catch(err => {
            console.error(err);
            alert("Erreur de chargement.");
        });

        function renderInvoice(order, id) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('invoice-content').style.display = 'block';

            // Remplissage infos
            const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : new Date().toLocaleDateString();
            document.getElementById('inv-ref').innerText = "AUR-" + id.substr(0, 6).toUpperCase();
            document.getElementById('inv-date').innerText = date;
            
            document.getElementById('client-name').innerText = order.userName || "Client";
            document.getElementById('client-phone').innerText = order.userPhone || "";
            document.getElementById('client-email').innerText = order.userEmail || "";

            // Items
            const tbody = document.getElementById('invoice-items');
            tbody.innerHTML = "";
            let total = 0;

            order.items.forEach(item => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td style="text-align:center;">${item.qty}</td>
                    <td>${new Intl.NumberFormat('fr-FR').format(item.price)} FCFA</td>
                    <td>${new Intl.NumberFormat('fr-FR').format(lineTotal)} FCFA</td>
                `;
                tbody.appendChild(tr);
            });

            const formattedTotal = new Intl.NumberFormat('fr-FR').format(total) + " FCFA";
            document.getElementById('inv-subtotal').innerText = formattedTotal;
            document.getElementById('inv-total').innerText = formattedTotal;

            setupActions(order, id, formattedTotal);
            lucide.createIcons();
        }

        function setupActions(order, id, totalStr) {
            // PDF Download
            const btnDownload = document.getElementById('btn-download');
            
            btnDownload.addEventListener('click', () => {
                // Feedback utilisateur
                const originalText = btnDownload.innerHTML;
                btnDownload.innerText = "Génération du PDF...";
                btnDownload.disabled = true;

                // Initialisation jsPDF
                const { jsPDF } = window.jspdf;
                // 'p' = portrait, 'pt' = points, 'a4' = format papier
                const doc = new jsPDF('p', 'pt', 'a4');
                
                const content = document.getElementById('invoice-document');

                doc.html(content, {
                    callback: function (doc) {
                        doc.save(`Facture_AURUM_${id.substr(0,6)}.pdf`);
                        // Reset bouton
                        btnDownload.innerHTML = originalText;
                        btnDownload.disabled = false;
                    },
                    x: 15,    // Marge gauche
                    y: 15,    // Marge haut
                    width: 565, // Largeur contenue (A4 est 595pt)
                    windowWidth: 900 // Largeur fenêtre virtuelle (pour garder le CSS desktop)
                });
            });

            // WhatsApp
            document.getElementById('btn-whatsapp').addEventListener('click', () => {
                const phone = "22664502626"; 
                const msg = `Bonjour Aurum,\n\nJe viens de passer commande (Réf: AUR-${id.substr(0,6).toUpperCase()}) pour un total de ${totalStr}.\n\nJe souhaite procéder au paiement.`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            });
        }
    });
  </script>
</body>
</html>
