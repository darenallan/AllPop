<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votre Facture - Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Configuration & Utilities -->
  <script src="assets/js/config.js"></script>
  <!-- Data Store -->
  <script src="assets/js/data.js" defer></script>
  <!-- App Module -->
  <script src="assets/js/app.js" defer></script>


</head>

<body>
  <header id="app-header" class="glass-nav">
      <div class="nav-content">
          <a href="index.html" class="brand">
              <div class="brand-logo-img" style="width:44px; height:44px; border-radius:12px; background:var(--gold); display:flex; align-items:center; justify-content:center; color:black; font-weight:800;">A</div>
              <div style="display:flex; flex-direction:column; margin-left:10px;">
                  <span class="brand-name" style="font-size:22px; font-weight:800; letter-spacing:0.5px;">AURUM</span>
                  <span class="tagline" style="font-size:11px; letter-spacing:1px; color:#666;">EXCELLENCE À VOTRE PORTÉE</span>
              </div>
          </a>
          <nav class="nav-icons">
              <a href="catalogue.html" class="icon-btn"><i data-lucide="search"></i></a>
              <a href="cart.html" class="icon-btn" style="position:relative;">
                  <i data-lucide="shopping-bag"></i>
                  <span class="badge" id="cart-badge" style="display:none; position:absolute; top:-5px; right:-5px; background:red; color:white; font-size:10px; padding:2px 5px; border-radius:50%;">0</span>
              </a>
              <a href="wishlist.html" class="icon-btn"><i data-lucide="heart"></i></a>
              <button class="menu-toggle" id="menu-toggle" style="z-index: 1001;"><i data-lucide="menu"></i></button>
          </nav>
      </div>
  </header>

  <div class="mobile-drawer" id="mobile-drawer">
      <div class="drawer-header">
          <span class="drawer-title">Menu</span>
          <button class="close-btn" id="close-btn"><i data-lucide="x"></i></button>
      </div>
      <nav class="drawer-nav">
          <a href="index.html" class="drawer-link"><i data-lucide="home"></i> Accueil</a>
          <a href="catalogue.html" class="drawer-link"><i data-lucide="grid"></i> Catalogue</a>
          <a href="cart.html" class="drawer-link"><i data-lucide="shopping-bag"></i> Panier</a>
          <a href="wishlist.html" class="drawer-link"><i data-lucide="heart"></i> Mes Favoris</a>
          <a href="boutique-list.html" class="drawer-link"><i data-lucide="store"></i> Nos Boutiques</a>
          <div class="drawer-divider"></div>
          <a href="seller.html" class="drawer-link"><i data-lucide="store"></i> Espace Vendeur</a>
          <a href="profile.html" class="drawer-link"><i data-lucide="user"></i> Mon Profil</a>
          <div class="drawer-divider"></div>
          <a href="#" id="mobile-logout-btn" class="drawer-link" style="color: #ef4444;">
              <i data-lucide="log-out"></i> Déconnexion
          </a>
      </nav>
  </div>
  <div id="menu-overlay"></div>

  <main class="invoice-container">
    
    <div id="loading" style="text-align:center; padding:100px;">
        <i data-lucide="loader" class="spin" style="animation:spin 1s linear infinite; width:40px; height:40px; color:var(--gold);"></i>
        <p style="margin-top:20px; color:#666;">Génération de votre facture...</p>
    </div>

    <div id="invoice-content" style="display:none;">
        
        <div class="success-banner">
            <i data-lucide="check-circle" style="width:32px; height:32px; flex-shrink:0;"></i>
            <div>
                <h2 style="margin:0 0 5px 0; font-size:18px;">Commande confirmée !</h2>
                <p style="margin:0; opacity:0.9; font-size:14px; line-height:1.5;">
                    Votre commande a bien été enregistrée. Voici votre facture officielle. 
                    Veuillez la télécharger et nous contacter pour finaliser le paiement.
                </p>
            </div>
        </div>

        <div class="invoice-card" id="invoice-document">
            
            <div class="invoice-header">
                <div>
                    <h1 style="font-family:'Playfair Display', serif; font-size:32px; margin:0; color:#D4AF37;">AURUM</h1>
                    <p style="margin:5px 0 0; color:#666; font-size:13px;">Excellence à votre portée</p>
                    <div style="margin-top:15px; font-size:13px; color:#444; line-height:1.6;">
                        Ouagadougou, Burkina Faso<br>
                        Tél: +226 64 50 26 26<br>
                        Email: aurumcorporate.d@gmail.com
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:14px; color:#999; text-transform:uppercase; margin-bottom:5px;">Facture N°</div>
                    <div style="font-size:20px; font-weight:700;" id="inv-ref">...</div>
                    <div style="margin-top:5px; font-size:14px; color:#666;" id="inv-date">...</div>
                </div>
            </div>

            <div class="invoice-body">
                <div style="margin-bottom:30px;">
                    <h3 style="font-size:14px; text-transform:uppercase; color:#999; margin-bottom:10px;">Facturé à</h3>
                    <div style="font-weight:600; font-size:16px;" id="client-name">...</div>
                    <div style="color:#555; margin-top:5px;" id="client-phone">...</div>
                    <div style="color:#555;" id="client-email">...</div>
                </div>

                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th style="text-align:center;">Qté</th>
                            <th>Prix Unit.</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="invoice-items">
                        </tbody>
                </table>

                <div style="display:flex; justify-content:flex-end;">
                    <div class="invoice-total-section">
                        <div class="invoice-row">
                            <span class="invoice-label">Sous-total</span>
                            <span class="invoice-val" id="inv-subtotal">...</span>
                        </div>
                        <div class="invoice-row">
                            <span class="invoice-label">Livraison</span>
                            <span class="invoice-val">À calculer</span>
                        </div>
                        <div style="border-top:1px solid #ddd; margin:10px 0;"></div>
                        <div class="invoice-row" style="margin-bottom:0;">
                            <span class="invoice-label" style="font-size:16px; color:#000;">Total à payer</span>
                            <span class="invoice-val" style="font-size:18px; color:#D4AF37;" id="inv-total">...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="invoice-actions">
                <button class="btn btn-gold" id="btn-download">
                    <i data-lucide="download"></i> Télécharger PDF
                </button>
                <button class="btn btn-success" id="btn-whatsapp" style="background:#25D366; color:white; border:none;">
                    <i data-lucide="send"></i> Envoyer sur WhatsApp
                </button>
            </div>
        </div>

    </div>
  </main>

  <script>
    function setupHeaderMenu() {
        const menuToggle = document.getElementById('menu-toggle');
        const closeBtn = document.getElementById('close-btn');
        const drawer = document.getElementById('mobile-drawer');
        const overlay = document.getElementById('menu-overlay');

        const toggleMenu = () => {
            if (!drawer || !overlay) return;
            drawer.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow = drawer.classList.contains('active') ? 'hidden' : '';
        };

        if (menuToggle) menuToggle.addEventListener('click', toggleMenu);
        if (closeBtn) closeBtn.addEventListener('click', toggleMenu);
        if (overlay) overlay.addEventListener('click', toggleMenu);

        const cart = JSON.parse(localStorage.getItem('ac_cart') || '[]');
        const badge = document.getElementById('cart-badge');
        if (badge) {
            const count = cart.reduce((acc, item) => acc + (item.qty || 0), 0);
            if (count > 0) {
                badge.innerText = count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', () => {
        setupHeaderMenu();
        
        const yearSpan = document.getElementById('year');
        if (yearSpan) {
            yearSpan.innerText = new Date().getFullYear();
        }

        // Gestion de la déconnexion
        const logoutBtn = document.getElementById('mobile-logout-btn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', (e) => {
                e.preventDefault();
                firebase.auth().signOut().then(() => {
                    window.location.href = "login.html";
                });
            });
        }

        const { jsPDF } = window.jspdf;
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Récupérer l'ID de la commande depuis l'URL
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');

        // Si pas d'ID, on utilise le panier local pour simuler une facture (Checkout immédiat)
        // Mais idéalement, il faut d'abord créer la commande dans Firebase.
        
        // Simulation pour l'exemple si pas d'ID (à adapter avec ton flux réel)
        // Ici on va chercher la commande réelle dans Firebase
        
        if (!orderId) {
            const localCheckout = JSON.parse(localStorage.getItem('ac_cart_checkout') || 'null');
            if (!localCheckout || !Array.isArray(localCheckout) || localCheckout.length === 0) {
                alert("Aucune commande spécifiée.");
                window.location.href = "cart.html";
                return;
            }

            const user = auth.currentUser;
            const order = {
                userName: user?.displayName || "Client",
                userEmail: user?.email || "",
                userPhone: "",
                createdAt: { seconds: Math.floor(Date.now() / 1000) },
                items: localCheckout.map(item => ({
                    id: item.id,
                    name: item.name || "Produit",
                    price: Number(item.price || 0),
                    qty: Number(item.qty || item.quantity || 1)
                }))
            };

            renderInvoice(order, `LOCAL-${Date.now()}`);
            return;
        }

        db.collection('orders').doc(orderId).get().then(doc => {
            if (doc.exists) {
                const order = doc.data();
                renderInvoice(order, doc.id);
            } else {
                alert("Commande introuvable.");
                window.location.href = "index.html";
            }
        }).catch(err => {
            console.error(err);
            alert("Erreur de chargement.");
        });

        function renderInvoice(order, id) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('invoice-content').style.display = 'block';

            // Remplissage infos
            const date = order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleDateString() : new Date().toLocaleDateString();
            document.getElementById('inv-ref').innerText = "AUR-" + id.substr(0, 6).toUpperCase();
            document.getElementById('inv-date').innerText = date;
            
            document.getElementById('client-name').innerText = order.userName || "Client";
            document.getElementById('client-phone').innerText = order.userPhone || "";
            document.getElementById('client-email').innerText = order.userEmail || "";

            // Items
            const tbody = document.getElementById('invoice-items');
            tbody.innerHTML = "";
            let total = 0;

            order.items.forEach(item => {
                const lineTotal = item.price * item.qty;
                total += lineTotal;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.name}</td>
                    <td style="text-align:center;">${item.qty}</td>
                    <td>${new Intl.NumberFormat('fr-FR').format(item.price)} FCFA</td>
                    <td>${new Intl.NumberFormat('fr-FR').format(lineTotal)} FCFA</td>
                `;
                tbody.appendChild(tr);
            });

            const formattedTotal = new Intl.NumberFormat('fr-FR').format(total) + " FCFA";
            document.getElementById('inv-subtotal').innerText = formattedTotal;
            document.getElementById('inv-total').innerText = formattedTotal;

            // Setup Boutons
            setupActions(order, id, formattedTotal);
            lucide.createIcons();
        }

        function setupActions(order, id, totalStr) {
            // PDF Download
            document.getElementById('btn-download').addEventListener('click', () => {
                const doc = new jsPDF();
                const content = document.getElementById('invoice-document');
                
                doc.html(content, {
                    callback: function (doc) {
                        doc.save(`Facture_AURUM_${id}.pdf`);
                    },
                    x: 10,
                    y: 10,
                    width: 190,
                    windowWidth: 900 
                });
            });

            // WhatsApp
            document.getElementById('btn-whatsapp').addEventListener('click', () => {
                const phone = "22664502626"; // Ton numéro business
                const msg = `Bonjour Aurum,\n\nJe viens de passer commande (Réf: AUR-${id.substr(0,6).toUpperCase()}) pour un total de ${totalStr}.\n\nPouvez-vous me confirmer les moyens de paiement disponibles ?\n\nMerci.`;
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            });
        }
    });
  </script>
  <script src="assets/js/footer.js" defer></script>
</body>
</html>