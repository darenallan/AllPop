<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connexion - Aurum</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="assets/css/styles.css" />
  
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <!-- Configuration & Utilities -->
  <script src="assets/js/config.js"></script>
  <!-- App Module -->
  <script src="assets/js/app.js" defer></script>
</head>

<body>
  <header id="app-header" class="glass-nav">
      <div class="nav-content">
          <a href="index.html" class="brand">
              <div class="brand-logo-img" style="width:44px; height:44px; border-radius:12px; background:var(--gold); display:flex; align-items:center; justify-content:center; color:black; font-weight:800;">A</div>
              <div style="display:flex; flex-direction:column; margin-left:10px;">
                  <span class="brand-name" style="font-size:22px; font-weight:800; letter-spacing:0.5px;">AURUM</span>
                  <span class="tagline" style="font-size:11px; letter-spacing:1px; color:#666;">EXCELLENCE À VOTRE PORTÉE</span>
              </div>
          </a>
      </div>
  </header>

  <div class="mobile-drawer" id="mobile-drawer">
      <div class="drawer-header">
          <span class="drawer-title">Menu</span>
          <button class="close-btn" id="close-btn"><i data-lucide="x"></i></button>
      </div>
      <nav class="drawer-nav">
          <a href="index.html" class="drawer-link"><i data-lucide="home"></i> Accueil</a>
          <a href="catalogue.html" class="drawer-link"><i data-lucide="grid"></i> Catalogue</a>
          <a href="cart.html" class="drawer-link"><i data-lucide="shopping-bag"></i> Panier</a>
          <a href="wishlist.html" class="drawer-link"><i data-lucide="heart"></i> Mes Favoris</a>
          <a href="boutique-list.html" class="drawer-link"><i data-lucide="store"></i> Nos Boutiques</a>
          <div class="drawer-divider"></div>
          <a href="seller.html" class="drawer-link"><i data-lucide="store"></i> Espace Vendeur</a>
          <a href="profile.html" class="drawer-link"><i data-lucide="user"></i> Mon Profil</a>
          <div class="drawer-divider"></div>
          <a href="#" id="mobile-logout-btn" class="drawer-link" style="color: #ef4444;">
              <i data-lucide="log-out"></i> Déconnexion
          </a>
      </nav>
  </div>
  <div id="menu-overlay"></div>

    <main class="container">
        <section class="section">
            <div style="max-width: 400px; margin: 0 auto;">
                <h1>Connexion</h1>

                <form id="form-login" class="grid grid-1" style="gap: 20px;">
                    <div class="form-group">
                        <label style="font-weight: bold;">Email</label>
                        <input type="email" id="login-email" class="input" required placeholder="votre@email.com">
                    </div>

                    <div class="form-group">
                        <label style="font-weight: bold;">Mot de passe</label>
                        <input type="password" id="login-pass" class="input" required placeholder="••••••••">
                    </div>

                    <button type="submit" id="btn-submit" class="btn btn-gold" style="width: 100%; padding: 15px;">
                        Se connecter
                    </button>
                </form>

                <p style="margin-top: 15px; text-align: center;">
                    <a href="#" id="forgot-password-link" style="color: var(--gold); font-weight: bold; font-size: 14px;">Mot de passe oublié ?</a>
                </p>

                <p style="margin-top: 20px; text-align: center;">
                    Pas encore de compte ? <a href="register.html" style="color: var(--gold); font-weight: bold;">Créer un compte</a>
                </p>
            </div>
        </section>
    </main>

  <div class="toast-container" id="toast-container"></div>

  <script>
    // === PAGE LOGIN - LOGIQUE SPÉCIFIQUE ===
    document.addEventListener('DOMContentLoaded', () => {
        const yearSpan = document.getElementById('year');
        if (yearSpan) yearSpan.innerText = new Date().getFullYear();

        // AUTHENTIFICATION
        const auth = firebase.auth();
        const form = document.getElementById('form-login');
        const btn = document.getElementById('btn-submit');

        if(form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const originalText = btn.innerText;
                btn.innerText = "Connexion en cours...";
                btn.disabled = true;

                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-pass').value;

                console.log("ðŸ“§ Tentative connexion:", email);

                window.auth.signInWithEmailAndPassword(email, pass)
                    .then((userCredential) => {
                        console.log("✅ Connexion réussie:", userCredential.user.email);

                        const finishRedirect = () => {
                            const redirectWithRole = (role = '') => {
                                // Redirection basée sur le rôle
                                if (email === 'aurumcorporate.d@gmail.com') {
                                    window.location.href = "admin.html";
                                } else if (['admin', 'superadmin', 'maintainer'].includes(role)) {
                                    window.location.href = "admin.html";
                                } else if (role === 'seller') {
                                    window.location.href = "seller.html";
                                } else if (sessionStorage.getItem('ac_checkout_pending') === 'true') {
                                    sessionStorage.removeItem('ac_checkout_pending');
                                    window.location.href = "cart.html";
                                } else {
                                    window.location.href = "index.html";
                                }
                            };

                            if (window.db && userCredential.user?.uid) {
                                window.db.collection('users').doc(userCredential.user.uid).get()
                                    .then((doc) => {
                                        const role = doc.exists ? (doc.data().role || '') : '';
                                        redirectWithRole(role);
                                    })
                                    .catch(() => redirectWithRole(''));
                            } else {
                                redirectWithRole('');
                            }
                        };

                        // Synchroniser l'utilisateur dans le localStorage avant redirection
                        if (typeof window.syncCurrentUser === 'function') {
                            window.syncCurrentUser(userCredential.user)
                                .then(finishRedirect)
                                .catch(finishRedirect);
                        } else {
                            finishRedirect();
                        }
                    })
                    .catch((error) => {
                        console.error("âŒ Erreur connexion:", error.code, error.message);
                        
                        let msg = "Erreur de connexion.";
                        if (error.code === 'auth/user-not-found') msg = "Compte introuvable.";
                        if (error.code === 'auth/wrong-password') msg = "Mot de passe incorrect.";
                        if (error.code === 'auth/invalid-email') msg = "Email invalide.";
                        if (error.code === 'auth/user-disabled') msg = "Compte désactivé.";
                        if (error.code === 'auth/too-many-requests') msg = "Trop de tentatives. Réessayez plus tard.";
                        
                        showToast("âš ï¸ " + msg, 'info');
                        
                        btn.innerText = originalText;
                        btn.disabled = false;
                    });
            });
        }
        
        // === MOT DE PASSE OUBLIÉ ===
        const forgotLink = document.getElementById('forgot-password-link');
        if(forgotLink) {
            forgotLink.addEventListener('click', function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                
                if (!email) {
                    showToast("âš ï¸ Veuillez entrer votre email", 'info');
                    return;
                }
                
                firebase.auth().sendPasswordResetEmail(email)
                    .then(() => {
                        window.showToast("✅ Email de réinitialisation envoyé à " + email, 'success');
                    })
                    .catch((error) => {
                        let msg = "Erreur: " + error.message;
                        if (error.code === 'auth/user-not-found') msg = "Compte introuvable.";
                        showToast("âš ï¸ " + msg, 'info');
                    });
            });
        }
        
        if(typeof lucide !== 'undefined') lucide.createIcons();
    });
  </script>

  <script src="assets/js/footer.js" defer></script>
</body>
</html>
