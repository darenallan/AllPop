<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Espace Vendeur — Aurum</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <link rel="stylesheet" href="assets/css/styles.css" />
    
    <style>
        /* --- CORRECTIF LAYOUT (PC vs Mobile) --- */
        @media (min-width: 900px) {
            body.admin-layout {
                display: grid !important;
                grid-template-columns: 260px 1fr !important;
                min-height: 100vh;
                margin: 0; padding: 0;
                overflow: hidden;
                background-color: #F9F7F2;
            }
            .admin-sidebar {
                display: flex !important;
                flex-direction: column;
                background-color: #050505 !important;
                color: #fff;
                height: 100vh;
                position: relative !important;
                z-index: 100;
                border-right: 1px solid rgba(212, 175, 55, 0.1);
            }
            .admin-main {
                height: 100vh;
                overflow-y: auto;
                padding: 40px 50px !important;
                background-color: #F9F7F2;
            }
            .admin-mobile-toggle { display: none !important; }
        }

        /* Styles Mobile */
        @media (max-width: 899px) {
            body.admin-layout { display: block !important; }
            .admin-sidebar { display: none; position: fixed; inset: 0; z-index: 999; }
            .admin-sidebar.mobile-open { display: flex !important; }
            .admin-main { padding: 20px; padding-top: 80px; }
            .admin-mobile-toggle { 
                display: flex !important; position: fixed; top: 15px; right: 15px; 
                background: #D4AF37; padding: 10px; border-radius: 50%; z-index: 2000; border: none; 
            }
        }

        /* Styles Généraux Admin/Vendeur */
        .admin-sidebar-header { padding: 40px 30px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .admin-sidebar-title { font-family: 'Playfair Display', serif; color: #D4AF37; font-size: 24px; margin: 0; }
        
        .admin-nav-item {
            display: flex; align-items: center; gap: 15px; padding: 16px 30px;
            color: #a0a0a0; text-decoration: none; font-family: 'Inter', sans-serif;
            font-size: 15px; transition: 0.3s; cursor: pointer; border-left: 3px solid transparent;
        }
        .admin-nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
        .admin-nav-item.active {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%);
            color: #D4AF37; border-left-color: #D4AF37;
        }

        .admin-card { background: #fff; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 30px; }
        .admin-page-title { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 10px; color: #111; }
        
        .input, select.input, textarea.input { width: 100%; padding: 12px 18px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; display: block; box-sizing: border-box; background: #fff; color: #000; }
        .btn-gold { background: #D4AF37; color: #000; font-weight: 600; padding: 14px 30px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        
        /* Liste Produits */
        .product-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; }
        .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; margin-right: 15px; }
        
        /* Utilitaires */
        .hidden { display: none !important; }
        .active-section { display: block !important; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>
<body class="admin-layout">

    <aside class="admin-sidebar" id="seller-sidebar">
        <div class="admin-sidebar-header">
            <h1 class="admin-sidebar-title">Aurum Seller</h1>
        </div>
        <nav>
            <div class="admin-nav-item active" onclick="nav('dashboard', this)">
                <i data-lucide="layout-grid"></i> Vue d'ensemble
            </div>
            <div class="admin-nav-item" onclick="nav('products', this)">
                <i data-lucide="package"></i> Mes Produits
            </div>
            <div class="admin-nav-item" onclick="nav('add', this)">
                <i data-lucide="plus-circle"></i> Ajouter un produit
            </div>
            <div class="admin-nav-item" onclick="nav('orders', this)">
                <i data-lucide="shopping-bag"></i> Commandes
            </div>
            <div class="admin-nav-item" onclick="nav('settings', this)">
                <i data-lucide="settings"></i> Paramètres
            </div>
            <a href="index.html" class="admin-nav-item" style="margin-top: 40px; color: #ff6b6b; border-top: 1px solid rgba(255,255,255,0.1);">
                <i data-lucide="log-out"></i> Déconnexion
            </a>
        </nav>
    </aside>

    <button class="admin-mobile-toggle" onclick="document.getElementById('seller-sidebar').classList.toggle('mobile-open')">
        <i data-lucide="menu"></i>
    </button>

    <main class="admin-main">
        
        <div id="loader" style="text-align: center; margin-top: 20%; color: #666;">
            <i data-lucide="loader" class="spin" style="animation: spin 1s infinite linear;"></i>
            <p style="margin-top: 10px;">Chargement de votre boutique...</p>
        </div>

        <div id="no-shop-warning" class="hidden" style="text-align: center; margin-top: 100px;">
            <div class="admin-card" style="max-width: 500px; margin: 0 auto; border-left: 4px solid red;">
                <h3 style="color:red;">⚠️ Aucune boutique trouvée</h3>
                <p>Aucune boutique n'est associée à l'email : <strong id="user-email-display">...</strong></p>
                <p style="font-size: 14px; color: #666;">Contactez l'administrateur pour qu'il crée votre boutique avec cet email exact.</p>
            </div>
        </div>

        <div id="seller-content" class="hidden">
            
            <section id="sec-dashboard" class="admin-section active-section">
                <h1 class="admin-page-title">Ma Boutique : <span id="shop-title-display" style="color: #D4AF37;">...</span></h1>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="admin-card" style="border-left: 5px solid #D4AF37; padding: 20px;">
                        <div style="text-transform: uppercase; font-size: 12px; color: #666;">Produits en ligne</div>
                        <div style="font-size: 32px; font-weight: 700;" id="stat-products">0</div>
                    </div>
                    <div class="admin-card" style="border-left: 5px solid #D4AF37; padding: 20px;">
                        <div style="text-transform: uppercase; font-size: 12px; color: #666;">Ventes (FCFA)</div>
                        <div style="font-size: 32px; font-weight: 700;">0</div>
                    </div>
                    <div class="admin-card" style="border-left: 5px solid #D4AF37; padding: 20px;">
                        <div style="text-transform: uppercase; font-size: 12px; color: #666;">Vues Totales</div>
                        <div style="font-size: 32px; font-weight: 700;">0</div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>État de la boutique</h3>
                    <p>Statut : <span id="shop-status-display" style="font-weight: bold; color: green;">Actif</span></p>
                    <p>Catégorie : <span id="shop-category-display">...</span></p>
                </div>
            </section>

            <section id="sec-products" class="admin-section hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 class="admin-page-title" style="margin: 0;">Mes Produits</h1>
                    <button class="btn-gold" style="width: auto; margin: 0;" onclick="nav('add', document.querySelectorAll('.admin-nav-item')[2])">
                        + Ajouter
                    </button>
                </div>
                <div class="admin-card">
                    <div id="products-list">Chargement...</div>
                </div>
            </section>

            <section id="sec-add" class="admin-section hidden">
                <h1 class="admin-page-title">Nouveau Produit</h1>
                <div class="admin-card">
                    <form id="form-add-product">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Nom du produit</label>
                                <input class="input" id="p-name" required placeholder="Ex: Montre Or">
                            </div>
                            <div>
                                <label>Prix (FCFA)</label>
                                <input class="input" id="p-price" type="number" required placeholder="50000">
                            </div>
                        </div>
                        
                        <label>Description</label>
                        <textarea class="input" id="p-desc" rows="4" placeholder="Détails du produit..."></textarea>
                        
                        <label>URL Image (Temporaire)</label>
                        <input class="input" id="p-img" placeholder="https://...">

                        <button class="btn-gold">Mettre en vente</button>
                    </form>
                </div>
            </section>

            <section id="sec-orders" class="admin-section hidden">
                <h1 class="admin-page-title">Commandes</h1>
                <div class="admin-card">
                    <p class="text-muted">Aucune commande pour le moment.</p>
                </div>
            </section>

            <section id="sec-settings" class="admin-section hidden">
                <h1 class="admin-page-title">Paramètres Boutique</h1>
                <div class="admin-card">
                    <form id="form-settings">
                        <label>Nom de la boutique</label>
                        <input class="input" id="set-name">
                        
                        <label>Email Propriétaire (Lecture seule)</label>
                        <input class="input" id="set-email" readonly style="background: #eee;">
                        
                        <label>Description Boutique</label>
                        <textarea class="input" id="set-desc" rows="3"></textarea>
                        
                        <button class="btn-gold">Enregistrer les modifications</button>
                    </form>
                </div>
            </section>

        </div>
    </main>

    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 3000;"></div>

    <script>
        // 1. CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBGmPM4OXEonp7qL78x20NC2DXvQW0lavU",
            authDomain: "aurum-bf.firebaseapp.com",
            projectId: "aurum-bf",
            storageBucket: "aurum-bf.firebasestorage.app",
            messagingSenderId: "858318726586",
            appId: "1:858318726586:web:14687fff6d4d08527a6983",
            measurementId: "G-SY7DY6WV97"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Variables Globales
        let myShop = null;

        // 2. DÉMARRAGE
        document.addEventListener('DOMContentLoaded', () => {
            
            auth.onAuthStateChanged((user) => {
                const loader = document.getElementById('loader');
                
                if (user) {
                    console.log("Connecté en tant que :", user.email);
                    
                    // RECHERCHE DE LA BOUTIQUE
                    // On cherche une boutique dont l'ownerEmail correspond à l'email connecté
                    db.collection('shops').where('ownerEmail', '==', user.email).get()
                    .then(snapshot => {
                        loader.style.display = 'none'; // Stop loader

                        if (!snapshot.empty) {
                            // Boutique trouvée !
                            myShop = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            console.log("Boutique chargée :", myShop.name);
                            
                            // Affichage
                            document.getElementById('seller-content').classList.remove('hidden');
                            
                            // Remplissage des infos
                            document.getElementById('shop-title-display').innerText = myShop.name;
                            document.getElementById('shop-status-display').innerText = myShop.status;
                            document.getElementById('shop-category-display').innerText = myShop.category;
                            
                            // Pré-remplir paramètres
                            document.getElementById('set-name').value = myShop.name;
                            document.getElementById('set-email').value = myShop.ownerEmail;
                            document.getElementById('set-desc').value = myShop.description || "";

                            // Lancer l'écoute des produits
                            listenProducts();

                        } else {
                            // Pas de boutique trouvée
                            document.getElementById('no-shop-warning').classList.remove('hidden');
                            document.getElementById('user-email-display').innerText = user.email;
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Erreur de connexion à la base de données.");
                    });

                } else {
                    // Pas connecté -> Login
                    window.location.href = "login.html";
                }
            });

            lucide.createIcons();
        });

        // 3. ÉCOUTE PRODUITS
        function listenProducts() {
            db.collection('products').where('shopId', '==', myShop.id)
            .onSnapshot(snap => {
                const list = document.getElementById('products-list');
                list.innerHTML = "";
                let count = 0;

                if (snap.empty) {
                    list.innerHTML = "<p style='color:#777; text-align:center;'>Aucun produit en ligne.</p>";
                }

                snap.forEach(doc => {
                    count++;
                    const p = doc.data();
                    list.innerHTML += `
                    <div class="product-item">
                        <div style="display:flex; align-items:center;">
                            <img src="${p.image || 'assets/img/placeholder-product.svg'}" class="product-img">
                            <div>
                                <div style="font-weight:bold;">${p.name}</div>
                                <div style="color:#D4AF37; font-weight:bold;">${p.price} FCFA</div>
                            </div>
                        </div>
                        <button onclick="delProduct('${doc.id}')" style="color:red; border:none; background:none; cursor:pointer;">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>`;
                });
                
                document.getElementById('stat-products').innerText = count;
                lucide.createIcons();
            });
        }

        // 4. ACTIONS
        
        // Ajouter Produit
        document.getElementById('form-add-product').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "Ajout...";
            btn.disabled = true;

            db.collection('products').add({
                shopId: myShop.id, // Lien avec la boutique
                shopName: myShop.name,
                name: document.getElementById('p-name').value,
                price: Number(document.getElementById('p-price').value),
                description: document.getElementById('p-desc').value,
                image: document.getElementById('p-img').value,
                category: myShop.category, // Hérite de la catégorie boutique
                createdAt: new Date()
            }).then(() => {
                alert("Produit ajouté !");
                e.target.reset();
                btn.innerText = "Mettre en vente";
                btn.disabled = false;
                // Retour liste
                nav('products', document.querySelectorAll('.admin-nav-item')[1]);
            }).catch(err => alert(err.message));
        });

        // Modifier Paramètres
        document.getElementById('form-settings').addEventListener('submit', (e) => {
            e.preventDefault();
            const newName = document.getElementById('set-name').value;
            const newDesc = document.getElementById('set-desc').value;

            db.collection('shops').doc(myShop.id).update({
                name: newName,
                description: newDesc
            }).then(() => {
                alert("Modifications enregistrées !");
                document.getElementById('shop-title-display').innerText = newName;
            });
        });

        // Supprimer Produit
        window.delProduct = (id) => {
            if(confirm("Supprimer ce produit ?")) {
                db.collection('products').doc(id).delete();
            }
        };

        // Navigation
        window.nav = (id, btn) => {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active-section'));
            
            document.getElementById('sec-'+id).classList.remove('hidden');
            document.getElementById('sec-'+id).classList.add('active-section');

            document.querySelectorAll('.admin-nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if(window.innerWidth < 900) document.getElementById('seller-sidebar').classList.remove('mobile-open');
        };

    </script>
</body>
</html>
