<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Espace Vendeur — Aurum</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <link rel="stylesheet" href="assets/css/styles.css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        /* Styles Dashboard Spécifiques */
        body.admin-layout { background-color: #F9F7F2; display: flex; min-height: 100vh; font-family: 'Inter', sans-serif; }
        
        /* Sidebar */
        .admin-sidebar { width: 260px; background-color: #050505; color: #fff; display: flex; flex-direction: column; position: fixed; height: 100vh; z-index: 100; transition: transform 0.3s; }
        .admin-sidebar-header { padding: 40px 30px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: center; }
        .admin-sidebar-title { font-family: 'Playfair Display', serif; color: #D4AF37; margin: 0; font-size: 24px; }
        .admin-nav-item { display: flex; align-items: center; gap: 15px; padding: 16px 30px; color: #a0a0a0; text-decoration: none; transition: 0.3s; cursor: pointer; border-left: 3px solid transparent; }
        .admin-nav-item:hover, .admin-nav-item.active { background: rgba(212, 175, 55, 0.1); color: #D4AF37; border-left-color: #D4AF37; }
        
        /* Main Content */
        .admin-main { flex: 1; margin-left: 260px; padding: 40px; overflow-y: auto; }
        .admin-card { background: #fff; border-radius: 12px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 30px; }
        .admin-page-title { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 20px; }

        /* Tableaux */
        .table-responsive { overflow-x: auto; }
        .admin-table { width: 100%; border-collapse: collapse; min-width: 600px; }
        .admin-table th { text-align: left; padding: 15px; color: #666; font-size: 13px; text-transform: uppercase; border-bottom: 2px solid #eee; }
        .admin-table td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: middle; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-pending { background: #fff3cd; color: #856404; }
        .badge-shipped { background: #d4edda; color: #155724; }
        
        /* Upload & Form */
        .input, textarea.input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 15px; display: block; box-sizing: border-box; }
        .btn-gold { background: #D4AF37; color: #000; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
        
        .upload-area { border: 2px dashed #ddd; padding: 30px; text-align: center; cursor: pointer; background: #fafafa; border-radius: 8px; }
        .preview-gallery { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
        .preview-item { width: 80px; height: 80px; position: relative; }
        .preview-item img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        
        .hidden { display: none !important; }
        .active-section { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }

        /* Mobile */
        @media(max-width: 900px) {
            .admin-sidebar { transform: translateX(-100%); }
            .admin-sidebar.open { transform: translateX(0); }
            .admin-main { margin-left: 0; padding: 20px; padding-top: 70px; }
            .mobile-toggle { display: block !important; position: fixed; top: 15px; right: 15px; z-index: 200; background: #D4AF37; padding: 10px; border-radius: 50%; border: none; }
        }
        .mobile-toggle { display: none; }
    </style>
</head>
<body class="admin-layout">

    <button class="mobile-toggle" onclick="document.querySelector('.admin-sidebar').classList.toggle('open')">
        <i data-lucide="menu"></i>
    </button>

    <aside class="admin-sidebar">
        <div class="admin-sidebar-header">
            <h1 class="admin-sidebar-title">Aurum Seller</h1>
        </div>
        <nav>
            <div class="admin-nav-item active" onclick="nav('dashboard', this)"><i data-lucide="layout-grid"></i> Vue d'ensemble</div>
            <div class="admin-nav-item" onclick="nav('orders', this)"><i data-lucide="shopping-bag"></i> Commandes <span id="nav-order-count" style="background:red; color:white; font-size:10px; padding:2px 6px; border-radius:10px; margin-left:auto; display:none;">0</span></div>
            <div class="admin-nav-item" onclick="nav('products', this)"><i data-lucide="package"></i> Mes Produits</div>
            <div class="admin-nav-item" onclick="nav('add', this)"><i data-lucide="plus-circle"></i> Ajouter Produit</div>
            <div class="admin-nav-item" onclick="nav('settings', this)"><i data-lucide="settings"></i> Ma Boutique</div>
            <a href="index.html" class="admin-nav-item" style="margin-top:auto; border-top:1px solid rgba(255,255,255,0.1); color:#ff6b6b;"><i data-lucide="log-out"></i> Déconnexion</a>
        </nav>
    </aside>

    <main class="admin-main">
        <div id="loader" style="text-align:center; margin-top:20vh;">
            <i data-lucide="loader" class="spin" style="animation:spin 1s infinite linear;"></i> Chargement...
        </div>

        <div id="seller-content" class="hidden">
            
            <section id="sec-dashboard" class="active-section">
                <h1 class="admin-page-title">Bonjour, <span id="shop-name-display">...</span></h1>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:20px; margin-bottom:30px;">
                    <div class="admin-card" style="border-left:4px solid #D4AF37;">
                        <div style="color:#666; font-size:12px; text-transform:uppercase;">Ventes Totales</div>
                        <div style="font-size:28px; font-weight:700;" id="stat-sales">0 FCFA</div>
                    </div>
                    <div class="admin-card" style="border-left:4px solid #D4AF37;">
                        <div style="color:#666; font-size:12px; text-transform:uppercase;">Commandes en cours</div>
                        <div style="font-size:28px; font-weight:700;" id="stat-orders">0</div>
                    </div>
                    <div class="admin-card" style="border-left:4px solid #D4AF37;">
                        <div style="color:#666; font-size:12px; text-transform:uppercase;">Produits</div>
                        <div style="font-size:28px; font-weight:700;" id="stat-products">0</div>
                    </div>
                </div>
            </section>

            <section id="sec-orders" class="hidden">
                <h1 class="admin-page-title">Mes Commandes</h1>
                <div class="admin-card">
                    <div class="table-responsive">
                        <table class="admin-table">
                            <thead>
                                <tr>
                                    <th>Réf</th>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Articles</th>
                                    <th>Total</th>
                                    <th>Statut</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="orders-list">
                                </tbody>
                        </table>
                    </div>
                    <div id="no-orders" style="text-align:center; padding:40px; color:#999; display:none;">
                        Aucune commande pour le moment.
                    </div>
                </div>
            </section>

            <section id="sec-products" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h1 class="admin-page-title" style="margin:0;">Mes Produits</h1>
                    <button class="btn-gold" onclick="nav('add')">+ Nouveau</button>
                </div>
                <div class="admin-card" id="products-list"></div>
            </section>

            <section id="sec-add" class="hidden">
                <h1 class="admin-page-title">Nouveau Produit</h1>
                <div class="admin-card">
                    <form id="form-add">
                        <label>Nom du produit</label>
                        <input class="input" id="p-name" required>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <div><label>Prix (FCFA)</label><input type="number" class="input" id="p-price" required></div>
                            <div>
                                <label>Catégorie</label>
                                <select class="input" id="p-cat">
                                    <option>Mode & Vêtements</option>
                                    <option>Électronique</option>
                                    <option>Maison & Déco</option>
                                    <option>Beauté & Hygiène</option>
                                    <option>Véhicules</option>
                                </select>
                            </div>
                        </div>
                        <label>Description</label>
                        <textarea class="input" id="p-desc" rows="4"></textarea>
                        
                        <label>Images</label>
                        <div class="upload-area" id="drop-zone">
                            <p>Cliquez pour ajouter des images</p>
                            <input type="file" id="p-files" multiple hidden accept="image/*">
                        </div>
                        <div class="preview-gallery" id="p-gallery"></div>

                        <button class="btn-gold" style="width:100%; margin-top:20px;">Publier</button>
                    </form>
                </div>
            </section>

            <section id="sec-settings" class="hidden">
                <h1 class="admin-page-title">Ma Boutique</h1>
                <div class="admin-card">
                    <form id="form-settings">
                        <label>Nom de la boutique</label>
                        <input class="input" id="s-name">
                        <label>Slogan</label>
                        <input class="input" id="s-slogan">
                        <button class="btn-gold">Enregistrer</button>
                    </form>
                </div>
            </section>

        </div>
    </main>

    <script>
        // CONFIG FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBGmPM4OXEonp7qL78x20NC2DXvQW0lavU",
            authDomain: "aurum-bf.firebaseapp.com",
            projectId: "aurum-bf",
            storageBucket: "aurum-bf.firebasestorage.app",
            messagingSenderId: "858318726586",
            appId: "1:858318726586:web:14687fff6d4d08527a6983"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let myShop = null;
        let productImages = [];

        // INIT
        auth.onAuthStateChanged(user => {
            if(user) {
                // Trouver la boutique du vendeur
                db.collection('shops').where('ownerEmail', '==', user.email).get().then(snap => {
                    document.getElementById('loader').style.display = 'none';
                    if(!snap.empty) {
                        myShop = { id: snap.docs[0].id, ...snap.docs[0].data() };
                        initDashboard();
                    } else {
                        alert("Aucune boutique associée à ce compte.");
                        window.location.href = "index.html";
                    }
                });
            } else {
                window.location.href = "login.html";
            }
        });

        function initDashboard() {
            document.getElementById('seller-content').classList.remove('hidden');
            document.getElementById('shop-name-display').innerText = myShop.name;
            
            // Pré-remplir settings
            document.getElementById('s-name').value = myShop.name;
            document.getElementById('s-slogan').value = myShop.slogan || "";

            listenOrders();
            listenProducts();
            lucide.createIcons();
        }

        // --- 1. ÉCOUTER LES COMMANDES (C'est ici la solution) ---
        function listenOrders() {
            // On écoute la collection 'seller_orders' pour ce shopId précis
            db.collection('seller_orders')
              .where('shopId', '==', myShop.id)
              .orderBy('createdAt', 'desc')
              .onSnapshot(snap => {
                  const list = document.getElementById('orders-list');
                  list.innerHTML = "";
                  
                  let totalSales = 0;
                  let pendingCount = 0;

                  if(snap.empty) {
                      document.getElementById('no-orders').style.display = 'block';
                  } else {
                      document.getElementById('no-orders').style.display = 'none';
                      snap.forEach(doc => {
                          const order = doc.data();
                          const date = new Date(order.createdAt.seconds * 1000).toLocaleDateString();
                          const statusClass = order.status === 'pending' ? 'badge-pending' : 'badge-shipped';
                          const statusText = order.status === 'pending' ? 'En attente' : 'Expédié';
                          
                          // Calcul stats
                          totalSales += order.totalToCollect;
                          if(order.status === 'pending') pendingCount++;

                          // Liste des articles
                          const itemsSummary = order.items.map(i => `${i.name} (x${i.qty})`).join(', ');

                          list.innerHTML += `
                            <tr>
                                <td>#${order.globalReference}</td>
                                <td>${date}</td>
                                <td>
                                    <strong>${order.clientName}</strong><br>
                                    <span style="font-size:12px; color:#999;">${order.clientPhone || ''}</span>
                                </td>
                                <td>${itemsSummary}</td>
                                <td style="font-weight:bold;">${new Intl.NumberFormat('fr-FR').format(order.totalToCollect)} FCFA</td>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                                <td>
                                    ${order.status === 'pending' ? 
                                    `<button class="btn-gold" style="font-size:12px; padding:5px 10px;" onclick="shipOrder('${doc.id}')">Expédier</button>` 
                                    : '<i data-lucide="check" style="color:green"></i>'}
                                </td>
                            </tr>
                          `;
                      });
                  }

                  // Update Stats
                  document.getElementById('stat-orders').innerText = pendingCount;
                  document.getElementById('stat-sales').innerText = new Intl.NumberFormat('fr-FR').format(totalSales) + " FCFA";
                  
                  // Notif rouge menu
                  const notif = document.getElementById('nav-order-count');
                  if(pendingCount > 0) {
                      notif.innerText = pendingCount;
                      notif.style.display = 'inline-block';
                  } else {
                      notif.style.display = 'none';
                  }
                  
                  lucide.createIcons();
              });
        }

        window.shipOrder = function(id) {
            if(confirm("Confirmer l'expédition de cette commande ?")) {
                db.collection('seller_orders').doc(id).update({
                    status: 'shipped'
                });
            }
        };

        // --- 2. GESTION PRODUITS (Simplifiée) ---
        function listenProducts() {
            db.collection('products').where('shopId', '==', myShop.id).onSnapshot(snap => {
                const list = document.getElementById('products-list');
                list.innerHTML = "";
                document.getElementById('stat-products').innerText = snap.size;
                
                snap.forEach(doc => {
                    const p = doc.data();
                    const img = p.image || 'assets/img/placeholder.png';
                    list.innerHTML += `
                        <div style="display:flex; align-items:center; border-bottom:1px solid #eee; padding:10px 0;">
                            <img src="${img}" style="width:50px; height:50px; border-radius:5px; object-fit:cover; margin-right:15px;">
                            <div style="flex:1;">
                                <div style="font-weight:600;">${p.name}</div>
                                <div style="color:#D4AF37;">${p.price} FCFA</div>
                            </div>
                            <button onclick="db.collection('products').doc('${doc.id}').delete()" style="color:red; background:none; border:none; cursor:pointer;"><i data-lucide="trash-2"></i></button>
                        </div>
                    `;
                });
                lucide.createIcons();
            });
        }

        // --- 3. UPLOAD & AJOUT PRODUIT ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('p-files');
        
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = (e) => {
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = ev => {
                    productImages.push(ev.target.result);
                    renderGallery();
                };
                reader.readAsDataURL(file);
            });
        };

        function renderGallery() {
            const gal = document.getElementById('p-gallery');
            gal.innerHTML = productImages.map((img, i) => `
                <div class="preview-item">
                    <img src="${img}">
                    <button onclick="productImages.splice(${i},1); renderGallery()" style="position:absolute; top:0; right:0; background:red; color:white; border:none;">x</button>
                </div>
            `).join('');
        }

        document.getElementById('form-add').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.innerText = "Publication...";

            db.collection('products').add({
                shopId: myShop.id,
                shopName: myShop.name,
                name: document.getElementById('p-name').value,
                price: Number(document.getElementById('p-price').value),
                category: document.getElementById('p-cat').value,
                description: document.getElementById('p-desc').value,
                images: productImages,
                image: productImages[0] || null,
                createdAt: new Date()
            }).then(() => {
                alert("Produit ajouté !");
                e.target.reset();
                productImages = [];
                renderGallery();
                btn.disabled = false;
                btn.innerText = "Publier";
                nav('products');
            });
        });

        // --- NAVIGATION ---
        window.nav = function(id, el) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.getElementById('sec-'+id).classList.remove('hidden');
            
            if(el) {
                document.querySelectorAll('.admin-nav-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            // Mobile close
            document.querySelector('.admin-sidebar').classList.remove('open');
        };

    </script>
</body>
</html>
