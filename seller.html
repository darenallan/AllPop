<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Espace Vendeur ‚Äî Aurum</title>
    
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.cloudfunctions.net; frame-ancestors 'none'; form-action 'self';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Strict-Transport-Security" content="max-age=31536000; includeSubDomains">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="assets/css/styles.css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js" crossorigin="anonymous"></script>
    
    <style>
        /* --- CORRECTIF LAYOUT (PC vs Mobile) --- */
        @media (min-width: 900px) {
            body.admin-layout {
                display: grid !important;
                grid-template-columns: 260px 1fr !important;
                grid-template-rows: auto 1fr;
                min-height: 100vh;
                margin: 0; padding: 0;
                overflow: hidden;
                background-color: #F9F7F2;
            }
            .admin-layout .header {
                grid-column: 1 / -1;
                z-index: 500;
            }
            .admin-sidebar {
                display: flex !important;
                flex-direction: column;
                background-color: #050505 !important;
                color: #fff;
                height: 100%;
                min-height: 0;
                position: relative !important;
                z-index: 100;
                border-right: 1px solid rgba(212, 175, 55, 0.1);
                grid-row: 2;
            }
            .admin-main {
                height: 100%;
                min-height: 0;
                overflow-y: auto;
                padding: 40px 50px !important;
                background-color: #F9F7F2;
                grid-row: 2;
            }
            .admin-mobile-toggle { display: none !important; }
        }

        /* FIX SCROLLING */
        body.admin-layout {
            overflow: auto !important;
        }
        .admin-main {
            overflow: auto !important;
            max-height: 100vh;
        }
        /* Styles Mobile */
        @media (max-width: 899px) {
            body.admin-layout { display: block !important; }
            .admin-sidebar { display: none; position: fixed; inset: 0; z-index: 999; }
            .admin-sidebar.mobile-open { display: flex !important; }
            .admin-main { padding: 20px; padding-top: 80px; }
            .admin-mobile-toggle { 
                display: flex !important; position: fixed; top: 15px; right: 15px; 
                background: #D4AF37; padding: 10px; border-radius: 50%; z-index: 2000; border: none; 
            }
        }

        /* Styles G√©n√©raux Admin/Vendeur */
        .admin-sidebar-header { padding: 40px 30px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: center; }
        .admin-sidebar-title { font-family: 'Playfair Display', serif; color: #D4AF37; font-size: 24px; margin: 0; }
        
        .admin-nav-item {
            display: flex; align-items: center; gap: 15px; padding: 16px 30px;
            color: #a0a0a0; text-decoration: none; font-family: 'Inter', sans-serif;
            font-size: 15px; transition: 0.3s; cursor: pointer; border-left: 3px solid transparent;
        }
        .admin-nav-item:hover { background: rgba(255,255,255,0.03); color: #fff; }
        .admin-nav-item.active {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.15) 0%, transparent 100%);
            color: #D4AF37; border-left-color: #D4AF37;
        }

        .admin-card { background: #fff; border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); margin-bottom: 30px; }
        .admin-page-title { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 10px; color: #111; }
        
        .input, select.input, textarea.input { width: 100%; padding: 12px 18px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; display: block; box-sizing: border-box; background: #fff; color: #000; }
        .btn-gold { background: #D4AF37; color: #000; font-weight: 600; padding: 14px 30px; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }
        
        /* Liste Produits */
        .product-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; }
        .product-img { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; background: #eee; margin-right: 15px; }
        
        /* Commandes */
        .order-card-seller {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .order-card-seller-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .order-card-seller-id {
            font-family: 'Playfair Display', serif;
            font-size: 18px;
            font-weight: 600;
            color: #000;
        }
        .order-card-seller-date {
            font-size: 13px;
            color: #999;
        }
        .order-status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .order-status-badge.pending { background: #fff3cd; color: #856404; }
        .order-status-badge.shipped { background: #cfe2ff; color: #084298; }
        .order-status-badge.delivered { background: #d1e7dd; color: #0f5132; }
        .order-status-badge.cancelled { background: #f8d7da; color: #842029; }
        
        .order-items-seller {
            margin-bottom: 15px;
        }
        .order-item-seller {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .order-item-seller:last-child {
            border-bottom: none;
        }
        .order-item-name-seller {
            flex: 1;
            color: #333;
        }
        .order-item-qty-seller {
            color: #999;
            margin: 0 10px;
            font-size: 13px;
        }
        .order-item-price-seller {
            font-weight: 600;
            color: #D4AF37;
            min-width: 80px;
            text-align: right;
        }
        
        .order-footer-seller {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .order-total-seller {
            font-size: 18px;
            font-weight: 600;
            color: #000;
        }
        .order-total-seller strong {
            color: #D4AF37;
        }
        
        .order-actions-seller {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .status-select {
            padding: 8px 12px;
            border: 1px solid #D4AF37;
            border-radius: 6px;
            background: #fff;
            color: #000;
            font-weight: 500;
            cursor: pointer;
            transition: 0.3s;
        }
        .status-select:hover {
            background: #fffbf0;
        }
        .btn-update-order {
            padding: 8px 16px;
            background: #D4AF37;
            color: #000;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: 0.3s;
        }
        .btn-update-order:hover {
            background: #bfa030;
        }
        .btn-update-order:disabled {
            background: #ddd;
            cursor: not-allowed;
            color: #999;
        }
        
        /* Utilitaires */
        .hidden { display: none !important; }
        .active-section { display: block !important; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from{opacity:0;} to{opacity:1;} }
        @keyframes slideIn { from{transform: translateX(400px); opacity:0;} to{transform: translateX(0); opacity:1;} }

        /* --- NOUVEAU STYLE UPLOAD --- */
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            background: #fdfdfd;
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .upload-area:hover, .upload-area.dragover {
            border-color: #D4AF37;
            background: rgba(212, 175, 55, 0.05);
        }
        
        /* Galerie de pr√©visualisation */
        .preview-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }
        .preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            background: #fff;
        }
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .preview-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .preview-remove:hover {
            background: red;
        }

        /* Upload Profile Hover Effect */
        .upload-area-mini:hover { border-color: #D4AF37 !important; }
        .upload-area-mini:hover div { opacity: 1 !important; }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>
<body class="admin-layout">

    <aside class="admin-sidebar" id="seller-sidebar">
        <div class="admin-sidebar-header">
            <h1 class="admin-sidebar-title">Aurum Seller</h1>
        </div>
        <nav style="display: flex; flex-direction: column; height: 100%; overflow-y: auto;">
            <div>
                <div class="admin-nav-item active" onclick="nav('dashboard', this)">
                    <i data-lucide="layout-grid"></i> Vue d'ensemble
                </div>
                <div class="admin-nav-item" onclick="nav('products', this)">
                    <i data-lucide="package"></i> Mes Produits
                </div>
                <div class="admin-nav-item" onclick="nav('add', this)">
                    <i data-lucide="plus-circle"></i> Ajouter un produit
                </div>
                <div class="admin-nav-item" onclick="nav('orders', this)">
                    <i data-lucide="shopping-bag"></i> Commandes
                </div>
                <div class="admin-nav-item" onclick="nav('settings', this)">
                    <i data-lucide="settings"></i> Param√®tres
                </div>
            </div>
            <div style="margin-top: auto; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                <a href="index.html" class="admin-nav-item" style="text-decoration: none;">
                    <i data-lucide="home"></i> Retour √† l'accueil
                </a>
                <div class="admin-nav-item" onclick="logout()" style="cursor: pointer;">
                    <i data-lucide="log-out"></i> D√©connexion
                </div>
            </div>
        </nav>
    </aside>

    <button class="admin-mobile-toggle" onclick="document.getElementById('seller-sidebar').classList.toggle('mobile-open')">
        <i data-lucide="menu"></i>
    </button>

    <main class="admin-main">
        
        <div id="loader" style="text-align: center; margin-top: 20%; color: #666;">
            <i data-lucide="loader" class="spin" style="animation: spin 1s infinite linear;"></i>
            <p style="margin-top: 10px;">Chargement de votre boutique...</p>
        </div>

        <div id="no-shop-warning" class="hidden" style="text-align: center; margin-top: 100px;">
            <div class="admin-card" style="max-width: 500px; margin: 0 auto; border-left: 4px solid red;">
                <h3 style="color:red;">‚ö†Ô∏è Aucune boutique trouv√©e</h3>
                <p>Aucune boutique n'est associ√©e √† l'email : <strong id="user-email-display">...</strong></p>
                <p style="font-size: 14px; color: #666;">Contactez l'administrateur pour qu'il cr√©e votre boutique avec cet email exact.</p>
            </div>
        </div>

        <div id="seller-content" class="hidden">
            
            <section id="sec-dashboard" class="admin-section active-section">
                <h1 class="admin-page-title">Ma Boutique : <span id="shop-title-display" style="color: #D4AF37;">...</span></h1>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div class="admin-card" style="border-left: 5px solid #D4AF37; padding: 20px;">
                        <div style="text-transform: uppercase; font-size: 12px; color: #666;">Produits en ligne</div>
                        <div style="font-size: 32px; font-weight: 700;" id="stat-products">0</div>
                    </div>
                    <div class="admin-card" style="border-left: 5px solid #D4AF37; padding: 20px;">
                        <div style="text-transform: uppercase; font-size: 12px; color: #666;">Ventes (FCFA)</div>
                        <div style="font-size: 32px; font-weight: 700;" id="stat-sales">0</div>
                    </div>
                    <div class="admin-card" style="border-left: 5px solid #D4AF37; padding: 20px;">
                        <div style="text-transform: uppercase; font-size: 12px; color: #666;">Vues Totales</div>
                        <div style="font-size: 32px; font-weight: 700;">0</div>
                    </div>
                </div>

                <div class="admin-card">
                    <h3>√âtat de la boutique</h3>
                    <p>Statut : <span id="shop-status-display" style="font-weight: bold; color: green;">Actif</span> <span id="shop-days-remaining" style="font-size: 13px; color: #666;"></span></p>
                    <p>Cat√©gorie : <span id="shop-category-display">...</span></p>
                </div>
            </section>

            <section id="sec-products" class="admin-section hidden">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h1 class="admin-page-title" style="margin: 0;">Mes Produits</h1>
                    <button class="btn-gold" style="width: auto; margin: 0;" onclick="nav('add', document.querySelectorAll('.admin-nav-item')[2])">
                        + Ajouter
                    </button>
                </div>
                <div class="admin-card">
                    <div id="products-list">Chargement...</div>
                </div>
            </section>

            <section id="sec-add" class="admin-section hidden">
                <h1 class="admin-page-title">Nouveau Produit</h1>
                <div class="admin-card">
                    <form id="form-add-product">
                        <!-- SECTION 1: Informations de base -->
                        <div style="border-left: 4px solid #D4AF37; padding-left: 16px; margin-bottom: 24px;">
                            <h3 style="margin-top: 0; color: #333;">üìã Informations de base</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <label>Nom du produit <span style="color: red;">*</span></label>
                                    <input class="input" id="p-name" required placeholder="Ex: iPhone 13 Pro">
                                </div>
                                <div>
                                    <label>Prix unitaire (FCFA) <span style="color: red;">*</span></label>
                                    <input class="input" id="p-price" type="number" required placeholder="50000" min="0">
                                </div>
                            </div>
                            
                            <label>Description <span style="color: red;">*</span></label>
                            <textarea class="input" id="p-desc" rows="4" required placeholder="D√©crivez votre produit en d√©tail..."></textarea>
                            
                            <label>Cat√©gorie <span style="color: red;">*</span></label>
                            <select class="input" id="p-cat" required>
                                <option value="">-- S√©lectionner --</option>
                            </select>
                        </div>

                        <!-- SECTION 2: Champs dynamiques selon cat√©gorie -->
                        <div id="dynamic-fields" style="margin-bottom: 24px;"></div>

                        <!-- SECTION 3: Gestion des stocks (TOUJOURS VISIBLE) -->
                        <div style="border-left: 4px solid #10b981; padding-left: 16px; margin-bottom: 24px;">
                            <h3 style="margin-top: 0; color: #333;">üì¶ Gestion des Stocks</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label>SKU (R√©f√©rence) <span style="color: red;">*</span></label>
                                    <input class="input" id="p-sku" required placeholder="Ex: PRD-001">
                                </div>
                                <div>
                                    <label>Quantit√© en stock <span style="color: red;">*</span></label>
                                    <input class="input" id="p-stock" type="number" required placeholder="100" min="0">
                                </div>
                                <div>
                                    <label>Seuil d'alerte stock</label>
                                    <input class="input" id="p-min-stock" type="number" placeholder="10" min="0" value="5">
                                </div>
                            </div>
                        </div>
                        
                        <!-- SECTION 4: Photos -->
                        <div style="border-left: 4px solid #3b82f6; padding-left: 16px; margin-bottom: 24px;">
                            <h3 style="margin-top: 0; color: #333;">üì∏ Photos du produit</h3>
                            <label>Images (Max 5) <span style="color: red;">*</span></label>
                            <div class="upload-area" id="drop-zone">
                                <input type="file" id="p-files" accept="image/*" multiple hidden>
                                <div class="upload-content" id="upload-content">
                                    <i data-lucide="image-plus" style="width: 48px; height: 48px; color: #D4AF37; margin-bottom: 10px;"></i>
                                    <p style="margin: 0; font-weight: 500;">Glissez vos images ici ou <span style="color: #D4AF37; cursor: pointer; text-decoration: underline;">parcourez</span></p>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">JPG, PNG (Max 2Mo par image)</p>
                                </div>
                            </div>
                            <div id="preview-gallery" class="preview-gallery"></div>
                        </div>

                        <button class="btn-gold" id="btn-submit-product" type="submit" style="margin-top: 20px;">
                            <i data-lucide="plus-circle" style="width: 20px; height: 20px;"></i> Mettre en vente
                        </button>
                    </form>
                </div>
            </section>

            <section id="sec-orders" class="admin-section hidden">
                <h1 class="admin-page-title">Commandes</h1>
                <div class="admin-card">
                    <div id="orders-loader" style="text-align:center; padding:40px;">
                        <p class="text-muted">Chargement des commandes...</p>
                    </div>
                    <div id="orders-container" style="display:none;">
                        <div id="orders-retention-controls" style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                            <span id="seller-retention-note" style="color:#666; font-size:13px;">Les commandes livr√©es/annul√©es sont automatiquement supprim√©es apr√®s 30 jours.</span>
                            <span class="retention-help" tabindex="0" aria-label="Aide sur la conservation" style="position:relative; display:inline-flex; align-items:center; cursor:help; color:#666;">
                                <i data-lucide="help-circle"></i>
                                <span class="tooltip-content" style="position:absolute; left:0; top:130%; background:#111; color:#fff; padding:8px 10px; border-radius:6px; font-size:12px; width:280px; box-shadow:0 6px 16px rgba(0,0,0,0.2); opacity:0; pointer-events:none; transform:translateY(4px); transition:opacity .15s, transform .15s; z-index:10;">
                                    Les commandes livr√©es ou annul√©es sont supprim√©es automatiquement apr√®s la p√©riode d√©finie. Cela permet de garder votre historique propre. Cette action est d√©finitive.
                                </span>
                            </span>
                            <script>
                              (function(){
                                const el = document.currentScript.previousElementSibling;
                                if (!el) return;
                                const show = () => { const t = el.querySelector('.tooltip-content'); if (t){ t.style.opacity='1'; t.style.transform='translateY(0)'; } };
                                const hide = () => { const t = el.querySelector('.tooltip-content'); if (t){ t.style.opacity='0'; t.style.transform='translateY(4px)'; } };
                                el.addEventListener('mouseenter', show);
                                el.addEventListener('mouseleave', hide);
                                el.addEventListener('focus', show);
                                el.addEventListener('blur', hide);
                              })();
                            </script>
                            <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                                <label for="sellerRetentionDaysInput" style="font-size:12px; color:#666;">Conservation (jours):</label>
                                <input type="number" id="sellerRetentionDaysInput" min="7" max="180" step="1" style="width:80px; padding:6px 8px; border:1px solid #ddd; border-radius:6px;" />
                            </div>
                        </div>
                        <div id="orders-list"></div>
                    </div>
                </div>
            </section>

            <section id="sec-settings" class="admin-section hidden">
                <h1 class="admin-page-title">Ma Vitrine</h1>
                <div class="admin-card">
                    <form id="form-settings">
                        
                        <h3 style="margin-top:0;">Identit√© Visuelle</h3>
                        <p class="text-muted" style="font-size:13px; margin-bottom:20px;">Personnalisez l'apparence de votre boutique.</p>

                        <div style="display:flex; gap:20px; flex-wrap:wrap;">
                            <div style="text-align:center;">
                                <label style="display:block; margin-bottom:8px;">Logo</label>
                                <div class="upload-area-mini" id="upload-logo" style="width:100px; height:100px; border-radius:50%; border:2px dashed #ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; position:relative; margin:0 auto;">
                                    <img id="preview-logo" src="assets/img/placeholder.png" style="width:100%; height:100%; object-fit:cover;">
                                    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; color:white; opacity:0; transition:0.2s;">
                                        <i data-lucide="camera"></i>
                                    </div>
                                </div>
                                <input type="file" id="file-logo" accept="image/*" hidden>
                            </div>

                            <div style="flex:1; min-width:200px;">
                                <label style="display:block; margin-bottom:8px;">Banni√®re</label>
                                <div class="upload-area-mini" id="upload-banner" style="width:100%; height:120px; border-radius:10px; border:2px dashed #ddd; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; position:relative;">
                                    <img id="preview-banner" src="assets/img/placeholder-banner.jpg" style="width:100%; height:100%; object-fit:cover;">
                                    <div style="position:absolute; inset:0; background:rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center; color:white; opacity:0; transition:0.2s;">
                                        <i data-lucide="image"></i> Modifier
                                    </div>
                                </div>
                                <input type="file" id="file-banner" accept="image/*" hidden>
                            </div>
                        </div>

                        <hr style="border:0; border-top:1px solid #eee; margin:30px 0;">

                        <h3>Informations</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Nom de la boutique</label>
                                <input class="input" id="set-name" required>
                            </div>
                            <div>
                                <label>Slogan</label>
                                <input class="input" id="set-slogan" placeholder="Ex: L'√©l√©gance au quotidien">
                            </div>
                        </div>

                        <div>
                            <label>Description compl√®te</label>
                            <textarea class="input" id="set-desc" rows="4" placeholder="Parlez de votre histoire..."></textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label>Email Contact</label>
                                <input class="input" id="set-email" readonly style="background:#eee;">
                            </div>
                            <div>
                                <label>T√©l√©phone / WhatsApp</label>
                                <input class="input" id="set-phone" placeholder="+226...">
                            </div>
                        </div>

                        <div style="text-align:right; margin-top:20px;">
                            <button class="btn-gold" type="submit" style="width:auto; padding:12px 40px;">Enregistrer les modifications</button>
                        </div>
                    </form>
                </div>
            </section>

        </div>
    </main>

    <div id="toast-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 3000;"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="assets/js/product-form.js"></script>
    
    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBGmPM4OXEonp7qL78x20NC2DXvQW0lavU",
            authDomain: "aurum-bf.firebaseapp.com",
            projectId: "aurum-bf",
            storageBucket: "aurum-bf.firebasestorage.app",
            messagingSenderId: "858318726586",
            appId: "1:858318726586:web:14687fff6d4d08527a6983",
            measurementId: "G-SY7DY6WV97"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        // Retention des commandes compl√©t√©es (jours)
        const ORDER_RETENTION_DAYS = 30;

        // Variables Globales
        let myShop = null;
        let productImages = [];
        let logoBase64 = "";
        let bannerBase64 = "";

        // D√âMARRAGE
        document.addEventListener('DOMContentLoaded', () => {
            
            auth.onAuthStateChanged((user) => {
                const loader = document.getElementById('loader');
                
                if (user) {
                    // Timeout de s√©curit√© (10 secondes max)
                    const timeoutId = setTimeout(() => {
                        console.error('Timeout: Boutique non trouv√©e apr√®s 10s');
                        loader.style.display = 'none';
                        document.getElementById('no-shop-warning').classList.remove('hidden');
                        document.getElementById('user-email-display').innerText = user.email;
                    }, 10000);

                    // RECHERCHE BOUTIQUE
                    db.collection('shops').where('ownerEmail', '==', user.email).get()
                    .then(snapshot => {
                        clearTimeout(timeoutId);
                        loader.style.display = 'none';

                        if (!snapshot.empty) {
                            myShop = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                            
                            document.getElementById('seller-content').classList.remove('hidden');
                            document.getElementById('shop-title-display').innerText = myShop.name;
                            document.getElementById('shop-status-display').innerText = myShop.status;
                            document.getElementById('shop-category-display').innerText = myShop.category;
                            
                            // Afficher les jours restants
                            updateShopRemainingDays();
                            
                            loadShopSettings();
                            listenProducts();
                            loadCategories();
                            setupDynamicAttributes();
                            // Calculer les ventes initiales
                            updateSellerSales();
                        } else {
                            document.getElementById('no-shop-warning').classList.remove('hidden');
                            document.getElementById('user-email-display').innerText = user.email;
                        }
                    })
                    .catch(error => {
                        clearTimeout(timeoutId);
                        console.error('Erreur Firestore:', error);
                        loader.style.display = 'none';
                        document.getElementById('no-shop-warning').classList.remove('hidden');
                        document.getElementById('user-email-display').innerText = user.email + ' (Erreur: ' + error.message + ')';
                    });
                } else {
                    window.location.href = "login.html";
                }
            });

            lucide.createIcons();
            setupProductUpload();
            setupProfileUpload();
            // Lancer une purge en t√¢che de fond au chargement de la page
            purgeOldCompletedOrders(getRetentionDays());
        });

        // CHARGER CAT√âGORIES
        function loadCategories() {
            const catSelect = document.getElementById('p-cat');
            if (!catSelect) return;

            db.collection('categories').get().then(snap => {
                snap.forEach(doc => {
                    const cat = doc.data();
                    catSelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            }).catch(err => console.error('Erreur chargement cat√©gories:', err));
        }

        // √âCOUTE PRODUITS
        function listenProducts() {
            db.collection('products').where('shopId', '==', myShop.id)
            .onSnapshot(snap => {
                const list = document.getElementById('products-list');
                list.innerHTML = "";
                let count = 0;

                if (snap.empty) {
                    list.innerHTML = "<p style='color:#777; text-align:center;'>Aucun produit en ligne.</p>";
                }

                snap.forEach(doc => {
                    count++;
                    const p = doc.data();
                    const displayImg = (p.images && p.images.length > 0) ? p.images[0] : (p.image || 'assets/img/placeholder.png');
                    
                    list.innerHTML += `
                    <div class="product-item">
                        <div style="display:flex; align-items:center;">
                            <img src="${displayImg}" class="product-img">
                            <div>
                                <div style="font-weight:bold;">${p.name}</div>
                                <div style="color:#D4AF37; font-weight:bold;">${p.price} FCFA</div>
                            </div>
                        </div>
                        <button onclick="delProduct('${doc.id}')" style="color:red; border:none; background:none; cursor:pointer;">
                            <i data-lucide="trash-2"></i>
                        </button>
                    </div>`;
                });
                
                document.getElementById('stat-products').innerText = count;
                lucide.createIcons();
            });
        }

        // CALCULER LES VENTES (commandes livr√©es, uniquement les articles de cette boutique)
        async function updateSellerSales() {
            try {
                if (!myShop) return;

                // R√©cup√©rer les produits du vendeur
                const prodSnap = await db.collection('products').where('shopId', '==', myShop.id).get();
                const vendorProductIds = prodSnap.docs.map(d => d.id);
                if (vendorProductIds.length === 0) {
                    document.getElementById('stat-sales').innerText = '0';
                    return;
                }

                // R√©cup√©rer toutes les commandes et filtrer c√¥t√© client
                const orderSnap = await db.collection('orders').get();
                let sales = 0;

                orderSnap.forEach(doc => {
                    const o = doc.data();
                    if ((o.status || 'pending') !== 'delivered') return;
                    const items = Array.isArray(o.items) ? o.items : [];
                    items.forEach(it => {
                        if (vendorProductIds.includes(it.id)) {
                            const qty = Number(it.qty || 1);
                            const price = Number(it.price || 0);
                            sales += qty * price;
                        }
                    });
                });

                document.getElementById('stat-sales').innerText = new Intl.NumberFormat('fr-FR').format(sales);
            } catch (err) {
                console.error('Erreur calcul ventes:', err);
            }
        }

        // PURGE DES COMMANDES LIVR√âES/ANNUL√âES APR√àS X JOURS
        async function purgeOldCompletedOrders(retentionDays = ORDER_RETENTION_DAYS) {
            try {
                const cutoff = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000);
                const snap = await db.collection('orders').get();
                let deleted = 0;

                for (const doc of snap.docs) {
                    const o = doc.data();
                    const status = (o.status || 'pending').toLowerCase();
                    if (status !== 'delivered' && status !== 'cancelled') continue;

                    const updated = o.updatedAt?.toDate?.() || (o.createdAt?.toDate?.() || new Date(0));
                    if (updated < cutoff) {
                        await db.collection('orders').doc(doc.id).delete();
                        deleted++;
                    }
                }

                if (deleted > 0) {
                    showToast(`üßπ ${deleted} commande(s) anciennes supprim√©es`, 'info');
                    // Mettre √† jour les ventes apr√®s purge
                    updateSellerSales();
                    // Recharger la liste si visible
                    const ordersSectionVisible = !document.getElementById('sec-orders').classList.contains('hidden');
                    if (ordersSectionVisible) loadSellerOrders();
                }
            } catch (err) {
                console.error('Erreur purge commandes:', err);
            }
        }

        // Obtenir la valeur de r√©tention configur√©e (partag√©e seller/client)
        function getRetentionDays() {
            const v = Number(localStorage.getItem('ac_order_retention_days'));
            return Number.isFinite(v) && v >= 1 ? v : ORDER_RETENTION_DAYS;
        }

        // Mettre √† jour l'affichage des jours restants pour la boutique
        function updateShopRemainingDays() {
            const displayEl = document.getElementById('shop-days-remaining');
            if (!displayEl || !myShop) return;
            
            if (!myShop.expiresAt) {
                displayEl.innerText = '(Dur√©e non d√©finie)';
                displayEl.style.color = '#999';
                return;
            }
            
            try {
                const expiryDate = myShop.expiresAt.toDate ? myShop.expiresAt.toDate() : new Date(myShop.expiresAt);
                const now = new Date();
                const diffTime = expiryDate - now;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays < 0) {
                    displayEl.innerText = '(Expir√©e)';
                    displayEl.style.color = '#b91c1c';
                } else if (diffDays === 0) {
                    displayEl.innerText = '(Expire aujourd\'hui)';
                    displayEl.style.color = '#d97706';
                } else if (diffDays <= 7) {
                    displayEl.innerText = `(${diffDays} jour${diffDays > 1 ? 's' : ''} restant${diffDays > 1 ? 's' : ''})`;
                    displayEl.style.color = '#d97706';
                } else {
                    displayEl.innerText = `(${diffDays} jours restants)`;
                    displayEl.style.color = '#666';
                }
            } catch (e) {
                console.error('Erreur calcul jours restants:', e);
                displayEl.innerText = '';
            }
        }

        // Mettre √† jour l'UI de r√©tention c√¥t√© vendeur
        function updateSellerRetentionUI() {
            const input = document.getElementById('sellerRetentionDaysInput');
            const note = document.getElementById('seller-retention-note');
            const days = getRetentionDays();
            if (note) note.innerText = `Les commandes livr√©es/annul√©es sont automatiquement supprim√©es apr√®s ${days} jours.`;
            if (!input) return;
            input.value = days;
            input.onchange = async (e) => {
                const val = Math.max(7, Math.min(180, Number(e.target.value || ORDER_RETENTION_DAYS)));
                localStorage.setItem('ac_order_retention_days', String(val));
                if (note) note.innerText = `Les commandes livr√©es/annul√©es sont automatiquement supprim√©es apr√®s ${val} jours.`;
                try {
                    await purgeOldCompletedOrders(val);
                    updateSellerSales();
                    loadSellerOrders();
                } catch (err) {
                    console.warn('Erreur purge apr√®s changement de r√©tention (seller):', err);
                }
            };
        }

        // CHARGER CAT√âGORIES
        function loadCategories() {
            const catSelect = document.getElementById('p-cat');
            if (!catSelect) return;

            db.collection('categories').get().then(snap => {
                snap.forEach(doc => {
                    const cat = doc.data();
                    catSelect.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            }).catch(err => console.error('Erreur chargement cat√©gories:', err));
        }

        // UPLOAD PRODUIT
        function setupProductUpload() {
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('p-files');

            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                handleProductFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', () => handleProductFiles(fileInput.files));
        }

        function handleProductFiles(files) {
            if (productImages.length + files.length > 5) {
                alert("Maximum 5 images autoris√©es.");
                return;
            }

            Array.from(files).forEach(file => {
                if (!file.type.startsWith('image/')) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    productImages.push(e.target.result);
                    renderProductGallery();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderProductGallery() {
            const gallery = document.getElementById('preview-gallery');
            gallery.innerHTML = "";
            productImages.forEach((img, index) => {
                gallery.innerHTML += `
                    <div class="preview-item">
                        <img src="${img}">
                        <button type="button" class="preview-remove" onclick="removeProductImage(${index})">&times;</button>
                    </div>`;
            });
        }

        window.removeProductImage = (index) => {
            productImages.splice(index, 1);
            renderProductGallery();
        };

        // UPLOAD PROFIL
        function setupProfileUpload() {
            const logoZone = document.getElementById('upload-logo');
            const logoInput = document.getElementById('file-logo');
            logoZone.addEventListener('click', () => logoInput.click());
            logoInput.addEventListener('change', () => {
                if(logoInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        logoBase64 = e.target.result;
                        document.getElementById('preview-logo').src = logoBase64;
                    };
                    reader.readAsDataURL(logoInput.files[0]);
                }
            });

            const bannerZone = document.getElementById('upload-banner');
            const bannerInput = document.getElementById('file-banner');
            bannerZone.addEventListener('click', () => bannerInput.click());
            bannerInput.addEventListener('change', () => {
                if(bannerInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        bannerBase64 = e.target.result;
                        document.getElementById('preview-banner').src = bannerBase64;
                    };
                    reader.readAsDataURL(bannerInput.files[0]);
                }
            });
        }

        function loadShopSettings() {
            if(myShop) {
                document.getElementById('set-name').value = myShop.name || "";
                document.getElementById('set-email').value = myShop.ownerEmail || "";
                document.getElementById('set-desc').value = myShop.description || "";
                document.getElementById('set-slogan').value = myShop.slogan || "";
                document.getElementById('set-phone').value = myShop.phone || "";
                
                if(myShop.logo) {
                    document.getElementById('preview-logo').src = myShop.logo;
                    logoBase64 = myShop.logo;
                }
                if(myShop.banner) {
                    document.getElementById('preview-banner').src = myShop.banner;
                    bannerBase64 = myShop.banner;
                }
            }
        }

        // CHARGER LES COMMANDES DU VENDEUR
        function loadSellerOrders() {
            if (!myShop) return;

            const loader = document.getElementById('orders-loader');
            const container = document.getElementById('orders-container');
            const list = document.getElementById('orders-list');

            loader.style.display = 'block';
            container.style.display = 'none';

            db.collection('orders').get().then(snapshot => {
                const allOrders = [];
                const productMap = {}; // Cache des produits pour la recherche rapide

                // D'abord, r√©cup√©rer tous les produits du vendeur
                db.collection('products').where('shopId', '==', myShop.id).get().then(prodSnap => {
                    const vendorProductIds = prodSnap.docs.map(d => d.id);

                    // Ensuite, filtrer les commandes qui contiennent les produits du vendeur
                    snapshot.forEach(doc => {
                        const order = { id: doc.id, ...doc.data() };
                        const hasVendorProduct = order.items?.some(item => vendorProductIds.includes(item.id));
                        
                        if (hasVendorProduct) {
                            allOrders.push(order);
                        }
                    });

                    if (allOrders.length === 0) {
                        list.innerHTML = '<p class="text-muted" style="text-align:center; padding:40px;">Aucune commande pour le moment.</p>';
                        loader.style.display = 'none';
                        container.style.display = 'block';
                        return;
                    }

                    // Trier par priorit√© de statut puis par date (livr√©es en bas)
                    const prio = { pending: 0, shipped: 1, delivered: 2, cancelled: 3 };
                    allOrders.sort((a, b) => {
                        const pa = prio[(a.status || 'pending')];
                        const pb = prio[(b.status || 'pending')];
                        if (pa !== pb) return pa - pb;
                        const dateA = a.createdAt?.toDate?.() || new Date(a.createdAt || 0);
                        const dateB = b.createdAt?.toDate?.() || new Date(b.createdAt || 0);
                        return dateB - dateA; // plus r√©centes en premier dans un m√™me statut
                    });

                    list.innerHTML = allOrders.map(order => renderSellerOrderCard(order, vendorProductIds)).join('');
                    
                    // Ajouter les event listeners pour les changements de statut
                    list.querySelectorAll('.btn-update-order').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const orderId = e.target.dataset.orderId;
                            const row = document.querySelector(`[data-order-id="${orderId}"]`);
                            const select = row ? row.querySelector('.status-select') : null;
                            const newStatus = select ? select.value : 'pending';

                            btn.disabled = true;
                            btn.textContent = '‚è≥ Mise √† jour...';

                            try {
                                await db.collection('orders').doc(orderId).update({
                                    status: newStatus,
                                    updatedAt: new Date()
                                });

                                showToast(`‚úÖ Commande mise √† jour en ${getStatusLabel(newStatus)}`, 'success');
                                // Recharger la liste pour appliquer l'ordre par statut
                                loadSellerOrders();
                                // Recalculer les ventes si livr√©e/annul√©e
                                updateSellerSales();
                            } catch (error) {
                                console.error('Erreur mise √† jour:', error);
                                showToast('‚ùå Erreur lors de la mise √† jour', 'error');
                            } finally {
                                btn.disabled = false;
                                btn.textContent = 'Mettre √† jour';
                            }
                        });
                    });

                    loader.style.display = 'none';
                    container.style.display = 'block';
                });
            }).catch(err => {
                console.error('Erreur chargement commandes:', err);
                list.innerHTML = '<p class="text-muted" style="color:red; text-align:center; padding:40px;">Erreur lors du chargement des commandes.</p>';
                loader.style.display = 'none';
                container.style.display = 'block';
            });
        }

        // RENDRE UNE CARTE DE COMMANDE
        function renderSellerOrderCard(order, vendorProductIds) {
            const date = order.createdAt?.toDate?.() || new Date(order.createdAt || 0);
            const dateStr = date.toLocaleDateString('fr-FR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const total = order.total || 0;
            const status = order.status || 'pending';

            // Filtrer les articles qui appartiennent au vendeur
            const vendorItems = order.items?.filter(item => vendorProductIds.includes(item.id)) || [];

            return `
                <div class="order-card-seller" data-order-id="${order.id}">
                    <div class="order-card-seller-header">
                        <div>
                            <div class="order-card-seller-id">Commande #${order.id.substring(0, 8).toUpperCase()}</div>
                            <div class="order-card-seller-date">${dateStr}</div>
                        </div>
                        <span class="order-status-badge ${status}">${getStatusLabel(status)}</span>
                    </div>

                    <div class="order-items-seller">
                        <strong style="display:block; margin-bottom:10px; font-size:14px;">Articles de cette boutique:</strong>
                        ${vendorItems.map(item => `
                            <div class="order-item-seller">
                                <span class="order-item-name-seller">${item.name}</span>
                                <span class="order-item-qty-seller">x${item.qty}</span>
                                <span class="order-item-price-seller">${new Intl.NumberFormat('fr-FR').format(item.price * item.qty)} FCFA</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="order-footer-seller">
                        <div class="order-total-seller">
                            Total commande: <strong>${new Intl.NumberFormat('fr-FR').format(total)} FCFA</strong>
                        </div>
                        <div class="order-actions-seller">
                            <select class="status-select" data-order-id="${order.id}">
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>‚è≥ En attente</option>
                                <option value="shipped" ${status === 'shipped' ? 'selected' : ''}>üì¶ Exp√©di√©e</option>
                                <option value="delivered" ${status === 'delivered' ? 'selected' : ''}>‚úÖ Livr√©e</option>
                                <option value="cancelled" ${status === 'cancelled' ? 'selected' : ''}>‚ùå Annul√©e</option>
                            </select>
                            <button class="btn-update-order" data-order-id="${order.id}">Mettre √† jour</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // LABELS DE STATUT
        function getStatusLabel(status) {
            const labels = {
                'pending': '‚è≥ En attente',
                'shipped': 'üì¶ Exp√©di√©e',
                'delivered': '‚úÖ Livr√©e',
                'cancelled': '‚ùå Annul√©e'
            };
            return labels[status] || status;
        }

        // TOAST NOTIFICATION
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'success' ? '#d1e7dd' : type === 'error' ? '#f8d7da' : '#cfe2ff'};
                color: ${type === 'success' ? '#0f5132' : type === 'error' ? '#842029' : '#084298'};
                padding: 16px 20px;
                border-radius: 8px;
                margin-bottom: 10px;
                border-left: 4px solid ${type === 'success' ? '#0f5132' : type === 'error' ? '#842029' : '#084298'};
                animation: slideIn 0.3s ease-out;
            `;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // SOUMISSION PRODUIT
        document.getElementById('form-add-product').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit-product');

            const productData = collectProductData(myShop);
            if (!productData) return;

            btn.innerText = "Publication...";
            btn.disabled = true;

            db.collection('products').add(productData).then(() => {
                showToast('‚úÖ Produit mis en vente avec succ√®s !', 'success');
                e.target.reset();
                productImages = [];
                productVariants = [];
                renderProductGallery();
                document.getElementById('dynamic-fields').innerHTML = '';
                btn.innerText = '‚úì Mettre en vente';
                btn.disabled = false;
                setTimeout(() => {
                    nav('products', document.querySelectorAll('.admin-nav-item')[1]);
                }, 1000);
            }).catch(err => {
                console.error('Erreur sauvegarde produit:', err);
                showToast('‚ùå Erreur: ' + err.message, 'error');
                btn.disabled = false;
                btn.innerText = 'Mettre en vente';
            });
        });

        // SOUMISSION PARAM√àTRES
        document.getElementById('form-settings').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            btn.innerText = "Enregistrement...";
            btn.disabled = true;

            const updateData = {
                name: document.getElementById('set-name').value,
                description: document.getElementById('set-desc').value,
                slogan: document.getElementById('set-slogan').value,
                phone: document.getElementById('set-phone').value
            };

            if(logoBase64) updateData.logo = logoBase64;
            if(bannerBase64) updateData.banner = bannerBase64;

            db.collection('shops').doc(myShop.id).update(updateData)
            .then(() => {
                alert("‚úÖ Boutique mise √† jour !");
                btn.innerText = "Enregistrer les modifications";
                btn.disabled = false;
                myShop = { ...myShop, ...updateData };
                document.getElementById('shop-title-display').innerText = myShop.name;
            })
            .catch(err => {
                alert("Erreur: " + err.message);
                btn.disabled = false;
            });
        });

        // SUPPRESSION PRODUIT
        window.delProduct = (id) => {
            if(confirm("Supprimer ce produit ?")) {
                db.collection('products').doc(id).delete();
            }
        };

        // NAVIGATION
        window.nav = (id, btn) => {
            document.querySelectorAll('.admin-section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active-section'));
            
            document.getElementById('sec-'+id).classList.remove('hidden');
            document.getElementById('sec-'+id).classList.add('active-section');

            document.querySelectorAll('.admin-nav-item').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // Charger les commandes si on clique sur l'onglet "Commandes"
            if (id === 'orders') {
                loadSellerOrders();
                updateSellerRetentionUI();
                purgeOldCompletedOrders(getRetentionDays());
            }
            // Recalculer ventes quand on ouvre le dashboard
            if (id === 'dashboard') {
                updateSellerSales();
                purgeOldCompletedOrders(getRetentionDays());
            }

            if(window.innerWidth < 900) document.getElementById('seller-sidebar').classList.remove('mobile-open');
        };

        // D√âCONNEXION
        window.logout = () => {
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(err => {
                console.error('Erreur d√©connexion:', err);
                alert('Erreur lors de la d√©connexion');
            });
        };
    </script>
</body>
</html>
